# Анализ расчета баллов лояльности

## Данные из NocoDB

### Транзакции (Loyalty_Points_Transactions):
1. **Id 1437** (Order 1006):
   - User ID: 169
   - Order ID: 1006
   - Type: earned
   - Points: **97**
   - Description: "Начислено 97 баллов за заказ на сумму 2189 руб." ⚠️ (неверно в описании, должно быть 3266)
   - Status: completed

2. **Id 1438** (Order 1007):
   - User ID: 169
   - Order ID: 1007
   - Type: used
   - Points: **-21**
   - Description: "Использовано 21 баллов для оплаты заказа"
   - Status: completed

3. **Id 1439** (Order 1007):
   - User ID: 169
   - Order ID: 1007
   - Type: earned
   - Points: **111**
   - Description: "Начислено 111 баллов за заказ на сумму 3719 руб."
   - Status: completed

### Заказы:
- **Order 1006**: 
  - Subtotal: 3266
  - Delivery Fee: 0
  - Promo Discount: 1077
  - Total (после промокода): 2189
  - Loyalty Points Earned: 97
  - Loyalty Points Used: 0

- **Order 1007**: 
  - Subtotal: 3719
  - Delivery Fee: 0
  - Promo Discount: 0
  - Total: 3719
  - Loyalty Points Earned: 111
  - Loyalty Points Used: 0

### Пользователь 169:
- Loyalty Points: **187**
- Total Spent: **5908**

## Проверка расчетов

### Баланс пользователя:
97 (earned за 1006) - 21 (used за 1007) + 111 (earned за 1007) = **187** ✓

### Total Spent:
2189 (заказ 1006) + 3719 (заказ 1007) = **5908** ✓

### Расчет баллов для заказа 1006:
- **Subtotal + Delivery Fee (БЕЗ промокода)**: 3266 + 0 = **3266 руб.**
- **Процент кешбека**: 3% (totalSpent = 0, уровень Bronze)
- **Расчет**: 3266 * 3 / 100 = **97.98** → округление = **97 баллов** ✓
- **Факт**: 97 баллов ✓
- **Вывод**: Расчет **ПРАВИЛЬНЫЙ** - баллы начислены на Subtotal+Delivery БЕЗ учета промокода

### Расчет баллов для заказа 1007:
- **Subtotal + Delivery Fee (БЕЗ промокода)**: 3719 + 0 = **3719 руб.**
- **Процент кешбека**: 3% (totalSpent = 2189, уровень Bronze)
- **Расчет**: 3719 * 3 / 100 = **111.57** → округление = **111 баллов** ✓
- **Факт**: 111 баллов ✓
- **Вывод**: Расчет **ПРАВИЛЬНЫЙ** - баллы начислены на Subtotal+Delivery БЕЗ учета промокода

## Выводы

✅ **Все расчеты корректны:**
1. Баллы начисляются на Subtotal + Delivery Fee БЕЗ учета промокода (правильно)
2. Процент кешбека рассчитывается на основе totalSpent пользователя (правильно)
3. Баланс пользователя рассчитан правильно: 97 - 21 + 111 = 187
4. Total Spent обновлен правильно: 2189 + 3719 = 5908

⚠️ **Небольшая неточность:**
- В описании транзакции для заказа 1006 указана сумма 2189 (Total после промокода), но баллы начислены на 3266 (Subtotal+Delivery). Это не влияет на расчет, но может вводить в заблуждение.
