# üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –≤ Partial Update
**–î–∞—Ç–∞:** 2026-01-11  
**–¢–∏–ø:** Critical Bugfix  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üìã –ü–†–û–ë–õ–ï–ú–ê

### –°–∏–º–ø—Ç–æ–º—ã:
–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ —Å `cash` –Ω–∞ `card` (partial update):
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ: +86
- ‚ùå –ù–æ –±–∞–ª–ª—ã, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ –∑–∞–∫–∞–∑–µ, **—Å–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –í–¢–û–†–û–ô –†–ê–ó**: -42
- ‚ùå Total Spent **—É–º–µ–Ω—å—à–∞–ª—Å—è** –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã: -42‚ÇΩ

### –ü—Ä–∏–º–µ—Ä (–ó–∞–∫–∞–∑ #517, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #104):

**–û–∂–∏–¥–∞–ª–æ—Å—å:**
```
–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: 53 –±–∞–ª–ª–æ–≤ (–ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è 42 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π: +86 –±–∞–ª–ª–æ–≤
–ò—Ç–æ–≥–æ: 53 + 86 = 139 –±–∞–ª–ª–æ–≤ ‚úÖ

Total Spent: 3187‚ÇΩ + 2930‚ÇΩ = 6117‚ÇΩ ‚úÖ
```

**–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:**
```
–ë–∞–ª–∞–Ω—Å: 97 –±–∞–ª–ª–æ–≤ ‚ùå (53 + 86 - 42 = 97)
Total Spent: 6075‚ÇΩ ‚ùå (3187 + 2930 - 42 = 6075)

–†–∞–∑–Ω–∏—Ü–∞: -42 –±–∞–ª–ª–∞ –ò -42‚ÇΩ ‚ùå
```

---

## üîç –ü–†–ò–ß–ò–ù–ê

### –ö–æ–¥ –≤ `app/api/orders/[id]/route.ts` (—Å—Ç—Ä–æ–∫–∞ ~929):

```typescript
// PARTIAL UPDATE: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
if (!wasPaid && willBePaid && currentOrder.user_id) {
  const pointsUsed = currentOrder.loyalty_points_used || 0  // = 42
  const loyaltyPointsEarned = calculateEarnedPoints(orderTotal, pointsUsed, ...)  // = 86
  
  if (loyaltyPointsEarned > 0) {
    // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ü–µ—Ä–µ–¥–∞–µ–º pointsUsed=42
    await awardLoyaltyPoints(
      currentOrder.user_id, 
      orderTotal,           // 2930
      pointsUsed,          // 42 ‚ùå –ë–∞–ª–ª—ã —É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã!
      loyaltyPointsEarned, // 86
      Number(id)
    )
  }
}
```

### –í–Ω—É—Ç—Ä–∏ `awardLoyaltyPoints` (lib/nocodb.ts, —Å—Ç—Ä–æ–∫–∏ 1163-1176, 1195, 1201):

```typescript
export async function awardLoyaltyPoints(
  userId: number,
  orderTotal: number,
  pointsUsed: number = 0,  // ‚Üê –ü–æ–ª—É—á–∞–µ—Ç 42
  pointsEarned?: number,
  orderId?: number
) {
  // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –±–∞–ª–ª—ã, —Å–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ
  if (pointsUsed > 0) {  // 42 > 0 = TRUE
    await createLoyaltyPointsTransaction({
      transaction_type: "used",
      points: -pointsUsed,  // -42 ‚ùå –í–¢–û–†–û–ï –°–ü–ò–°–ê–ù–ò–ï!
    })
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º total_spent
  const newTotalSpent = currentTotalSpent + orderTotal - pointsUsed
  //                  = 3187 + 2930 - 42 = 6075 ‚ùå
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
  const newBalance = currentBalance + earnedPoints - pointsUsed
  //               = 53 + 86 - 42 = 97 ‚ùå
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –î–í–ê–ñ–î–´:
1. **–ü–µ—Ä–≤—ã–π —Ä–∞–∑:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ `cash` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤
2. **–í—Ç–æ—Ä–æ–π —Ä–∞–∑:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞ `card` –≤ `awardLoyaltyPoints`

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `pointsUsed=0` –≤ `awardLoyaltyPoints` –¥–ª—è partial update

**–ü–æ—á–µ–º—É?** –ü–æ—Ç–æ–º—É —á—Ç–æ –≤ partial update –±–∞–ª–ª—ã **—É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Ä–∞–Ω–µ–µ** (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –≤ –¥—Ä—É–≥–æ–º PATCH –∑–∞–ø—Ä–æ—Å–µ). –ù–∞–º –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ **–Ω–∞—á–∏—Å–ª–∏—Ç—å** –Ω–æ–≤—ã–µ –±–∞–ª–ª—ã, –∞ –Ω–µ —Å–ø–∏—Å—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `app/api/orders/[id]/route.ts` (—Å—Ç—Ä–æ–∫–∞ ~920-932):

**–î–û:**
```typescript
if (loyaltyPointsEarned > 0) {
  console.log(`üîç [PATCH partial ${id}] 7Ô∏è‚É£ –í—ã–∑–æ–≤ awardLoyaltyPoints —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:`, {
    userId: currentOrder.user_id,
    orderTotal,
    pointsUsed,  // ‚ùå 42
    loyaltyPointsEarned,
    orderId: id,
  })
  await awardLoyaltyPoints(
    currentOrder.user_id, 
    orderTotal, 
    pointsUsed,  // ‚ùå –°–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ
    loyaltyPointsEarned, 
    Number(id)
  )
}
```

**–ü–û–°–õ–ï:**
```typescript
if (loyaltyPointsEarned > 0) {
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û 2026-01-11: –ü—Ä–∏ partial update (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã)
  // –±–∞–ª–ª—ã —É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Ä–∞–Ω–µ–µ, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ–¥–∞–µ–º pointsUsed=0
  // —á—Ç–æ–±—ã –Ω–µ —Å–ø–∏—Å—ã–≤–∞—Ç—å –∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ awardLoyaltyPoints
  console.log(`üîç [PATCH partial ${id}] 7Ô∏è‚É£ –í—ã–∑–æ–≤ awardLoyaltyPoints —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:`, {
    userId: currentOrder.user_id,
    orderTotal,
    pointsUsed: 0,  // ‚úÖ 0 –≤–º–µ—Å—Ç–æ pointsUsed
    loyaltyPointsEarned,
    orderId: id,
    note: 'pointsUsed=0 –ø–æ—Ç–æ–º—É —á—Ç–æ –±–∞–ª–ª—ã —É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞'
  })
  await awardLoyaltyPoints(
    currentOrder.user_id, 
    orderTotal, 
    0,  // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º 0
    loyaltyPointsEarned, 
    Number(id)
  )
}
```

---

## üéØ –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

### –¢–µ–ø–µ—Ä—å –ø—Ä–∏ partial update:

```typescript
await awardLoyaltyPoints(
  userId: 104,
  orderTotal: 2930,
  pointsUsed: 0,        // ‚úÖ –ù–ï —Å–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ
  pointsEarned: 86,
  orderId: 517
)
```

### –í–Ω—É—Ç—Ä–∏ `awardLoyaltyPoints`:

```typescript
// –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤
if (pointsUsed > 0) {  // 0 > 0 = FALSE
  // ‚úÖ –ù–ï —Å–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é "used"
}

// –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
if (earnedPoints > 0) {  // 86 > 0 = TRUE
  await createLoyaltyPointsTransaction({
    transaction_type: "earned",
    points: 86,  // ‚úÖ –¢–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
  })
}

// Total Spent
const newTotalSpent = currentTotalSpent + orderTotal - pointsUsed
//                  = 3187 + 2930 - 0 = 6117 ‚úÖ

// –ë–∞–ª–∞–Ω—Å
const newBalance = currentBalance + earnedPoints - pointsUsed
//               = 53 + 86 - 0 = 139 ‚úÖ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–∞–ª–ª—ã: 53 + 86 = **139** (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
- ‚úÖ Total Spent: 3187 + 2930 = **6117‚ÇΩ** (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ó–∞–∫–∞–∑ —Å –±–∞–ª–ª–∞–º–∏, —Å–º–µ–Ω–∞ cash ‚Üí card

1. **–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤:**
   - Total: 2930‚ÇΩ
   - –ò—Å–ø–æ–ª—å–∑—É–µ–º: 42 –±–∞–ª–ª–∞
   - –ë–∞–ª–∞–Ω—Å: 95 - 42 = 53 ‚úÖ

2. **–ò–∑–º–µ–Ω–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç—É:**
   - –ù–∞—á–∏—Å–ª–∏—Ç—Å—è: 86 –±–∞–ª–ª–æ–≤ (3% –æ—Ç 2930‚ÇΩ)
   - Total Spent: +2930‚ÇΩ
   - **–û–∂–∏–¥–∞–µ—Ç—Å—è:**
     * –ë–∞–ª–ª—ã: 53 + 86 = 139 ‚úÖ
     * Total Spent: 3187 + 2930 = 6117‚ÇΩ ‚úÖ

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ NocoDB:**
   ```sql
   SELECT loyalty_points, total_spent FROM Users WHERE Id = 104
   -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: 139, 6117
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**
   ```sql
   SELECT * FROM Loyalty_Points_Transactions 
   WHERE user_id = 104 AND order_id = 517
   -- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   -- 1x "used" —Å points = -42 (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞)
   -- 1x "earned" —Å points = 86 (–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π)
   -- –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤—Ç–æ—Ä–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ "used"!
   ```

---

## üìä –î–û vs –ü–û–°–õ–ï

### –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–ó–∞–∫–∞–∑ #517 (cash ‚Üí card):
  –ë–∞–ª–ª—ã: 53 + 86 - 42 = 97 ‚ùå
  Total Spent: 3187 + 2930 - 42 = 6075‚ÇΩ ‚ùå
  
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
  #585: used, -42 (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
  #XXX: used, -42 (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ) ‚ùå
  #YYY: earned, +86
```

### –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
–ó–∞–∫–∞–∑ #517 (cash ‚Üí card):
  –ë–∞–ª–ª—ã: 53 + 86 = 139 ‚úÖ
  Total Spent: 3187 + 2930 = 6117‚ÇΩ ‚úÖ
  
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
  #585: used, -42 (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏)
  #YYY: earned, +86 ‚úÖ
```

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–º–µ—Å—Ç–µ —Å:
1. **FIX_LOYALTY_POINTS_DEDUCTION_CASH_2026_01_11.md** - –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –¥–ª—è cash –∑–∞–∫–∞–∑–æ–≤
2. **FIX_DOUBLE_DEDUCTION_PROTECTION_2026_01_11.md** - –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è

---

## ‚úÖ –ì–û–¢–û–í–û

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ partial update (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã):
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ë–∞–ª–ª—ã –ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
- ‚úÖ Total Spent —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ù–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π "used"

---

## üéì –£–†–û–ö

**–í–∞–∂–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø:** –í partial update (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã) –ù–ï –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞.

**Full update** vs **Partial update:**
- **Full update:** –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤–µ—Å—å –∑–∞–∫–∞–∑, –≤–∫–ª—é—á–∞—è —Å–æ—Å—Ç–∞–≤. –ú–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
- **Partial update:** –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–∞–ª–ª—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Ä–∞–Ω–µ–µ, –ø–µ—Ä–µ–¥–∞–µ–º `pointsUsed=0`.


