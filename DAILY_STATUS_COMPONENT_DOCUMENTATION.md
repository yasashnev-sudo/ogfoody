# Документация компонента DailyStatus

## Общая информация

**Файл:** `components/daily-status.tsx`  
**Тип:** React компонент (Client Component)  
**Назначение:** Отображает статус доставки и наличия еды на текущий день с умной логикой пополнения для авторизованных пользователей

**Последнее обновление:** Реализована логика пополнения (Replenishment Logic) для авторизованных пользователей

---

## Структура компонента

### Props (входные параметры)

```typescript
interface DailyStatusProps {
  orders: Order[]                    // Массив заказов пользователя
  availableDates?: Date[]            // Массив доступных дат для доставки
  onOrderClick?: (date: Date) => void // Callback при клике на кнопку заказа (принимает дату)
  onFoodCardClick?: () => void       // Callback при клике на карточку с едой
  isAuthenticated?: boolean          // Флаг авторизации пользователя (по умолчанию false)
}
```

---

## Золотое правило логистики

**Food delivered on Day X covers meals for Day X+1 and Day X+2**

Еда, доставленная в день X, покрывает питание на дни X+1 и X+2.

**Следствие:** Если еда пользователя заканчивается в день Y, доставка должна быть запланирована на день Y (вечером), чтобы обеспечить непрерывное питание на день Y+1.

---

## Состояния компонента

Компонент отображает одно из состояний в зависимости от статуса пользователя и наличия еды:

### 1. Статус: "Доставка сегодня" (Delivery Day)

**Условие отображения:**  
Сегодняшняя дата совпадает с датой начала заказа (`order.startDate`)

**Приоритет:** Высший (отображается первым, если условие выполнено)

**Визуальное оформление:**
- Фон: `#FFEA00` (желтый)
- Рамка: `border-2 border-black` (черная, сплошная)
- Тень: `shadow-brutal`
- Скругление: `rounded-xl`
- Отступы: `p-4 sm:p-5`

**Элементы:**
- **Иконка:** `Truck` (грузовик) из библиотеки `lucide-react`
  - Размер: `w-10 h-10 sm:w-12 sm:h-12`
  - Фон: белый с черной рамкой
  - Скругление: `rounded-lg`
  
- **Заголовок:** 
  - Текст: `"ЖДИ КУРЬЕРА СЕГОДНЯ"`
  - Стиль: `text-base sm:text-lg font-black text-black mb-1`
  
- **Подзаголовок:**
  - Текст: `"Интервал: 19:00 - 23:00"`
  - Стиль: `text-xs sm:text-sm text-black/80 font-bold`

**Функциональность:**  
Статичный блок, без интерактивности

---

### 2. Статус: "Еда есть сегодня" (Food Available)

**Условие отображения:**  
Сегодняшняя дата является днем 1 или днем 2 после даты доставки:
- День 1: `deliveryDate + 1 день`
- День 2: `deliveryDate + 2 дня`

**Приоритет:** Средний (отображается если нет доставки сегодня, но есть еда)

**Визуальное оформление:**
- Фон: белый (`bg-white`)
- Рамка: `border-2 border-black` (черная, сплошная)
- Тень: `shadow-[4px_4px_0px_0px_#000000]` (brutalist стиль)
- Скругление: `rounded-xl`
- Отступы: `p-4 sm:p-5`
- Курсор: `cursor-pointer`
- Hover эффект: `hover:shadow-[3px_3px_0px_0px_#000000]`
- Переход: `transition-shadow`

**Элементы:**
- **Иконка:** `UtensilsCrossed` (скрещенные столовые приборы) из библиотеки `lucide-react`
  - Размер: `w-6 h-6 sm:w-8 sm:h-8`
  - Цвет: `#9D00FF` (фиолетовый)
  - Толщина обводки: `stroke-[2.5px]`
  
- **Заголовок:**
  - Текст: `"СЕГОДНЯ У ВАС ЕСТЬ ЕДА"`
  - Стиль: `text-base sm:text-lg font-black text-black uppercase mb-1`
  
- **Подзаголовок:**
  - Текст: `"Загляните в холодильник"`
  - Стиль: `text-xs sm:text-sm text-gray-600 font-medium`

**Функциональность:**  
- Кликабельный блок
- При клике вызывается `onFoodCardClick()` (если передан)
- Используется для навигации к разделу с едой

---

### 3. Статус: "Пустой день" (Empty Day)

**Условие отображения:**  
Сегодня не день доставки и не день 1-2 после доставки (нет еды)

**Приоритет:** Низший (отображается если нет доставки и нет еды)

**Логика различается для авторизованных и гостевых пользователей:**

---

#### 3.1. Для авторизованных пользователей (`isAuthenticated === true`)

##### 3.1.1. Состояние: "Food Streak Active" (Есть еда, но она закончится)

**Условие:** Пользователь имеет активную цепочку дней с едой, которая закончится в будущем

**Визуальное оформление:**
- Фон: белый (`bg-white`)
- Рамка: `border-2 border-black` (черная, сплошная)
- Тень: `shadow-[4px_4px_0px_0px_#000000]`
- Скругление: `rounded-xl`
- Отступы: `p-4 sm:p-5`
- Layout: `flex flex-col sm:flex-row`
- Выравнивание: `sm:items-center sm:justify-between`

**Элементы:**
- **Иконка:** `CalendarCheck` (календарь с галочкой) из библиотеки `lucide-react`
  - Размер: `w-10 h-10 sm:w-12 sm:h-12`
  - Цвет: `#9D00FF` (фиолетовый)
  - Фон: белый с черной рамкой
  - Скругление: `rounded-lg`

- **Заголовок:**
  - Текст: `"ВАШ ЗАПАС ЕДЫ ЗАКАНЧИВАЕТСЯ {14 ЯНВАРЯ (СР)}."`
  - Формат даты: `formatDateWithDayOfWeek(lastEatingDay)`
  - Стиль: `text-sm sm:text-base md:text-lg font-black text-black leading-tight mb-1`

- **Подзаголовок:**
  - Текст: `"Оформите доставку на этот день, чтобы обеспечить питание на следующие 2 дня."`
  - Стиль: `text-xs sm:text-sm text-gray-600 font-medium mt-1`

- **Кнопка:**
  - Текст: `"СДЕЛАТЬ ЗАКАЗ"`
  - Стиль: `bg-[#FFEA00] text-black hover:bg-[#FFEA00]/90 border-2 border-black shadow-brutal font-black`
  - Размер: `text-xs sm:text-sm px-3 sm:px-4 py-2`
  - Ширина: `w-full sm:w-auto` (полная на мобильных, авто на десктопе)
  - Действие: Вызывает `onOrderClick(targetDate)` где `targetDate` - рассчитанная дата доставки

**Логика расчета даты:**
- `targetDate` = `lastEatingDay` (дата последнего дня с едой)
- Если `targetDate` недоступна в `availableDates`, выбирается ближайшая доступная дата после `targetDate`
- Если нет доступных дат после `targetDate`, выбирается ближайшая доступная дата от сегодня

---

##### 3.1.2. Состояние: "No Food / Empty" (Нет еды)

**Условие:** Пользователь не имеет еды или есть разрыв в цепочке питания

**Визуальное оформление:**
- Фон: `bg-gray-100` (светло-серый)
- Рамка: `border-2 border-dashed border-black` (черная, пунктирная)
- Тень: `shadow-brutal`
- Скругление: `rounded-xl`
- Отступы: `p-4 sm:p-5`
- Layout: `flex flex-col sm:flex-row`
- Выравнивание: `sm:items-center sm:justify-between`

**Элементы:**
- **Иконка:** `CalendarClock` (календарь с часами) из библиотеки `lucide-react`
  - Размер: `w-10 h-10 sm:w-12 sm:h-12`
  - Цвет: черный
  - Фон: белый с черной рамкой
  - Скругление: `rounded-lg`

- **Заголовок:**
  - Текст: `"ВАШ ХОЛОДИЛЬНИК ПУСТ."`
  - Стиль: `text-sm sm:text-base md:text-lg font-black text-black leading-tight mb-1`

- **Подзаголовок:**
  - Текст: `"Ближайшая доставка: {14 ЯНВАРЯ (СР)}"`
  - Формат даты: `formatDateWithDayOfWeek(nearestDate)`
  - Стиль: `text-xs sm:text-sm text-gray-600 font-medium`
  - Условие: Отображается только если `nearestDate` существует

- **Кнопка:**
  - Текст: `"ЗАКАЗАТЬ НА {14 ЯНВ (СР)}"`
  - Формат даты: `formatShortDateWithDayOfWeek(nearestDate)`
  - Стиль: `bg-black text-white hover:bg-black/90 border-2 border-black shadow-brutal font-black`
  - Размер: `text-xs sm:text-sm px-3 sm:px-4 py-2`
  - Ширина: `w-full sm:w-auto`
  - Действие: Вызывает `onOrderClick(nearestDate)`

**Логика расчета даты:**
- `nearestDate` = ближайшая доступная дата из `availableDates` (>= сегодня)
- Используется функция `findNextAvailableDate(availableDates, orders)`

---

#### 3.2. Для гостевых пользователей (`isAuthenticated === false`)

**Обратная совместимость:** Сохранена оригинальная логика для гостей

##### 3.2.1. Состояние: "Еда закончится" (Has orders, food will end)

**Условие:** Есть заказы, и еда закончится в будущем

**Визуальное оформление:**
- Фон: `bg-gray-100`
- Рамка: `border-2 border-dashed border-black`
- Тень: `shadow-brutal`

**Элементы:**
- **Заголовок:**
  - Текст: `"{14 ЯНВАРЯ} У ВАС ЗАКОНЧИТСЯ ЕДА!"`
  - Формат: `formatDateGenitive(lastFoodDate).toUpperCase()`

- **Кнопка:**
  - Текст: `"ЗАКАЗАТЬ!"`
  - Стиль: `bg-black text-white`

##### 3.2.2. Состояние: "Нет заказов" (No orders)

**Условие:** Нет заказов вообще

**Элементы:**
- **Заголовок:**
  - Текст: `"У ВАС ПОКА ЧТО НЕТ ЕДЫ!"`

- **Кнопка:**
  - Текст: `"ЗАКАЗАТЬ НА БЛИЖАЙШУЮ ДАТУ!"`

---

## Алгоритм пополнения (Replenishment Logic)

### Функция `calculateReplenishmentDate`

**Назначение:** Рассчитывает оптимальную дату доставки для непрерывного питания

**Входные параметры:**
- `orders: Order[]` - массив заказов пользователя
- `availableDates?: Date[]` - массив доступных дат для доставки

**Выходные данные:**
```typescript
{
  targetDate: Date | null,      // Целевая дата доставки
  lastEatingDay: Date | null,   // Последний день с едой (или null если нет еды)
  hasGap: boolean               // Есть ли разрыв в цепочке питания
}
```

**Алгоритм:**

1. **Шаг 1: Анализ активных заказов**
   - Для каждого заказа с `startDate = Day X`:
     - `Eating Day 1` = `Day X + 1`
     - `Eating Day 2` = `Day X + 2`
   - Собираем все "Eating Days" >= сегодня в Set

2. **Шаг 2: Проверка наличия еды**
   - Если `eatingDays.size === 0` → **Scenario B** (нет еды)
     - Возвращаем: `{ targetDate: nearestAvailableDate, lastEatingDay: null, hasGap: true }`

3. **Шаг 3: Поиск непрерывной цепочки**
   - Сортируем все Eating Days по возрастанию
   - Проверяем, есть ли сегодня в цепочке
   - Если нет → **Scenario B** (разрыв, нет еды сегодня)
   - Если да → ищем последний непрерывный день (`lastEatingDay`)

4. **Шаг 4: Определение целевой даты доставки**
   - **Scenario A** (есть еда): `targetDate = lastEatingDay`
   - Валидация: проверяем, доступна ли `targetDate` в `availableDates`
   - Если недоступна → находим ближайшую доступную дату >= `targetDate`
   - Если нет доступных дат после `targetDate` → используем ближайшую от сегодня

**Примеры:**

**Пример 1: Непрерывная цепочка**
```
Заказы:
- Order 1: startDate = 2026-01-10 (пятница)
  → Eating Days: 2026-01-11 (суббота), 2026-01-12 (воскресенье)

- Order 2: startDate = 2026-01-13 (понедельник)
  → Eating Days: 2026-01-14 (вторник), 2026-01-15 (среда)

Сегодня: 2026-01-11 (суббота)
Eating Days: [2026-01-11, 2026-01-12, 2026-01-14, 2026-01-15]
Last Eating Day: 2026-01-12 (воскресенье) - разрыв между 12 и 14!
Target Date: 2026-01-12 (доставка должна быть в воскресенье вечером)
```

**Пример 2: Разрыв в цепочке**
```
Заказы:
- Order 1: startDate = 2026-01-10
  → Eating Days: 2026-01-11, 2026-01-12

Сегодня: 2026-01-15 (среда)
Eating Days: [] (все в прошлом)
Last Eating Day: null
Target Date: ближайшая доступная дата от сегодня
```

---

## Логика определения статуса

### Приоритет отображения:

1. **Доставка сегодня** (`hasDeliveryToday === true`)
   - Показываем статус "ЖДИ КУРЬЕРА СЕГОДНЯ"

2. **Еда есть сегодня** (`hasFoodToday === true`)
   - Показываем статус "СЕГОДНЯ У ВАС ЕСТЬ ЕДА"

3. **Пустой день** (нет доставки и нет еды)
   - Если `isAuthenticated === true`:
     - Используем `calculateReplenishmentDate()` для расчета
     - Если `lastEatingDay && !hasGap` → "Food Streak Active"
     - Иначе → "No Food / Empty"
   - Если `isAuthenticated === false`:
     - Используем оригинальную логику для гостей

---

## Вспомогательные функции

### Форматирование дат

#### `formatDateWithDayOfWeek(date: Date): string`
Формат: `"14 ЯНВАРЯ (СР)"`
- Полное название месяца в верхнем регистре
- День недели в скобках (сокращение)

#### `formatShortDateWithDayOfWeek(date: Date): string`
Формат: `"14 ЯНВ (СР)"`
- Сокращенное название месяца
- День недели в скобках

#### `formatDateGenitive(date: Date): string`
Формат: `"14 января"`
- Полное название месяца в родительном падеже
- Используется для гостевых пользователей

### Работа с датами

#### `hasOrderForDate(orders: Order[], date: Date): boolean`
Проверяет, есть ли заказ на указанную дату

#### `findNextAvailableDate(availableDates?: Date[], orders: Order[] = []): Date | null`
Находит следующую доступную дату для заказа:
- Предпочитает воскресенье, если сегодня пусто
- Пропускает даты, на которые уже есть заказы
- Возвращает ближайшую доступную дату >= сегодня

---

## Использование компонента

### Пример использования из `app/page.tsx`:

```tsx
<DailyStatus
  orders={orders}
  availableDates={availableDates}
  isAuthenticated={isAuthenticated}
  onOrderClick={(date: Date) => {
    // Компонент передает предрассчитанную дату
    handleDateClick(date)
  }}
  onFoodCardClick={() => {
    // Открыть модальное окно с сегодняшним заказом/меню
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    const todayOrder = orders.find((order) => {
      const orderDate = new Date(order.startDate)
      orderDate.setHours(0, 0, 0, 0)
      return orderDate.getTime() === today.getTime()
    })
    if (todayOrder) {
      setSelectedDate(today)
    }
  }}
/>
```

---

## Все тексты компонента

### Русские тексты для авторизованных пользователей:

1. **"ЖДИ КУРЬЕРА СЕГОДНЯ"** - заголовок статуса доставки
2. **"Интервал: 19:00 - 23:00"** - подзаголовок с временем доставки
3. **"СЕГОДНЯ У ВАС ЕСТЬ ЕДА"** - заголовок статуса наличия еды
4. **"Загляните в холодильник"** - подзаголовок при наличии еды
5. **"ВАШ ЗАПАС ЕДЫ ЗАКАНЧИВАЕТСЯ {дата}."** - заголовок при активной цепочке питания
6. **"Оформите доставку на этот день, чтобы обеспечить питание на следующие 2 дня."** - подзаголовок при активной цепочке
7. **"СДЕЛАТЬ ЗАКАЗ"** - текст кнопки при активной цепочке
8. **"ВАШ ХОЛОДИЛЬНИК ПУСТ."** - заголовок при отсутствии еды
9. **"Ближайшая доставка: {дата}"** - подзаголовок при отсутствии еды
10. **"ЗАКАЗАТЬ НА {дата}"** - текст кнопки при отсутствии еды

### Русские тексты для гостевых пользователей (обратная совместимость):

1. **"У ВАС ПОКА ЧТО НЕТ ЕДЫ!"** - заголовок при отсутствии заказов
2. **"ЗАКАЗАТЬ НА БЛИЖАЙШУЮ ДАТУ!"** - текст кнопки при отсутствии заказов
3. **"{дата} У ВАС ЗАКОНЧИТСЯ ЕДА!"** - заголовок при наличии заказов
4. **"ЗАКАЗАТЬ!"** - текст кнопки при наличии заказов

---

## Зависимости

### Импорты:

```typescript
import { Truck, UtensilsCrossed, CalendarClock, CalendarCheck } from "lucide-react"  // Иконки
import { Button } from "@/components/ui/button"                                        // UI компонент кнопки
import { Order } from "@/lib/types"                                                    // Тип данных заказа
import { addDays, startOfDay, isSameDay, isAfter } from "date-fns"                     // Работа с датами
```

### Типы данных:

Компонент использует тип `Order` из `@/lib/types`, который должен содержать:
- `startDate: string | Date` - дата начала заказа (дата доставки)

---

## Адаптивность

Компонент полностью адаптивен и использует Tailwind CSS breakpoints:

- **Мобильные устройства** (`< sm`, < 640px):
  - Вертикальная компоновка (`flex-col`)
  - Меньшие размеры иконок (`w-10 h-10`)
  - Меньшие размеры текста (`text-sm`)
  - Кнопка на всю ширину (`w-full`)

- **Планшеты** (`>= sm`, >= 640px):
  - Горизонтальная компоновка (`sm:flex-row`)
  - Увеличенные размеры иконок (`sm:w-12 sm:h-12`)
  - Увеличенные размеры текста (`sm:text-base`, `sm:text-lg`)
  - Кнопка с автоматической шириной (`sm:w-auto`)

- **Десктопы** (`>= md`, >= 768px):
  - Еще большие размеры текста (`md:text-lg`)

---

## Стилистика

Компонент использует **Neo-Brutalist дизайн**:
- Жирные черные рамки (`border-2 border-black`)
- Резкие тени (`shadow-brutal`, `shadow-[4px_4px_0px_0px_#000000]`)
- Контрастные цвета (желтый `#FFEA00`, фиолетовый `#9D00FF`, черный, белый)
- Жирные шрифты (`font-black`)
- Минималистичный подход
- Пунктирные рамки для пустых состояний (`border-dashed`)

---

## Технические детали

### Использование date-fns

Компонент использует библиотеку `date-fns` для точной работы с датами:
- `startOfDay()` - обнуление времени для точного сравнения
- `addDays()` - добавление дней к дате
- `isSameDay()` - сравнение дат без учета времени
- `isAfter()` - проверка, что дата позже другой

### Производительность

- Все даты нормализуются через `startOfDay()` для консистентности
- Используется `Set` для быстрого поиска Eating Days
- Сортировка дат выполняется один раз
- Валидация `availableDates` выполняется только при необходимости

---

## Примечания

1. Компонент является **Client Component** (`"use client"`), так как использует интерактивность и работу с датами
2. Все даты сравниваются с обнуленным временем для точности (`startOfDay()`)
3. Компонент проверяет все заказы в массиве `orders` для определения статуса
4. Кнопки отображаются только если передан соответствующий callback (`onOrderClick`, `onFoodCardClick`)
5. Для авторизованных пользователей используется умная логика пополнения, которая предотвращает разрывы в питании
6. Для гостевых пользователей сохранена оригинальная логика для обратной совместимости
7. Компонент автоматически адаптируется к наличию/отсутствию `availableDates`

---

## История изменений

### Версия 2.0 (Текущая)
- ✅ Добавлена логика пополнения (Replenishment Logic) для авторизованных пользователей
- ✅ Реализована функция `calculateReplenishmentDate()`
- ✅ Добавлены новые состояния UI для авторизованных пользователей
- ✅ Добавлены функции форматирования дат с днем недели
- ✅ Интеграция с `date-fns` для точной работы с датами
- ✅ Сохранена обратная совместимость для гостевых пользователей

### Версия 1.0 (Исходная)
- Базовые три состояния (доставка, еда есть, пусто)
- Простая логика определения статуса
- Поддержка гостевых пользователей
