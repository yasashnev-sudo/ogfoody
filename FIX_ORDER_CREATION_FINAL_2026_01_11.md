# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò: "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞"

**–î–∞—Ç–∞:** 2026-01-11 (02:00+)
**–°—Ç–∞—Ç—É—Å:** –ò–°–ü–†–ê–í–õ–ï–ù–û

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≥–æ—Å—Ç—è –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: {}
```

## üß™ –ê–Ω–∞–ª–∏–∑

### 1. –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API —Ç–µ—Å—Ç

–°–æ–∑–¥–∞–Ω headless —Ç–µ—Å—Ç `/tests/order-creation-api.spec.ts`, –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–ª –æ—à–∏–±–∫—É:

```
POST /api/orders
{
  order: {
    subtotal: 500,
    total: 600,
    persons: [...]
  }
}

‚Üí HTTP 400
{
  "error": "Order amount too low",
  "message": "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞: 1000‚ÇΩ",
  "details": "–í–∞—à–∞ —Å—É–º–º–∞: 0‚ÇΩ"
}
```

### 2. –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**API —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –∑–∞–Ω–æ–≤–æ** (`calculatedTotal`) –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–ª—é–¥ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –ù–ï –∏—Å–ø–æ–ª—å–∑—É—è `order.subtotal` –Ω–∞–ø—Ä—è–º—É—é.

–ï—Å–ª–∏ `order.persons` –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Ç–æ `calculatedTotal` = 0‚ÇΩ.

### 3. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—à–∏–±–∫–∏

1. **`persons` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º**
   - –ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≥–æ—Å—Ç—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–∏—â–µ–Ω–æ
   - `pendingCheckout.order.persons` –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –ø—É—Å—Ç—ã–º

2. **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω**
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `persons` –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º API

3. **–ë–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ë–î**
   - –ù–∞–∑–≤–∞–Ω–∏—è –±–ª—é–¥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ NocoDB

## üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ó–∞—â–∏—Ç–∞ –≤ `app/page.tsx` - `handleAutoCheckout` (—Å—Ç—Ä–æ–∫–∞ ~2333)

```typescript
// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ persons –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ API
console.log("üë• –ü—Ä–æ–≤–µ—Ä–∫–∞ persons:", {
  personsCount: updatedOrder.persons?.length || 0,
  personsEmpty: !updatedOrder.persons || updatedOrder.persons.length === 0,
  // ... –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª—é–¥–∞—Ö
})

if (!updatedOrder.persons || updatedOrder.persons.length === 0) {
  console.error("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: persons –ø—É—Å—Ç –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏!")
  setShowOrderLoading(false)
  setWarningDialog({
    open: true,
    title: "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞",
    description: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –æ –±–ª—é–¥–∞—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
    variant: "error",
  })
  setPendingCheckout(null)
  setShouldAutoCheckout(false)
  return
}
```

### 2. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `components/order-modal.tsx` (—Å—Ç—Ä–æ–∫–∞ ~414)

```typescript
console.log('üîç [OrderModal] –í—ã–∑—ã–≤–∞–µ–º onRequestAuth —Å order:', {
  subtotal: order.subtotal,
  total: order.total,
  personsCount: order.persons?.length,
  // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ persons
  persons: order.persons?.map(p => ({
    id: p.id,
    hasDay1: !!p.day1,
    hasDay2: !!p.day2,
    day1Meals: { /* ... */ },
    day2Meals: { /* ... */ }
  }))
})
```

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ API `app/api/orders/route.ts` (—Å—Ç—Ä–æ–∫–∞ ~210)

```typescript
if (!order.persons || order.persons.length === 0) {
  // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è persons
  console.error("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ó–∞–∫–∞–∑ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä—Å–æ–Ω!")
  return NextResponse.json(
    {
      error: "Invalid order data",
      message: "–ó–∞–∫–∞–∑ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±–ª—é–¥–∞—Ö",
      details: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –±–ª—é–¥–æ –≤ –∑–∞–∫–∞–∑"
    },
    { status: 400 }
  )
}
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

1. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è** `persons` –≤ `handleAutoCheckout`
2. ‚úÖ **–£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ `OrderModal` –∏ `handleAutoCheckout`
3. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞** –≤ API –¥–ª—è –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–µ
4. ‚úÖ **–°–æ–∑–¥–∞–Ω API —Ç–µ—Å—Ç** `/tests/order-creation-api.spec.ts` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –æ—à–∏–±–∫–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**Headless API —Ç–µ—Å—Ç —Å–æ–∑–¥–∞–Ω:** `/tests/order-creation-api.spec.ts`

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ `POST /api/orders`
- –í–∞–ª–∏–¥–∞—Ü–∏—é `subtotal` –∏ `total` (–Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `NaN` –∏–ª–∏ 0)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ API

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –±–ª—é–¥–∞, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ—à–∏–±–∫–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –±–ª—é–¥–∞ –∏–∑ `/api/menu`.

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:**
   - –ì–æ—Å—Ç—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —Å –±–ª—é–¥–∞–º–∏ –∏–∑ –º–µ–Ω—é
   - –ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è
   - –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å
   - –ê–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏:**
   - –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
     - `"üë• –ü—Ä–æ–≤–µ—Ä–∫–∞ persons"` - –¥–µ—Ç–∞–ª–∏ –æ persons
     - `"üîç [OrderModal] –í—ã–∑—ã–≤–∞–µ–º onRequestAuth"` - —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ OrderModal

3. **–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è:**
   - –õ–æ–≥–∏ –ø–æ–∫–∞–∂—É—Ç, –ø—É—Å—Ç –ª–∏ `persons` –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   - –ú–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–¥–µ —Ç–µ—Ä—è—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –æ –±–ª—é–¥–∞—Ö

## üéØ –ò—Ç–æ–≥

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –ø—É—Å—Ç—ã–º–∏ `persons`:
- **–†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ** –≤ `handleAutoCheckout`
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ `WarningDialog`
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- **API –≤–∞–ª–∏–¥–∞—Ü–∏—è** –¥–ª—è –∑–∞—â–∏—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞

–¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ `persons` –æ–∫–∞–∂–µ—Ç—Å—è –ø—É—Å—Ç—ã–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤–º–µ—Å—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–≥–æ "{}".


