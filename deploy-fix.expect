#!/usr/bin/expect -f

set timeout 300
set server "root@5.129.194.168"

spawn ssh -o StrictHostKeyChecking=no $server

expect {
    "password:" {
        send_user "\n–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: "
        stty raw -echo
        expect_user -timeout 3600 -re "(.*)\r"
        stty -raw echo
        set password $expect_out(1,string)
        send "$password\r"
        exp_continue
    }
    "Permission denied" {
        send_user "\n‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å.\n"
        exit 1
    }
    "$ " {
        # –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    }
    "# " {
        # –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (root)
    }
    timeout {
        send_user "\n‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
        exit 1
    }
}

send_user "\n‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É\n"
send_user "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub...\n"

send "cd /var/www/ogfoody 2>/dev/null || cd /root/my-project\r"
expect {
    "$ " {}
    "# " {}
    timeout {}
}

send "git fetch origin\r"
expect {
    "$ " {}
    "# " {}
    timeout {}
}

send "git reset --hard origin/main 2>/dev/null || git reset --hard origin/master\r"
expect {
    "$ " {}
    "# " {}
    timeout {}
}

send_user "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...\n"
send "npm ci --production=false\r"
expect {
    "$ " {}
    "# " {}
    timeout {}
}

send_user "üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...\n"
send "npm run build\r"
expect {
    "$ " {}
    "# " {}
    timeout {}
}

send_user "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...\n"
send "pm2 restart ogfoody || pm2 start ecosystem.config.js\r"
expect {
    "$ " {}
    "# " {}
    timeout {}
}

send_user "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...\n"
send "pm2 status\r"
expect {
    "$ " {}
    "# " {}
    timeout {}
}

send "exit\r"
expect eof

send_user "\nüéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!\n"
send_user "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://ogfoody.ru\n"
