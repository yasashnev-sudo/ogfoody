# Инструкция по очистке данных и запуску чистых тестов

## Шаг 1: Очистка всех тестовых данных

Запустите скрипт для полной очистки:

```bash
# Очистить только заказы и транзакции (пользователи останутся)
npx tsx scripts/cleanup-all-test-data.ts

# Полная очистка (включая пользователей)
npx tsx scripts/cleanup-all-test-data.ts --delete-users

# Полная очистка (включая промокоды)
npx tsx scripts/cleanup-all-test-data.ts --delete-users --delete-promos
```

## Шаг 2: Деплой изменений

```bash
expect deploy-increment-fix.expect
```

## Шаг 3: Запуск чистых тестов

Тесты автоматически создают пользователей через API с именем и адресом:

```bash
# Для локального тестирования
API_BASE=http://localhost:3000 npx tsx scripts/test-loyalty-clean.ts

# Для тестирования на продакшене
API_BASE=https://ogfoody.ru npx tsx scripts/test-loyalty-clean.ts
```

## Что делают тесты:

1. **Тест 1: Базовое начисление баллов**
   - Создает пользователя через API
   - Создает заказ на 2000₽ с оплатой картой
   - Проверяет начисление 60 баллов (3% от 2000)

2. **Тест 2: Начисление баллов с промокодом**
   - Создает пользователя через API
   - Создает промокод на 200₽
   - Создает заказ на 2000₽ с промокодом (итого 1800₽)
   - Проверяет начисление 54 баллов (3% от 1800)

3. **Тест 3: Использование баллов**
   - Создает пользователя через API
   - Начисляет баллы (создает первый заказ)
   - Использует 50 баллов (создает второй заказ)
   - Проверяет правильность списания

## Важно:

- Все тесты создают пользователей с уникальными телефонами
- После каждого теста данные очищаются (заказы удаляются)
- Баланс не может быть отрицательным (защита добавлена в `calculateUserBalance`)
