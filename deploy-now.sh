#!/bin/bash
# –ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä

set -e

SERVER="root@5.129.194.168"
SERVER_PATH="/var/www/ogfoody"

echo "üöÄ –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π –Ω–∞ ogfoody.ru"
echo "================================"
echo ""
echo "üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:"
echo "1. –í–∞–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞"
echo "2. –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞, —Å–±–æ—Ä–∫—É –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
echo ""
echo "üîê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É..."
echo ""

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh $SERVER << 'ENDSSH'
set -e
cd /var/www/ogfoody || cd /root/my-project

echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git fetch origin
git reset --hard origin/main || git reset --hard origin/master

echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm ci --production=false

echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 restart ogfoody || pm2 start ecosystem.config.js

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
pm2 status ogfoody
ENDSSH

echo ""
echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://ogfoody.ru"
