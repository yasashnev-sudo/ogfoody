# ‚úÖ –û—Ç—á–µ—Ç –æ –¥–µ–ø–ª–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤–∏–¥–∂–µ—Ç–∞ YooKassa

**–î–∞—Ç–∞:** $(date)  
**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** AGENT_DEPLOYMENT_GUIDE.md  
**–°—Ç–∞—Ç—É—Å:** üöÄ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —à–∞–≥–∏:

### 1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
- –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (`npm run build`)
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –≤ Git
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã –≤ `origin/main`

### 2. ‚úÖ Git –æ–ø–µ—Ä–∞—Ü–∏–∏
```bash
git add -A
git commit -m "fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ YooKassa –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º"
git push origin main
```

### 3. üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
–ó–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç: `deploy-increment-fix.expect`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH (root@5.129.194.168)
2. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ `/var/www/ogfoody` –∏–ª–∏ `/root/my-project`
3. –í—ã–ø–æ–ª–Ω—è–µ—Ç `git fetch origin` –∏ `git reset --hard origin/main`
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `npm install --production=false`
5. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç PM2: `pm2 stop all`
6. –°–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç: `npm run build`
7. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏ (–∏—â–µ—Ç `.next/BUILD_ID`)
8. –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx (–µ—Å–ª–∏ –µ—Å—Ç—å)
9. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `pm2 delete all` ‚Üí `pm2 start ecosystem.config.js`
10. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~3-5 –º–∏–Ω—É—Ç

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–ø–ª–æ—è:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
```bash
cd "/Users/sergejasasnev/Downloads/my-project (1)"
expect check-deploy.expect
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
```bash
ssh root@5.129.194.168
# –ü–∞—Ä–æ–ª—å: pULRoAvF@P-@4Y

cd /var/www/ogfoody
git log --oneline -1
pm2 status
pm2 logs ogfoody --lines 20 --nostream
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–π—Ç–∞
```bash
curl -I https://ogfoody.ru
# –û–∂–∏–¥–∞–µ—Ç—Å—è: HTTP/2 200 –∏–ª–∏ HTTP/1.1 200 OK
```

---

## ‚úÖ –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:

1. **PM2 —Å—Ç–∞—Ç—É—Å:** `online`
2. **–°–∞–π—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:** HTTP 200
3. **–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:** "fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ YooKassa..."
4. **–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö**

---

## üìù –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. **`app/api/payments/yookassa/create/route.ts`**:
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤ `confirmation` (embedded/external)
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `useWidget` –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

2. **`components/payment-modal.tsx`**:
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `order.paymentId` –≤–º–µ—Å—Ç–æ `order.payment_id`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–í–ö/–¢–ì) —á–µ—Ä–µ–∑ `detectPlatform()`
   - –í–∏–¥–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ, –∫—Ä–æ–º–µ –í–ö –∏ –¢–ì (—Ç–∞–º redirect/—É–º–Ω—ã–π –ø–ª–∞—Ç–µ–∂)
   - –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ redirect –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤–∏–¥–∂–µ—Ç–∞
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –≤–∏–¥–∂–µ—Ç–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º

---

## üêõ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

### –ü—Ä–æ–±–ª–µ–º–∞: "502 Bad Gateway"
```bash
ssh root@5.129.194.168
pm2 restart ogfoody
pm2 logs ogfoody --lines 100
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Build failed"
```bash
ssh root@5.129.194.168
cd /var/www/ogfoody
npm run build 2>&1 | tail -50
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î–µ–ø–ª–æ–π –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
cat /tmp/deploy-complete.log
cat /tmp/deploy-full.log

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π
cd "/Users/sergejasasnev/Downloads/my-project (1)"
./deploy-increment-fix.expect
```

---

## üìû –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è (~3-5 –º–∏–Ω—É—Ç)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `expect check-deploy.expect`
3. –û—Ç–∫—Ä–æ–π—Ç–µ https://ogfoody.ru –≤ –±—Ä–∞—É–∑–µ—Ä–µ
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

**–°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –∑–∞–ø—É—â–µ–Ω. –î–µ–ø–ª–æ–π –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 3-5 –º–∏–Ω—É—Ç.**
