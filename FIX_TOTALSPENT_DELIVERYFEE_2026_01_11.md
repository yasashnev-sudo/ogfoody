# Отчет об исправлениях: totalSpent и deliveryFee
**Дата:** 2026-01-11  
**Статус:** ✅ Все проблемы решены

## Проблемы

### 1. Стоимость доставки не отображается
**Описание:** Пользователь добавил стоимость доставки для районов, но она не отображалась в UI (все районы показывали "Бесплатно").

**Причина:** 
- API `/api/menu` возвращал `deliveryFee` в camelCase формате
- Компонент `DistrictSelectionModal` проверял только `"Delivery Fee"` (Title Case) и `delivery_fee` (snake_case)
- Интерфейс `NocoDBDeliveryZone` не содержал поля `deliveryFee` (camelCase)

**Решение:**
- ✅ Добавлена поддержка `deliveryFee` (camelCase) в `district-selection-modal.tsx` (строка 133)
- ✅ Добавлено поле `deliveryFee?: number | string` в интерфейс `NocoDBDeliveryZone` (`lib/nocodb.ts`)

**Тест:** `tests/delivery-fee-api-check.spec.ts` - проверяет что API возвращает стоимость доставки для всех районов ✅

---

### 2. `totalSpent` не накапливается (не передается клиенту)
**Описание:** После создания заказов `totalSpent` не обновлялся в UI, хотя в БД значение было корректным.

**Причины (множественные):**

#### 2.1. API не возвращал `userProfile` в ответе
- POST `/api/orders` не возвращал обновленный `userProfile` с `totalSpent` клиенту
- **Решение:** Добавлен блок загрузки `userProfile` перед созданием `responseData` в `/api/orders/route.ts` (строки 614-649)

#### 2.2. `fetchUserById` искал по неправильному полю
- Функция искала по полю `"User ID"` вместо первичного ключа `"Id"`
- **Решение:** Исправлен WHERE запрос с `(User ID,eq,${id})` на `(Id,eq,${id})` в `lib/nocodb.ts` (строка 679)

#### 2.3. `awardLoyaltyPoints` использовал кэшированные данные
- При повторном вызове `awardLoyaltyPoints` для второго заказа использовались кэшированные данные пользователя с `total_spent = 0`
- **Решение:** Добавлен параметр `noCache: true` при вызове `fetchUserById` в `awardLoyaltyPoints` (строка 1128)

#### 2.4. `fetchOrderById` в PATCH возвращал кэшированные данные
- При оплате заказа через PATCH API использовались кэшированные данные заказа, где `loyalty_points_earned = 0`
- Это приводило к двойному начислению `total_spent` при оплате
- **Решение:** Добавлен параметр `noCache: true` во все вызовы `fetchOrderById` в `/api/orders/[id]/route.ts` (строки 50, 440, 479)

#### 2.5. Двойное начисление `total_spent` при оплате
- При создании заказа с `paymentMethod === 'sbp'` баллы и `total_spent` начислялись сразу
- При PATCH (оплате) они начислялись повторно, потому что `loyalty_points_earned` в заказе был = 0 из-за кэша
- **Решение:** Исправление п.2.4 устранило эту проблему - теперь `loyalty_points_earned` корректно читается из БД

#### 2.6. `fetchUserById` и `updateUser` в PATCH использовали кэш
- **Решение:** Добавлен `noCache: true` для `fetchUserById` в PATCH handler (строка 574)

**Тест:** `tests/total-spent-check.spec.ts` - проверяет накопление `totalSpent` через 2 заказа ✅

---

## Итоговые изменения

### Файлы изменены:

1. **`app/api/orders/route.ts`**
   - Добавлена загрузка `userProfile` перед созданием `responseData` (строки 614-649)
   - `userProfile` включен в ответ POST (строка 677)
   - Добавлено логирование для отладки

2. **`app/api/orders/[id]/route.ts`**
   - Добавлен `noCache: true` во все вызовы `fetchOrderById` (строки 50, 440, 479)
   - Добавлен `noCache: true` для `fetchUserById` в PATCH handler (строка 574)

3. **`lib/nocodb.ts`**
   - Исправлен WHERE запрос в `fetchUserById`: с `"User ID"` на `"Id"` (строка 679)
   - Добавлен `noCache: true` в `awardLoyaltyPoints` при вызове `fetchUserById` (строка 1128)
   - Добавлено поле `deliveryFee?: number | string` в `NocoDBDeliveryZone` (строка 470)
   - Добавлено подробное логирование расчетов `total_spent`

4. **`components/district-selection-modal.tsx`**
   - Добавлена поддержка чтения `deliveryFee` (camelCase) из зоны доставки (строка 133)

5. **`app/page.tsx`**
   - Добавлено логирование для отладки `totalSpent` в `handleSaveOrder`
   - Используется `userProfile` из ответа POST API вместо отдельного GET запроса

---

## Тесты

### Созданные тесты:

1. **`tests/total-spent-check.spec.ts`** ✅
   - Проверяет накопление `totalSpent` через 2 заказа
   - Проверяет отсутствие двойного начисления при оплате
   - **Результат:** PASSED ✅

2. **`tests/delivery-fee-api-check.spec.ts`** ✅
   - Проверяет что API возвращает стоимость доставки
   - Проверяет корректность данных для всех районов
   - **Результат:** PASSED ✅ (все районы 100₽-109₽)

3. **`tests/simple-e2e.spec.ts`** ✅
   - Полный E2E тест функциональности
   - **Результат:** 7/7 PASSED ✅

---

## Ключевые уроки

### Проблемы с кэшированием
- **NocoDB API кэширует запросы** через `nocoFetch`
- При быстрых последовательных операциях (создание → оплата) кэш возвращает устаревшие данные
- **Решение:** Использовать `noCache: true` (через `nocoFetchNoCache`) для критичных операций

### Проблемы с маппингом полей
- NocoDB может возвращать данные в разных форматах: `camelCase`, `snake_case`, `"Title Case"`
- **Решение:** Всегда проверять все варианты при чтении полей

### Проблемы с первичными ключами
- `"User ID"` - это **не первичный ключ**, а отдельное поле
- Первичный ключ в NocoDB - это `"Id"`
- **Решение:** Использовать `"Id"` для поиска записей

---

## Статус: ✅ ГОТОВО

Обе проблемы полностью решены:
1. ✅ Стоимость доставки корректно отображается
2. ✅ `totalSpent` корректно накапливается и передается клиенту
3. ✅ Нет двойного начисления при оплате
4. ✅ Все тесты проходят

**Следующие шаги:** Готово к тестированию пользователем.


