#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ –Ω–∞ production
# Bug #17: –ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã

set -e

echo "üöÄ –î–µ–ø–ª–æ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤ –Ω–∞ ogfoody.ru"
echo "=================================================="
echo ""

/usr/bin/expect << 'EOF'
set timeout 180
log_user 1

puts "üì° –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É 5.129.194.168..."
spawn ssh -o StrictHostKeyChecking=no root@5.129.194.168

expect {
    "password:" {
        send "pULRoAvF@P-@4Y\r"
    }
    timeout {
        puts "\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
        exit 1
    }
}

expect "# "
puts "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É\n"

puts "üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
send "cd /var/www/ogfoody\r"
expect "# "

puts "üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub..."
send "git pull origin main\r"
expect {
    "Already up to date" {
        puts "‚ö†Ô∏è  –ö–æ–¥ —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω"
    }
    "Updating" {
        puts "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
    }
}
expect "# "

puts "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:"
send "git log -1 --oneline\r"
expect "# "

puts "\nüì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)..."
send "npm install\r"
expect "# " timeout 60

puts "\nüî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—ç—Ç–æ –∑–∞–π–º–µ—Ç ~15 —Å–µ–∫—É–Ω–¥)..."
send "npm run build 2>&1 | tail -20\r"
expect "# " timeout 180

puts "\nüîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
send "pm2 restart ogfoody\r"
expect "# "

puts "\n‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
send "sleep 3\r"
expect "# "

puts "\nüìä –°—Ç–∞—Ç—É—Å PM2:"
send "pm2 list | grep ogfoody\r"
expect "# "

puts "\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞..."
send "curl -s -o /dev/null -w 'HTTP Status: %{http_code}\\n' http://localhost:3000\r"
expect "# "

puts "\n‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
send "exit\r"
expect eof
EOF

echo ""
echo "=================================================="
echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "  ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –ø–æ–ª–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞"
echo "  ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç:"
echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ https://ogfoody.ru"
echo "  2. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤"
echo "  3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤"
echo ""
echo "–ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ª–æ–≥–∏:"
echo "  ssh root@5.129.194.168"
echo "  pm2 logs ogfoody --lines 50"
echo ""
