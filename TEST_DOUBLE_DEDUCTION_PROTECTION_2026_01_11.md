# üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–©–ò–¢–´ –û–¢ –î–í–û–ô–ù–û–ì–û –°–ü–ò–°–ê–ù–ò–Ø
**–î–∞—Ç–∞:** 2026-01-11  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üéØ –ß–¢–û –¢–ï–°–¢–ò–†–£–ï–ú

–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ **–ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥–≤–∞–∂–¥—ã** –¥–∞–∂–µ –ø—Ä–∏:
- –ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- Race conditions (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö)
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ

---

## ‚úÖ –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù

```
‚ñ≤ Next.js 16.1.1 (Turbopack)
- Local:   http://localhost:3000
‚úì Ready in 619ms
```

**–í–∞–∂–Ω–æ:** –°–∏—Å—Ç–µ–º–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `calculateUserBalance()` - –±–∞–ª–∞–Ω—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º!

–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è #102:
```
üí∞ calculateUserBalance(102): 29 –±–∞–ª–ª–æ–≤
(–∏–∑ 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
```

---

## üìã –°–¶–ï–ù–ê–†–ò–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### 1Ô∏è‚É£ –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ (–æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç)

**–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #102:
  –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 29 –±–∞–ª–ª–æ–≤
  Total Spent: 2946‚ÇΩ
```

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –í–æ–π—Ç–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #102 (phone: 75676757657)
2. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ ~1000‚ÇΩ
3. –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **29 –±–∞–ª–ª–æ–≤** (–≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ)
4. –û–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π/–°–ë–ü (–Ω–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏!)
5. –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã: -29
‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã –∑–∞ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑: +30 (–ø—Ä–∏–º–µ—Ä–Ω–æ 3% –æ—Ç 1000‚ÇΩ)
‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 29 - 29 + 30 = 30 –±–∞–ª–ª–æ–≤ ‚úÖ
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞:**
```javascript
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º: {
  userId: 102,
  currentBalance: 29,
  requestedToUse: 29,
  sufficient: true  // ‚úÖ
}

‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 102: {
  oldBalance: 29,
  used: 29,
  newBalance: 0  // ‚úÖ
}

// –ó–∞—Ç–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ:
‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã: +30
```

---

### 2Ô∏è‚É£ –ü–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å (–∑–∞—â–∏—Ç–∞)

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **50 –±–∞–ª–ª–æ–≤** (–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ 29)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚ö†Ô∏è –°–∏—Å—Ç–µ–º–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–æ–∑–≤–æ–ª–∏—Ç—å —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
(–∫–Ω–æ–ø–∫–∞ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 50 –±–∞–ª–ª–æ–≤" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)

–ï—Å–ª–∏ –≤—Å–µ-—Ç–∞–∫–∏ –∑–∞–ø—Ä–æ—Å –¥–æ–π–¥–µ—Ç –¥–æ API:
‚ö†Ô∏è –ó–ê–©–ò–¢–ê: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è!
‚ÑπÔ∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ø–∏—Å–∞–Ω–∏–µ
```

---

### 3Ô∏è‚É£ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è)

**–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—Å—è –µ—Å–ª–∏:**
- Frontend —Å–ª—É—á–∞–π–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥–≤–∞ PATCH –∑–∞–ø—Ä–æ—Å–∞
- –ë—É–¥–µ—Ç race condition

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª–æ–≥–∞—Ö:**
```javascript
// –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å:
‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã: {
  oldBalance: 29,
  used: 29,
  newBalance: 0
}

// –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–µ—Å–ª–∏ –±—É–¥–µ—Ç):
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞: {
  currentBalance: 0,  // ‚Üê –£–∂–µ —Å–ø–∏—Å–∞–Ω—ã!
  requestedToUse: 29,
  sufficient: false  // ‚ùå
}

‚ö†Ô∏è –ó–ê–©–ò–¢–ê: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤!
‚ÑπÔ∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ø–∏—Å–∞–Ω–∏–µ - –±–∞–ª–ª—ã —É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã
```

---

## üîç –ß–¢–û –°–ú–û–¢–†–ï–¢–¨ –í –õ–û–ì–ê–•

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–≤—Å–µ –û–ö):
```javascript
üîç ========== –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í (PATCH ...) ==========
üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º N –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ #XXX
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º: { sufficient: true }
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è "used" —Å–æ–∑–¥–∞–Ω–∞: -N –±–∞–ª–ª–æ–≤
‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: { newBalance: X }
üîç ========== –ö–û–ù–ï–¶ –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–õ–û–í ==========
```

### –ó–∞—â–∏—Ç–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞:
```javascript
üîç ========== –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í (PATCH ...) ==========
üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º N –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ #XXX
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º: { sufficient: false }
‚ö†Ô∏è –ó–ê–©–ò–¢–ê: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è! {
  available: X,
  requested: N,
  deficit: Y
}
‚ÑπÔ∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ø–∏—Å–∞–Ω–∏–µ - –≤–æ–∑–º–æ–∂–Ω–æ –±–∞–ª–ª—ã —É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Ä–∞–Ω–µ–µ
üîç ========== –ö–û–ù–ï–¶ –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–õ–û–í (–ø—Ä–æ–ø—É—â–µ–Ω–æ) ==========
```

---

## üìä –ü–†–û–í–ï–†–ö–ê –î–ê–ù–ù–´–• –í NOCODB

### –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

**1. Users table (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #102):**
```bash
curl -s -X GET \
  "https://noco.povarnakolesah.ru/api/v2/tables/mg9dm2m41bjv8ar/records?where=(Id,eq,102)" \
  -H "xc-token: eppmI3qJq8ahGaCzPmjmZGIze9NgJxEFQzu6Ps1r" \
  | jq '.list[0] | {Id, "Loyalty Points", "Total Spent"}'
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```json
{
  "Id": 102,
  "Loyalty Points": <–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å>,
  "Total Spent": <—É–≤–µ–ª–∏—á–∏–ª—Å—è –µ—Å–ª–∏ –±—ã–ª online –ø–ª–∞—Ç–µ–∂>
}
```

**2. Loyalty_Points_Transactions:**
```bash
curl -s -X GET \
  "https://noco.povarnakolesah.ru/api/v2/tables/me3bbmn5ksn73nh/records?where=(User ID,eq,102)&sort=-Id&limit=5" \
  -H "xc-token: eppmI3qJq8ahGaCzPmjmZGIze9NgJxEFQzu6Ps1r" \
  | jq '.list[] | {Id, "Transaction Type", Points, Description}'
```

**–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:**
```json
[
  {
    "Id": XXX,
    "Transaction Type": "earned",
    "Points": 30,
    "Description": "–ù–∞—á–∏—Å–ª–µ–Ω–æ 30 –±–∞–ª–ª–æ–≤ –∑–∞ –∑–∞–∫–∞–∑..."
  },
  {
    "Id": XXX,
    "Transaction Type": "used",
    "Points": -29,
    "Description": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 29 –±–∞–ª–ª–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞"
  }
]
```

**–í–∞–∂–Ω–æ:** –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å **–û–î–ù–ê** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è "used", –∞ –Ω–µ –¥–≤–µ!

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

1. ‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **–û–î–ò–ù –†–ê–ó**
2. ‚úÖ –ë–∞–ª–∞–Ω—Å **–ù–ï —É—Ö–æ–¥–∏—Ç –≤ –º–∏–Ω—É—Å**
3. ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π "used" —Ä–æ–≤–Ω–æ **–û–î–ù–ê** (–Ω–µ –¥–≤–µ!)
4. ‚úÖ –ù–æ–≤—ã–µ –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∑–∞ online –ø–ª–∞—Ç–µ–∂)
5. ‚úÖ –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ –ª–∏–±–æ "‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã" –ª–∏–±–æ "‚ö†Ô∏è –ó–ê–©–ò–¢–ê: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º"

---

## üêõ –ß–¢–û –î–ï–õ–ê–¢–¨ –ï–°–õ–ò –ù–ï –†–ê–ë–û–¢–ê–ï–¢

### –ï—Å–ª–∏ –±–∞–ª–ª—ã –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–ø–∏—Å–∞–ª–∏—Å—å –¥–≤–∞–∂–¥—ã:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ - –≤–∏–¥–Ω—ã –ª–∏ —Ç–∞–º **–¥–≤–∞** –±–ª–æ–∫–∞ "–°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í"?
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ NocoDB - —Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π "used" –¥–ª—è –∑–∞–∫–∞–∑–∞?
3. –ü—Ä–∏—Å–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –ª–æ–≥–æ–≤

### –ï—Å–ª–∏ –∑–∞—â–∏—Ç–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: `calculateUserBalance(userId)`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ –ø—ã—Ç–∞–µ—Ç–µ—Å—å —Å–ø–∏—Å–∞—Ç—å
3. –í–æ–∑–º–æ–∂–Ω–æ –±–∞–ª–∞–Ω—Å —É–∂–µ –±—ã–ª 0

---

## üìù –ì–û–¢–û–í–û

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:
- ‚úÖ –ó–∞—â–∏—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ Full Order Update
- ‚úÖ –ó–∞—â–∏—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ Partial Update
- ‚úÖ –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ

**–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ!** üöÄ


