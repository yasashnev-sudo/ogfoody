# üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –¥–ª—è –ÆKassa

## –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

–ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ÆKassa, –Ω–æ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É webhook.

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://yookassa.ru/my
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç

### 2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω

1. –í —Å–ø–∏—Å–∫–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –Ω–∞–π–¥–∏—Ç–µ **—Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω** (Shop ID: `1251656`)
2. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–≥–æ

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚Üí **HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
2. –í –ø–æ–ª–µ **URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** –≤–≤–µ–¥–∏—Ç–µ:
   ```
   https://ogfoody.ru/api/payments/yookassa/webhook
   ```
3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è:
   - ‚úÖ `payment.succeeded` - —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
   - ‚úÖ `payment.canceled` - –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂
   - ‚úÖ `payment.waiting_for_capture` - –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
   - ‚úÖ `refund.succeeded` - –≤–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

4. –ù–∞–∂–º–∏—Ç–µ **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å**

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ÆKassa –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
ssh root@5.129.194.168
pm2 logs ogfoody --lines 50
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
üì• YooKassa webhook received: { type: 'payment.succeeded', ... }
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤–æ–æ–±—â–µ

**–ü—Ä–∏—á–∏–Ω—ã:**
- Webhook URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `https://ogfoody.ru/api/payments/yookassa/webhook`)
- –ü—Ä–æ–±–ª–µ–º—ã —Å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è HTTPS
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: `pm2 logs ogfoody --lines 100`

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ IP –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–∏–∑–Ω–∞–∫–∏ –≤ –ª–æ–≥–∞—Ö:**
```
‚ùå Invalid IP address for webhook: <IP>
```

**–†–µ—à–µ–Ω–∏–µ:**
- –í —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ IP –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–∞—è
- –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –ø–ª–∞—Ç–µ–∂ –≤—Å–µ —Ä–∞–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ IP –±—É–¥–µ—Ç —Å—Ç—Ä–æ–∂–µ

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –∑–∞–∫–∞–∑ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

**–ü—Ä–∏–∑–Ω–∞–∫–∏ –≤ –ª–æ–≥–∞—Ö:**
```
üì• YooKassa webhook received: { ... }
‚ùå Order <ID> not found
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `orderId` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `metadata` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook:

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
2. –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π: `5555555555554444`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   pm2 logs ogfoody --lines 50 | grep -i "webhook\|payment"
   ```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –ë–î –∏–ª–∏ —á–µ—Ä–µ–∑ API:
   ```bash
   curl https://ogfoody.ru/api/orders/1062
   ```

## üìù –í–∞–∂–Ω–æ

- **–î–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞** –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –æ—Ç–¥–µ–ª—å–Ω–æ
- **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω –º–∞–≥–∞–∑–∏–Ω–∞** –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –æ—Ç–¥–µ–ª—å–Ω–æ (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω)
- Webhook URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
- –ÆKassa –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É webhook –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç HTTP 200

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ÆKassa: HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](https://yookassa.ru/developers/using-api/webhooks)
- [–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa](https://yookassa.ru/my)
- [–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π](https://yookassa.ru/my/payments)
