# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤

**–î–∞—Ç–∞:** 16.01.2026  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–¥–µ–ø–ª–æ–µ–Ω–æ –Ω–∞ –ø—Ä–æ–¥

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –¥–≤–∞–∂–¥—ã –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞:
1. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–¥–ª—è –∑–∞–∫–∞–∑–æ–≤ —Å –Ω–∞–ª–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–æ–π)
2. –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã (–¥–ª—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤)

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π "earned" –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏—é `awardLoyaltyPoints` (`lib/nocodb.ts`, —Å—Ç—Ä–æ–∫–∏ 1252-1285):

### –ú–µ—Ö–∞–Ω–∏–∑–º –∑–∞—â–∏—Ç—ã:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π:
   - –ò—â–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–∏–ø–∞ "earned" —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "completed" –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
   - –ï—Å–ª–∏ —Ç–∞–∫–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è**:
   ```
   ‚ö†Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ì–û –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø: –ë–∞–ª–ª—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ {orderId} 
   (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è {transactionId}, {points} –±–∞–ª–ª–æ–≤). –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
   ```

3. **–ü–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞** –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ó–∞—â–∏—Ç–∞ –Ω–∞ –¥–≤—É—Ö —É—Ä–æ–≤–Ω—è—Ö:

1. **–í `awardLoyaltyPoints`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π
2. **–í `app/api/orders/[id]/route.ts`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ `existingPointsEarnedPartial` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `awardLoyaltyPoints`

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –ø—Ä–æ–¥–µ:

```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@5.129.194.168

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ PM2
pm2 logs --lines 200 | grep "–ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ì–û –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ë–î:

```sql
-- –ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ "earned"
SELECT 
  "Order ID",
  COUNT(*) as transaction_count,
  SUM("Points") as total_points
FROM "Loyalty_Points_Transactions"
WHERE "Transaction Type" = 'earned' 
  AND "Transaction Status" = 'completed'
GROUP BY "Order ID"
HAVING COUNT(*) > 1
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API:

```bash
# –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl "https://ogfoody.ru/api/db/Loyalty_Points_Transactions/records?where=(User ID,eq,120)&sort=-created_at" \
  -H "xc-token: YOUR_TOKEN"
```

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### `lib/nocodb.ts` (—Å—Ç—Ä–æ–∫–∏ 1252-1285):

```typescript
// ‚úÖ –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ì–û –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –ª–∏ —É–∂–µ –±–∞–ª–ª—ã –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
if (earnedPoints > 0 && orderId) {
  const existingTransactions = await fetchLoyaltyPointsTransactions(userId)
  const existingEarnedTransaction = existingTransactions.find(
    (t: NocoDBLoyaltyPointsTransaction) => 
      (t.order_id === orderId || t['Order ID'] === orderId) &&
      (t.transaction_type === 'earned' || t['Transaction Type'] === 'earned') &&
      (t.transaction_status === 'completed' || t['Transaction Status'] === 'completed')
  )
  
  if (existingEarnedTransaction) {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  }
}
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã –Ω–∞ –ø—Ä–æ–¥
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîÑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:
- –ï—Å–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø–æ—è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç–æ - –≤–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∏–∫–µ –≤—ã–∑–æ–≤–æ–≤
- –ï—Å–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ—Ç - –∑–∞—â–∏—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
