# ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –¥–ª—è cash-–∑–∞–∫–∞–∑–æ–≤ (–û–ë–ù–û–í–õ–ï–ù–û)

**–î–∞—Ç–∞**: 2026-01-11  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (v2 - –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ partial update)  
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏**: 
- Debug –ª–æ–≥ `2026-01-11T15-03-27-877Z_user-100_logs.txt`
- Debug –ª–æ–≥ `2026-01-11T15-10-13-807Z_user-101_logs.txt` (–ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏–ª–∞—Å—å!)

---

## ‚ö†Ô∏è –û–ë–ù–û–í–õ–ï–ù–ò–ï: –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!

### –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
–î–æ–±–∞–≤–∏–ª –∫–æ–¥ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ –≤ **Full Order Update** –±–ª–æ–∫ (—Å—Ç—Ä–æ–∫–∞ ~186).

### –ü—Ä–æ–±–ª–µ–º–∞:
Cash-–∑–∞–∫–∞–∑—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **Partial Update**, –≥–¥–µ —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –ù–ï –ë–´–õ–û!

### –†–µ—à–µ–Ω–∏–µ v2:
–î–æ–±–∞–≤–∏–ª –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –±–ª–æ–∫ –≤ **Partial Update** (—Å—Ç—Ä–æ–∫–∞ ~614).

---

## üìù USER COMMENT:
> **"—ç—Ç–æ –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑. –Ø –≤—ã–±—Ä–∞–ª –æ–ø–ª–∞—Ç—É –Ω–∞–ª–∏—á–Ω—ã–º–∏ —á–∞—Å—Ç–∏—á–Ω–æ –±–∞–ª–ª–∞–º–∏, –Ω–æ –±–∞–ª–ª—ã –Ω–µ —Å–ø–∏—Å–∞–ª–∏—Å—å"**

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:

**–ó–∞–∫–∞–∑ #509:**
- Frontend –æ—Ç–ø—Ä–∞–≤–∏–ª: `loyaltyPointsUsed: 48`
- Backend –∑–∞–ø–∏—Å–∞–ª –≤ –ë–î: `loyalty_points_used: 0` ‚ùå
- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `96` (–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è) ‚ùå

**–û–∂–∏–¥–∞–ª–æ—Å—å:**
- `loyalty_points_used: 48` ‚úÖ
- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `48` (96 - 48) ‚úÖ

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã

### –í POST `/api/orders` (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞):

**–ï—Å—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤** (—Å—Ç—Ä–æ–∫–∞ ~522):
```typescript
// ‚úÖ –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í: –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ –°–†–ê–ó–£
if (pointsUsed > 0) {
  await createLoyaltyPointsTransaction({
    user_id: userId,
    order_id: nocoOrder.Id,
    transaction_type: "used",
    transaction_status: "completed",
    points: -pointsUsed,
    // ...
  })
  // –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  await updateUser(userId, {
    loyalty_points: currentBalance - pointsUsed
  })
}
```

---

### –í PATCH `/api/orders/[id]` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞):

**–ù–ï –ë–´–õ–û —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤!** ‚ùå

–£—Å–ª–æ–≤–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 187):
```typescript
if (!wasPaid && willBePaid && currentOrder.user_id) {
  // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ —á–µ—Ä–µ–∑ awardLoyaltyPoints
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è cash-–∑–∞–∫–∞–∑–æ–≤ `paid: false`, –ø–æ—ç—Ç–æ–º—É `willBePaid = false` –∏ –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!

`awardLoyaltyPoints` –£–ú–ï–ï–¢ —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å `pointsUsed`), –Ω–æ –¥–ª—è cash-–∑–∞–∫–∞–∑–æ–≤ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è **–ù–ï –í–´–ó–´–í–ê–õ–ê–°–¨**.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï v2 (–§–ò–ù–ê–õ–¨–ù–û–ï)

–î–æ–±–∞–≤–ª–µ–Ω—ã **–î–í–ê** –±–ª–æ–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤:

### 1. –î–ª—è Full Order Update (—Å—Ç—Ä–æ–∫–∏ ~186-245)
–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `body.order` (–ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞).

### 2. –î–ª—è Partial Update (—Å—Ç—Ä–æ–∫–∏ ~614-683)
–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (`body.loyaltyPointsUsed`, `body.paid`, –∏ —Ç.–¥.).

**–ö–æ–¥ –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö:**

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û 2026-01-11: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –≤ –∑–∞–∫–∞–∑–µ
// –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –∏ —Å—Ç–∞—Ç—É—Å–∞ paid
if (currentOrder.user_id && order.loyaltyPointsUsed && order.loyaltyPointsUsed > 0) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∏ –ª–∏ –±–∞–ª–ª—ã —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã
    const existingPointsUsed = typeof currentOrder.loyalty_points_used === 'number' 
      ? currentOrder.loyalty_points_used 
      : parseInt(String(currentOrder.loyalty_points_used)) || 0
    
    // –°–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–Ω–µ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
    if (existingPointsUsed === 0 && order.loyaltyPointsUsed > 0) {
      console.log(`üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º ${order.loyaltyPointsUsed} –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${id}`)
      
      // 1. –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ
      await createLoyaltyPointsTransaction({
        user_id: currentOrder.user_id,
        order_id: Number(id),
        transaction_type: "used",
        transaction_status: "completed",
        points: -order.loyaltyPointsUsed,
        description: `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${order.loyaltyPointsUsed} –±–∞–ª–ª–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞`,
        // ...
      })
      
      // 2. –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const user = await fetchUserById(currentOrder.user_id, true)
      if (user) {
        const currentBalance = user.loyalty_points
        const newBalance = currentBalance - order.loyaltyPointsUsed
        
        await updateUser(currentOrder.user_id, {
          loyalty_points: newBalance,
          updated_at: now,
        })
        
        console.log(`‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã: ${currentBalance} - ${order.loyaltyPointsUsed} = ${newBalance}`)
      }
    } else {
      console.log(`‚ÑπÔ∏è –ë–∞–ª–ª—ã —É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Ä–∞–Ω–µ–µ –∏–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å`)
    }
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –±–∞–ª–ª–æ–≤:`, error)
    // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
  }
}
```

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏—è

### 1. –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è `card`, `sbp`, `cash`
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `paid` —Å—Ç–∞—Ç—É—Å–∞

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
```typescript
if (existingPointsUsed === 0 && order.loyaltyPointsUsed > 0) {
  // –°–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∞–ª–ª—ã –ù–ï –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Ä–∞–Ω–µ–µ
}
```

### 3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `Loyalty_Points_Transactions`
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `Users.loyalty_points`

### 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ `try/catch` - –æ—à–∏–±–∫–∞ –Ω–µ –ª–æ–º–∞–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å
- ‚úÖ –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π

---

## üìä –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Cash + –±–∞–ª–ª—ã (–∫–∞–∫ –≤ –ª–æ–≥–µ)

**–®–∞–≥ 1:** PATCH —Å `paymentMethod: "cash"`, `loyaltyPointsUsed: 48`

```
üîç ========== –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í (PATCH) ==========
üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º 48 –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ 509
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è "used" —Å–æ–∑–¥–∞–Ω–∞: -48 –±–∞–ª–ª–æ–≤
‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 100: 
  oldBalance: 96
  used: 48
  newBalance: 48
üîç ========== –ö–û–ù–ï–¶ –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–õ–û–í ==========
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Order: `loyalty_points_used: 48` ‚úÖ
- User: `loyalty_points: 48` ‚úÖ
- Transaction: `type: "used", points: -48, status: "completed"` ‚úÖ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Card + –±–∞–ª–ª—ã

**–®–∞–≥ 1:** PATCH —Å `paymentMethod: "card"`, `loyaltyPointsUsed: 20`, `paid: true`

```
// –°–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å–∞–Ω–∏–µ (–Ω–æ–≤—ã–π –±–ª–æ–∫):
üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º 20 –±–∞–ª–ª–æ–≤

// –ü–æ—Ç–æ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫):
if (!wasPaid && willBePaid) {
  await awardLoyaltyPoints(userId, orderTotal, 0, earnedPoints, orderId)
  // ‚ö†Ô∏è –ü–µ—Ä–µ–¥–∞–µ–º pointsUsed: 0, —Ç.–∫. —Å–ø–∏—Å–∞–Ω–∏–µ —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤—ã—à–µ
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Order: `loyalty_points_used: 20, loyalty_points_earned: 50` ‚úÖ
- User: `loyalty_points: 100 - 20 + 50 = 130` ‚úÖ

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—ã

–¢–µ–ø–µ—Ä—å –¥–ª—è card/sbp –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **–î–í–ê –†–ê–ó–ê** –≤ –∫–æ–¥–µ:
1. –í –Ω–æ–≤–æ–º –±–ª–æ–∫–µ (—Å—Ç—Ä–æ–∫–∞ ~187)
2. –í `awardLoyaltyPoints` (—Å—Ç—Ä–æ–∫–∞ ~280)

**–ù–û!** –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ù–æ–≤—ã–π –±–ª–æ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: `existingPointsUsed === 0`
- –ï—Å–ª–∏ –±–∞–ª–ª—ã —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

**–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê (–µ—Å–ª–∏ –±—É–¥—É—Ç –ø—Ä–æ–±–ª–µ–º—ã):**
–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `pointsUsed` –≤ `awardLoyaltyPoints` —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—ã, –∞ –¥–ª—è cash - 0.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: Cash + –±–∞–ª–ª—ã (–ø—Ä–æ–±–ª–µ–º–∞ –∏–∑ –ª–æ–≥–∞)

1. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ –Ω–∞ 2,815‚ÇΩ
2. –í—ã–±–µ—Ä–∏ "–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏"
3. –ò—Å–ø–æ–ª—å–∑—É–π 48 –±–∞–ª–ª–æ–≤
4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞–∫–∞–∑

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ Order: `loyalty_points_used: 48`
- ‚úÖ User balance: 96 ‚Üí 48
- ‚úÖ Transaction —Å–æ–∑–¥–∞–Ω–∞: `type: "used", points: -48`

---

### –¢–µ—Å—Ç 2: Card + –±–∞–ª–ª—ã

1. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ –Ω–∞ 3,000‚ÇΩ
2. –ò—Å–ø–æ–ª—å–∑—É–π 50 –±–∞–ª–ª–æ–≤
3. –û–ø–ª–∞—Ç–∏ –∫–∞—Ä—Ç–æ–π

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã: -50
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã: +150 (–∑–∞ 3000‚ÇΩ)
- ‚úÖ –ò—Ç–æ–≥–æ: 96 - 50 + 150 = 196

---

### –¢–µ—Å—Ç 3: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π PATCH (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π)

1. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ —Å –±–∞–ª–ª–∞–º–∏
2. PATCH #1: –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
3. PATCH #2: —Ç–æ—Ç –∂–µ –∑–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ PATCH #1: –±–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã
- ‚úÖ PATCH #2: `existingPointsUsed > 0` ‚Üí –±–∞–ª–ª—ã –ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- ‚úÖ `app/api/orders/[id]/route.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–æ **2 –±–ª–æ–∫–∞** —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤:
  - –°—Ç—Ä–æ–∫–∏ ~186-245: Full Order Update
  - –°—Ç—Ä–æ–∫–∏ ~614-683: Partial Update (~70 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥—ã–π)

---

## ‚úÖ –ò–¢–û–ì

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–ª–ª—ã –Ω–µ —Å–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –¥–ª—è cash-–∑–∞–∫–∞–∑–æ–≤ –≤ PATCH  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã  
**–ó–∞—â–∏—Ç–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `existingPointsUsed` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ  
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã (card, sbp, cash)  

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

**–ü—Ä–æ–≤–µ—Ä—å:** –°–æ–∑–¥–∞–π cash-–∑–∞–∫–∞–∑ + –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–ª–ª—ã ‚Üí –±–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã —Å–ø–∏—Å–∞—Ç—å—Å—è!


**–î–∞—Ç–∞**: 2026-01-11  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (v2 - –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ partial update)  
**–ò—Å—Ç–æ—á–Ω–∏–∫–∏**: 
- Debug –ª–æ–≥ `2026-01-11T15-03-27-877Z_user-100_logs.txt`
- Debug –ª–æ–≥ `2026-01-11T15-10-13-807Z_user-101_logs.txt` (–ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏–ª–∞—Å—å!)

---

## ‚ö†Ô∏è –û–ë–ù–û–í–õ–ï–ù–ò–ï: –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!

### –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
–î–æ–±–∞–≤–∏–ª –∫–æ–¥ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ –≤ **Full Order Update** –±–ª–æ–∫ (—Å—Ç—Ä–æ–∫–∞ ~186).

### –ü—Ä–æ–±–ª–µ–º–∞:
Cash-–∑–∞–∫–∞–∑—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **Partial Update**, –≥–¥–µ —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –ù–ï –ë–´–õ–û!

### –†–µ—à–µ–Ω–∏–µ v2:
–î–æ–±–∞–≤–∏–ª –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –±–ª–æ–∫ –≤ **Partial Update** (—Å—Ç—Ä–æ–∫–∞ ~614).

---

## üìù USER COMMENT:
> **"—ç—Ç–æ –≤—Ç–æ—Ä–æ–π –∑–∞–∫–∞–∑. –Ø –≤—ã–±—Ä–∞–ª –æ–ø–ª–∞—Ç—É –Ω–∞–ª–∏—á–Ω—ã–º–∏ —á–∞—Å—Ç–∏—á–Ω–æ –±–∞–ª–ª–∞–º–∏, –Ω–æ –±–∞–ª–ª—ã –Ω–µ —Å–ø–∏—Å–∞–ª–∏—Å—å"**

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:

**–ó–∞–∫–∞–∑ #509:**
- Frontend –æ—Ç–ø—Ä–∞–≤–∏–ª: `loyaltyPointsUsed: 48`
- Backend –∑–∞–ø–∏—Å–∞–ª –≤ –ë–î: `loyalty_points_used: 0` ‚ùå
- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `96` (–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è) ‚ùå

**–û–∂–∏–¥–∞–ª–æ—Å—å:**
- `loyalty_points_used: 48` ‚úÖ
- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `48` (96 - 48) ‚úÖ

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω—ã

### –í POST `/api/orders` (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞):

**–ï—Å—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤** (—Å—Ç—Ä–æ–∫–∞ ~522):
```typescript
// ‚úÖ –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í: –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ –°–†–ê–ó–£
if (pointsUsed > 0) {
  await createLoyaltyPointsTransaction({
    user_id: userId,
    order_id: nocoOrder.Id,
    transaction_type: "used",
    transaction_status: "completed",
    points: -pointsUsed,
    // ...
  })
  // –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  await updateUser(userId, {
    loyalty_points: currentBalance - pointsUsed
  })
}
```

---

### –í PATCH `/api/orders/[id]` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞):

**–ù–ï –ë–´–õ–û —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤!** ‚ùå

–£—Å–ª–æ–≤–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 187):
```typescript
if (!wasPaid && willBePaid && currentOrder.user_id) {
  // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ —á–µ—Ä–µ–∑ awardLoyaltyPoints
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è cash-–∑–∞–∫–∞–∑–æ–≤ `paid: false`, –ø–æ—ç—Ç–æ–º—É `willBePaid = false` –∏ –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!

`awardLoyaltyPoints` –£–ú–ï–ï–¢ —Å–ø–∏—Å—ã–≤–∞—Ç—å –±–∞–ª–ª—ã (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å `pointsUsed`), –Ω–æ –¥–ª—è cash-–∑–∞–∫–∞–∑–æ–≤ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è **–ù–ï –í–´–ó–´–í–ê–õ–ê–°–¨**.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï v2 (–§–ò–ù–ê–õ–¨–ù–û–ï)

–î–æ–±–∞–≤–ª–µ–Ω—ã **–î–í–ê** –±–ª–æ–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤:

### 1. –î–ª—è Full Order Update (—Å—Ç—Ä–æ–∫–∏ ~186-245)
–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `body.order` (–ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞).

### 2. –î–ª—è Partial Update (—Å—Ç—Ä–æ–∫–∏ ~614-683)
–ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (`body.loyaltyPointsUsed`, `body.paid`, –∏ —Ç.–¥.).

**–ö–æ–¥ –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö:**

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û 2026-01-11: –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –≤ –∑–∞–∫–∞–∑–µ
// –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –∏ —Å—Ç–∞—Ç—É—Å–∞ paid
if (currentOrder.user_id && order.loyaltyPointsUsed && order.loyaltyPointsUsed > 0) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∏ –ª–∏ –±–∞–ª–ª—ã —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã
    const existingPointsUsed = typeof currentOrder.loyalty_points_used === 'number' 
      ? currentOrder.loyalty_points_used 
      : parseInt(String(currentOrder.loyalty_points_used)) || 0
    
    // –°–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ (–Ω–µ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
    if (existingPointsUsed === 0 && order.loyaltyPointsUsed > 0) {
      console.log(`üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º ${order.loyaltyPointsUsed} –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${id}`)
      
      // 1. –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ
      await createLoyaltyPointsTransaction({
        user_id: currentOrder.user_id,
        order_id: Number(id),
        transaction_type: "used",
        transaction_status: "completed",
        points: -order.loyaltyPointsUsed,
        description: `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${order.loyaltyPointsUsed} –±–∞–ª–ª–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞`,
        // ...
      })
      
      // 2. –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–ª—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const user = await fetchUserById(currentOrder.user_id, true)
      if (user) {
        const currentBalance = user.loyalty_points
        const newBalance = currentBalance - order.loyaltyPointsUsed
        
        await updateUser(currentOrder.user_id, {
          loyalty_points: newBalance,
          updated_at: now,
        })
        
        console.log(`‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã: ${currentBalance} - ${order.loyaltyPointsUsed} = ${newBalance}`)
      }
    } else {
      console.log(`‚ÑπÔ∏è –ë–∞–ª–ª—ã —É–∂–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Ä–∞–Ω–µ–µ –∏–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å`)
    }
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ –±–∞–ª–ª–æ–≤:`, error)
    // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
  }
}
```

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏—è

### 1. –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è `card`, `sbp`, `cash`
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `paid` —Å—Ç–∞—Ç—É—Å–∞

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
```typescript
if (existingPointsUsed === 0 && order.loyaltyPointsUsed > 0) {
  // –°–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∞–ª–ª—ã –ù–ï –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã —Ä–∞–Ω–µ–µ
}
```

### 3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `Loyalty_Points_Transactions`
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `Users.loyalty_points`

### 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ `try/catch` - –æ—à–∏–±–∫–∞ –Ω–µ –ª–æ–º–∞–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å
- ‚úÖ –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π

---

## üìä –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Cash + –±–∞–ª–ª—ã (–∫–∞–∫ –≤ –ª–æ–≥–µ)

**–®–∞–≥ 1:** PATCH —Å `paymentMethod: "cash"`, `loyaltyPointsUsed: 48`

```
üîç ========== –°–ü–ò–°–ê–ù–ò–ï –ë–ê–õ–õ–û–í (PATCH) ==========
üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º 48 –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ 509
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è "used" —Å–æ–∑–¥–∞–Ω–∞: -48 –±–∞–ª–ª–æ–≤
‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 100: 
  oldBalance: 96
  used: 48
  newBalance: 48
üîç ========== –ö–û–ù–ï–¶ –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–õ–û–í ==========
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Order: `loyalty_points_used: 48` ‚úÖ
- User: `loyalty_points: 48` ‚úÖ
- Transaction: `type: "used", points: -48, status: "completed"` ‚úÖ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Card + –±–∞–ª–ª—ã

**–®–∞–≥ 1:** PATCH —Å `paymentMethod: "card"`, `loyaltyPointsUsed: 20`, `paid: true`

```
// –°–Ω–∞—á–∞–ª–∞ —Å–ø–∏—Å–∞–Ω–∏–µ (–Ω–æ–≤—ã–π –±–ª–æ–∫):
üí≥ –°–ø–∏—Å—ã–≤–∞–µ–º 20 –±–∞–ª–ª–æ–≤

// –ü–æ—Ç–æ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫):
if (!wasPaid && willBePaid) {
  await awardLoyaltyPoints(userId, orderTotal, 0, earnedPoints, orderId)
  // ‚ö†Ô∏è –ü–µ—Ä–µ–¥–∞–µ–º pointsUsed: 0, —Ç.–∫. —Å–ø–∏—Å–∞–Ω–∏–µ —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤—ã—à–µ
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Order: `loyalty_points_used: 20, loyalty_points_earned: 50` ‚úÖ
- User: `loyalty_points: 100 - 20 + 50 = 130` ‚úÖ

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—ã

–¢–µ–ø–µ—Ä—å –¥–ª—è card/sbp –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **–î–í–ê –†–ê–ó–ê** –≤ –∫–æ–¥–µ:
1. –í –Ω–æ–≤–æ–º –±–ª–æ–∫–µ (—Å—Ç—Ä–æ–∫–∞ ~187)
2. –í `awardLoyaltyPoints` (—Å—Ç—Ä–æ–∫–∞ ~280)

**–ù–û!** –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ù–æ–≤—ã–π –±–ª–æ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: `existingPointsUsed === 0`
- –ï—Å–ª–∏ –±–∞–ª–ª—ã —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

**–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê (–µ—Å–ª–∏ –±—É–¥—É—Ç –ø—Ä–æ–±–ª–µ–º—ã):**
–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `pointsUsed` –≤ `awardLoyaltyPoints` —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—ã, –∞ –¥–ª—è cash - 0.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: Cash + –±–∞–ª–ª—ã (–ø—Ä–æ–±–ª–µ–º–∞ –∏–∑ –ª–æ–≥–∞)

1. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ –Ω–∞ 2,815‚ÇΩ
2. –í—ã–±–µ—Ä–∏ "–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏"
3. –ò—Å–ø–æ–ª—å–∑—É–π 48 –±–∞–ª–ª–æ–≤
4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –∑–∞–∫–∞–∑

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ Order: `loyalty_points_used: 48`
- ‚úÖ User balance: 96 ‚Üí 48
- ‚úÖ Transaction —Å–æ–∑–¥–∞–Ω–∞: `type: "used", points: -48`

---

### –¢–µ—Å—Ç 2: Card + –±–∞–ª–ª—ã

1. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ –Ω–∞ 3,000‚ÇΩ
2. –ò—Å–ø–æ–ª—å–∑—É–π 50 –±–∞–ª–ª–æ–≤
3. –û–ø–ª–∞—Ç–∏ –∫–∞—Ä—Ç–æ–π

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã: -50
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã: +150 (–∑–∞ 3000‚ÇΩ)
- ‚úÖ –ò—Ç–æ–≥–æ: 96 - 50 + 150 = 196

---

### –¢–µ—Å—Ç 3: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π PATCH (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π)

1. –°–æ–∑–¥–∞–π –∑–∞–∫–∞–∑ —Å –±–∞–ª–ª–∞–º–∏
2. PATCH #1: –±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
3. PATCH #2: —Ç–æ—Ç –∂–µ –∑–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
- ‚úÖ PATCH #1: –±–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã
- ‚úÖ PATCH #2: `existingPointsUsed > 0` ‚Üí –±–∞–ª–ª—ã –ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- ‚úÖ `app/api/orders/[id]/route.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–æ **2 –±–ª–æ–∫–∞** —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤:
  - –°—Ç—Ä–æ–∫–∏ ~186-245: Full Order Update
  - –°—Ç—Ä–æ–∫–∏ ~614-683: Partial Update (~70 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥—ã–π)

---

## ‚úÖ –ò–¢–û–ì

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–ª–ª—ã –Ω–µ —Å–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –¥–ª—è cash-–∑–∞–∫–∞–∑–æ–≤ –≤ PATCH  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ —Å–ø–∏—Å–∞–Ω–∏—è, –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã  
**–ó–∞—â–∏—Ç–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `existingPointsUsed` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ  
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã (card, sbp, cash)  

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

**–ü—Ä–æ–≤–µ—Ä—å:** –°–æ–∑–¥–∞–π cash-–∑–∞–∫–∞–∑ + –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–ª–ª—ã ‚Üí –±–∞–ª–ª—ã –¥–æ–ª–∂–Ω—ã —Å–ø–∏—Å–∞—Ç—å—Å—è!

