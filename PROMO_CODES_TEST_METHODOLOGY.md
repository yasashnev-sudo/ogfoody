# Методика тестирования промокодов

## Обзор

Данная методика описывает процесс тестирования функциональности промокодов в системе OGFooDY. Тесты проверяют:
1. Создание промокодов
2. Сохранение промокодов в заказах
3. Загрузку и маппинг промокодов
4. Обновление промокодов в заказах
5. Статистику промокодов

## Тестовый скрипт

### `test-promo-codes-production.sh`

Скрипт для тестирования на продакшене через API.

**Запуск:**
```bash
bash test-promo-codes-production.sh
```

**Что тестирует:**

1. **Создание промокода**
   - Создает тестовый промокод через API `/api/db/Promo_Codes/records`
   - Проверяет успешное создание

2. **Обновление заказа с промокодом**
   - Находит неоплаченный заказ или создает новый
   - Обновляет заказ с промокодом через API `/api/orders/{id}`
   - Проверяет успешное обновление

3. **Проверка загрузки и маппинга**
   - Загружает заказ через API `/api/db/Orders/records/{id}`
   - Проверяет, что промокод правильно сохранен в обоих форматах:
     - `Promo Code` / `promo_code`
     - `Promo Discount` / `promo_discount`

4. **Повторное обновление**
   - Обновляет промокод с новым значением скидки
   - Проверяет, что изменения сохранились

5. **Статистика**
   - Загружает все заказы
   - Подсчитывает количество заказов с промокодами
   - Проверяет корректность подсчета

6. **Очистка**
   - Удаляет тестовый промокод
   - Удаляет промокод из заказа (восстанавливает исходное состояние)

## Результаты тестирования

### Последний запуск (2026-01-15)

```
✅ Тест 1: Создание промокода - УСПЕШНО
✅ Тест 2: Обновление заказа с промокодом - УСПЕШНО
✅ Тест 3: Проверка загрузки и маппинга - УСПЕШНО
   - Промокод правильно сохранен: TEST-1768494292, скидка: 100
✅ Тест 4: Повторное обновление - УСПЕШНО
   - Промокод правильно обновлен, новая скидка: 200
✅ Тест 5: Статистика - УСПЕШНО
   - Найдено заказов с промокодом: 70
```

## Проверенные сценарии

### ✅ Сценарий 1: Создание промокода
- **Действие**: Создание нового промокода через API
- **Ожидаемый результат**: Промокод создан с уникальным ID
- **Статус**: ✅ Работает

### ✅ Сценарий 2: Сохранение промокода в заказе
- **Действие**: Обновление существующего заказа с промокодом
- **Ожидаемый результат**: Промокод и скидка сохраняются в заказе
- **Статус**: ✅ Работает

### ✅ Сценарий 3: Загрузка промокода из заказа
- **Действие**: Загрузка заказа через API
- **Ожидаемый результат**: Промокод доступен в обоих форматах (Title Case и snake_case)
- **Статус**: ✅ Работает

### ✅ Сценарий 4: Обновление промокода в заказе
- **Действие**: Изменение скидки промокода в существующем заказе
- **Ожидаемый результат**: Новое значение скидки сохраняется
- **Статус**: ✅ Работает

### ✅ Сценарий 5: Статистика промокодов
- **Действие**: Подсчет заказов с промокодами
- **Ожидаемый результат**: Корректный подсчет количества заказов с промокодами
- **Статус**: ✅ Работает (найдено 70 заказов)

## Известные проблемы

### ❌ Проблема 1: Редактирование оплаченных заказов
- **Описание**: Оплаченные заказы нельзя редактировать
- **Решение**: Тест использует только неоплаченные заказы или создает новые
- **Статус**: ✅ Решено в тесте

### ⚠️ Проблема 2: Конфликты дат при создании заказов
- **Описание**: Нельзя создать заказ на дату, если уже есть активный заказ
- **Решение**: Тест ищет неоплаченные заказы или использует дату через 30 дней
- **Статус**: ✅ Решено в тесте

## Рекомендации

1. **Регулярное тестирование**: Запускать тест после каждого изменения в логике промокодов
2. **Мониторинг статистики**: Отслеживать количество заказов с промокодами
3. **Проверка маппинга**: Убедиться, что промокоды правильно маппятся при загрузке из разных источников

## Автоматизация

Тест можно интегрировать в CI/CD pipeline:

```bash
# В GitHub Actions или другом CI/CD
- name: Test Promo Codes
  run: bash test-promo-codes-production.sh
```

## Дополнительные тесты

Для более полного покрытия можно добавить:

1. **Тест применения промокода при создании нового заказа**
2. **Тест валидации промокода (даты, лимиты)**
3. **Тест расчета скидки (процентная/фиксированная)**
4. **Тест отображения промокода в UI компонентах**

## Заключение

Все основные сценарии работы с промокодами протестированы и работают корректно. Система правильно:
- Сохраняет промокоды в заказах
- Загружает промокоды из базы данных
- Маппит промокоды в разных форматах
- Обновляет промокоды в существующих заказах
- Подсчитывает статистику промокодов
