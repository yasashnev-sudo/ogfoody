# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
**–î–∞—Ç–∞:** 10.01.2026  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –≥–æ—Å—Ç–µ–º —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã
–ò–∑ –ª–æ–≥–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (–∑–∞–∫–∞–∑ #391, userId=30):
```
‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω –≤ –ë–î —Å ID: 391
üí≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã: –º–µ—Ç–æ–¥=cash, –±–∞–ª–ª—ã=0
üí∞ –û—Ç–≤–µ—Ç –æ—Ç API –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: Object
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª–∏–ª–∏—Å—å –Ω–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞, –Ω–∏ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ.

### –ü—Ä–∏—á–∏–Ω—ã

#### 1Ô∏è‚É£ **POST /api/orders** (—Å—Ç—Ä–æ–∫–∏ 444-547)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `orderTotal = calculatedTotal` (subtotal –ë–ï–ó –¥–æ—Å—Ç–∞–≤–∫–∏)
- `calculatedTotal` –º–æ–≥ –±—ã—Ç—å 0 –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –≤ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `finalTotal` –≤ –ë–î

```typescript
// ‚ùå –ë–´–õ–û:
const orderTotal = calculatedTotal  // subtotal –±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏

// ‚úÖ –°–¢–ê–õ–û:
const orderTotal = nocoOrder.total || finalTotal || calculatedTotal
```

#### 2Ô∏è‚É£ **PATCH /api/orders/[id]** (—Å—Ç—Ä–æ–∫–∏ 547-608)
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –ù–µ –¥–æ–±–∞–≤–ª—è–ª—Å—è `delivery_fee` –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ `orderTotal` –∏–∑ subtotal
- –ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `orderTotal <= 0` –ø–µ—Ä–µ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. POST /api/orders (—Å—Ç—Ä–æ–∫–∏ 444-460)

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ–º `finalTotal` (—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π) –≤–º–µ—Å—Ç–æ `calculatedTotal`:

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º finalTotal (—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π) –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –≤ –ë–î
// nocoOrder.total –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω –≤ —Å—Ç—Ä–æ–∫–∞—Ö 434-438 –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ finalTotal
const orderTotal = nocoOrder.total || finalTotal || calculatedTotal

console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:`, {
  hasUserId: !!userId,
  userId: userId,
  calculatedTotal,    // subtotal
  deliveryFee,
  finalTotal,         // total —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
  'nocoOrder.total': nocoOrder.total,
  orderTotal,         // —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±–∞–ª–ª–æ–≤
})
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –ø–æ–ª–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ (subtotal + delivery_fee)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ë–î –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- Fallback –Ω–∞ `finalTotal` –∏ `calculatedTotal` –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏

---

### 2. PATCH /api/orders/[id] (—Å—Ç—Ä–æ–∫–∏ 547-625)

#### 2.1 –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π

```typescript
console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ ${id}:`, {
  wasPaid,
  willBePaid,
  'currentOrder.user_id': currentOrder.user_id,
  pendingPointsEarned,
  condition: !wasPaid && willBePaid && currentOrder.user_id && pendingPointsEarned === 0
})
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –ú–æ–∂–µ–º –≤–∏–¥–µ—Ç—å, –ø–æ—á–µ–º—É –±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è.

---

#### 2.2 –£–ª—É—á—à–µ–Ω —Ä–∞—Å—á–µ—Ç orderTotal

```typescript
// ‚úÖ –£–õ–£–ß–®–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω delivery_fee –ø—Ä–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–µ –∏–∑ subtotal
if (orderTotal === 0) {
  const subtotal = /* ... –ø–æ–ª—É—á–µ–Ω–∏–µ subtotal ... */
  const deliveryFee = /* ... –ø–æ–ª—É—á–µ–Ω–∏–µ delivery_fee ... */
  
  if (subtotal > 0) {
    const promoDiscount = /* ... */
    orderTotal = subtotal + deliveryFee - promoDiscount  // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω deliveryFee
    console.log(`‚ÑπÔ∏è Total –±—ã–ª 0, –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –∏–∑ subtotal + delivery_fee: ${subtotal} + ${deliveryFee} - ${promoDiscount} = ${orderTotal}`)
  }
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:** 
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—É–º–º—ã –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤
- –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏

---

#### 2.3 –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ orderTotal –ø–µ—Ä–µ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

```typescript
// ‚úÖ –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ orderTotal –≤—Å–µ –µ—â–µ 0, –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã
if (orderTotal <= 0) {
  console.warn(`‚ö†Ô∏è PATCH ${id}: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å –±–∞–ª–ª—ã - orderTotal = ${orderTotal}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –≤ –ë–î!`)
} else {
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã
  const loyaltyPointsEarned = calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)
  
  console.log(`üí∞ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ ${loyaltyPointsEarned} –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ ${id}`)
  
  if (loyaltyPointsEarned > 0) {
    await awardLoyaltyPoints(currentOrder.user_id, orderTotal, pointsUsed, loyaltyPointsEarned, Number(id))
    updateData.loyalty_points_earned = loyaltyPointsEarned
    console.log(`‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ ${loyaltyPointsEarned} –±–∞–ª–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${currentOrder.user_id}`)
  }
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ —Å –Ω—É–ª–µ–≤–æ–π —Å—É–º–º–æ–π
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

---

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ POST (—Å—Ç—Ä–æ–∫–∞ 223)

```typescript
console.log(`üìä –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞, –ø–µ—Ä—Å–æ–Ω: ${order.persons?.length || 0}`)
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –ú–æ–∂–µ–º –≤–∏–¥–µ—Ç—å, —Å–∫–æ–ª—å–∫–æ persons –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è.

---

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ì–æ—Å—Ç—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ ‚Üí –ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è ‚Üí –û–ø–ª–∞—á–∏–≤–∞–µ—Ç

1. **–ì–æ—Å—Ç—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑** (localStorage, –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
2. **–ù–∞–∂–∏–º–∞–µ—Ç "–ó–∞–∫–∞–∑–∞—Ç—å"** ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è AuthModal
3. **–ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è** ‚Üí –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î (userId=30)
4. **–ó–∞–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å** ‚Üí ProfileModal
5. **–ê–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ** (`handleAutoCheckout`):
   - POST `/api/orders` —Å `userId=30`
   - `paymentMethod` = undefined ‚Üí default "cash"
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `calculatedTotal` (—Å—É–º–º–∞ –±–ª—é–¥)
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `finalTotal` = `calculatedTotal` + `deliveryFee`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–∫–∞–∑ –≤ –ë–î —Å `finalTotal`
   - **‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤:**
     - `orderTotal` = `nocoOrder.total` (—É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω —Å `finalTotal`)
     - –ï—Å–ª–∏ `paymentMethod === 'cash'` ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è **pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è**
     - –ë–∞–ª–ª—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏
6. **–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è PaymentModal**
7. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å –Ω–∞–ª–∏—á–Ω—ã–º–∏"**:
   - PATCH `/api/orders/391` —Å `paid: true, payment_method: 'cash'`
   - **–õ–æ–≥–∏–∫–∞:** pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
   - –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—Ç—Å—è —á–µ—Ä–µ–∑ cron job

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞ (–∫–∞—Ä—Ç–∞/–°–ë–ü)

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Ä—Ç—É/–°–ë–ü:
1. POST —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —Å `paymentMethod: 'card'`
2. **‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –°–†–ê–ó–£** (–Ω–µ pending)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ (–æ—à–∏–±–∫–∞)

–ï—Å–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (POST) –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∏ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å:

1. PATCH –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: `pendingPointsEarned === 0`
2. **‚úÖ –ù–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ** —á–µ—Ä–µ–∑ `awardLoyaltyPoints()`
3. –ì–∞—Ä–∞–Ω—Ç–∏—è: –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—Ç—Å—è –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≥–æ—Å—Ç–µ–º

```bash
# 1. –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ —Ä–µ–∂–∏–º–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
# 2. –í—ã–±—Ä–∞—Ç—å —Ä–∞–π–æ–Ω
# 3. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ (–¥–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–∞)
# 4. –ù–∞–∂–∞—Ç—å "–ó–∞–∫–∞–∑–∞—Ç—å"
# 5. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –ø–æ SMS
# 6. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
# 7. –í—ã–±—Ä–∞—Ç—å "–û–ø–ª–∞—Ç–∏—Ç—å –Ω–∞–ª–∏—á–Ω—ã–º–∏"
# 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ POST:**
```
üìä –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞, –ø–µ—Ä—Å–æ–Ω: 1
üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: 3509‚ÇΩ + 0‚ÇΩ (–¥–æ—Å—Ç–∞–≤–∫–∞) = 3509‚ÇΩ
‚úÖ Updated order 391 with total: 3509‚ÇΩ
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:
  calculatedTotal: 3509
  deliveryFee: 0
  finalTotal: 3509
  nocoOrder.total: 3509
  orderTotal: 3509
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: userId=30
üí∞ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤: 105  (3% –æ—Ç 3509)
üíµ –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏: —Å–æ–∑–¥–∞–Ω–∏–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚è≥ Pending: 105 –±–∞–ª–ª–æ–≤ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ PATCH:**
```
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ 391:
  wasPaid: false
  willBePaid: true
  currentOrder.user_id: 30
  pendingPointsEarned: 0
  condition: true
üí∞ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ 391:
  currentOrder.total: 3509
  orderTotal: 3509
üí∞ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ 105 –±–∞–ª–ª–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ 391
‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ 105 –±–∞–ª–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 30
```

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

1. **Orders:** `loyalty_points_earned` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 105
2. **Loyalty_Points_Transactions:**
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å `transaction_type: 'earned'`
   - `transaction_status: 'pending'` (–µ—Å–ª–∏ cash)
   - `points: 105`
   - `order_id: 391`
3. **Users:** `loyalty_points` –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ cron job

---

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `app/api/orders/route.ts` (POST)
- `app/api/orders/[id]/route.ts` (PATCH)
- `lib/nocodb.ts` (awardLoyaltyPoints, createPendingLoyaltyPoints)
- `app/api/cron/process-pending-points/route.ts` (–æ–±—Ä–∞–±–æ—Ç–∫–∞ pending)

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Å –ø–æ–ª–Ω–æ–π —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞** (subtotal + delivery_fee)
2. **–î–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö:** –±–∞–ª–ª—ã pending, –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24—á –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏
3. **–î–ª—è –∫–∞—Ä—Ç—ã/–°–ë–ü:** –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É
4. **Fallback:** –µ—Å–ª–∏ pending –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å –ø—Ä–∏ POST, –±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—Ç—Å—è –ø—Ä–∏ PATCH
5. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞:** 1000‚ÇΩ (–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

---

## üîß –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **10.01.2026 22:00:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `finalTotal` –≤ POST
- **10.01.2026 22:15:** –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ PATCH —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **10.01.2026 22:30:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è



