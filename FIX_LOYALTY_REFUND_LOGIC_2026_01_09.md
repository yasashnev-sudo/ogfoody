# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –õ–æ–≥–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞

**–î–∞—Ç–∞**: 2026-01-09  
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –±–∞–ª–ª—ã **—É–≤–µ–ª–∏—á–∏–≤–∞–ª–∏—Å—å** –≤–º–µ—Å—Ç–æ —É–º–µ–Ω—å—à–µ–Ω–∏—è

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–≤–µ–ª–∏—á–∏–ª–∏—Å—å —Å 397 –¥–æ 491 (+94), —Ö–æ—Ç—è –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å—Å—è –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤.

## –ü—Ä–∏—á–∏–Ω–∞

–í —Ñ—É–Ω–∫—Ü–∏–∏ `refundLoyaltyPoints` –±—ã–ª–æ **–¥–≤–æ–π–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –±–∞–ª–∞–Ω—Å–∞:

1. **–ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: `updateUser` –Ω–∞–ø—Ä—è–º—É—é –∑–∞–ø–∏—Å—ã–≤–∞–ª `newBalance` –≤ —Ç–∞–±–ª–∏—Ü—É Users
2. **–í—Ç–æ—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: `fetchUserById` –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–ª –±–∞–ª–∞–Ω—Å –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª** –µ–≥–æ –≤ —Ç–∞–±–ª–∏—Ü—É Users

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ race condition –∏ –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º.

## –†–µ—à–µ–Ω–∏–µ

### 1. –£–¥–∞–ª–µ–Ω–æ –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –≤ `refundLoyaltyPoints`

**–î–û**:
```typescript
// –û–±–Ω–æ–≤–ª—è–µ–º loyalty_points –≤ —Ç–∞–±–ª–∏—Ü–µ Users
const newBalance = currentBalance + pointsUsed - pointsEarned
await updateUser(userId, {
  loyalty_points: newBalance,  // ‚ùå –ü—Ä—è–º–∞—è –∑–∞–ø–∏—Å—å
  updated_at: now,
})
```

**–ü–û–°–õ–ï**:
```typescript
// ‚úÖ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º loyalty_points –Ω–∞–ø—Ä—è–º—É—é!
// –ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ calculateUserBalance
console.log(`üí≥ refundLoyaltyPoints - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã:`, {
  userId,
  orderId,
  pointsUsed: pointsUsed > 0 ? `+${pointsUsed}` : 0,
  pointsEarned: pointsEarned > 0 ? `-${pointsEarned}` : 0,
  explanation: `–ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º fetchUserById`,
})
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

–î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

```typescript
console.log(`üìù –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é "refunded": points=+${pointsUsed}`)
const refundedTransaction = await createLoyaltyPointsTransaction(...)
console.log(`‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è "refunded" —Å–æ–∑–¥–∞–Ω–∞:`, {
  Id: refundedTransaction.Id,
  points: refundedTransaction.points,
  type: refundedTransaction.transaction_type,
  status: refundedTransaction.transaction_status,
})
```

## –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

**–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã (Single Source of Truth)**: –ë–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–≤—Å–µ–≥–¥–∞** –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ `calculateUserBalance`.

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:

1. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (earned/used/refunded/cancelled) –≤ —Ç–∞–±–ª–∏—Ü–µ `Loyalty_Points_Transactions`
2. –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–∞–ª–∞–Ω—Å–∞ `fetchUserById` –≤—ã–∑—ã–≤–∞–µ—Ç `calculateUserBalance`
3. `calculateUserBalance` —Å—É–º–º–∏—Ä—É–µ—Ç –≤—Å–µ completed —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
4. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ `user.loyalty_points`

### –ü–æ–ª–µ `loyalty_points` –≤ —Ç–∞–±–ª–∏—Ü–µ Users:

- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** `fetchUserById` –∫–∞–∫ –∫—ç—à –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–ù–û –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ `noCache=true`)
- **–ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é** –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å –±–∞–ª–ª–∞–º–∏
- **–í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º `calculateUserBalance`

## –¢–∏–ø—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞

### –û–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:

- `refunded`: +pointsUsed (–µ—Å–ª–∏ –±—ã–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –±–∞–ª–ª—ã)
- `cancelled`: -pointsEarned (—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤)

### –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑:

- Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è: `transaction_status: "cancelled"`

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `lib/nocodb.ts`: –§—É–Ω–∫—Ü–∏—è `refundLoyaltyPoints` (—Å—Ç—Ä–æ–∫–∏ ~1171-1200)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û—Ç–º–µ–Ω–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ (–∫–∞—Ä—Ç–æ–π/–°–ë–ü)

1. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –æ–ø–ª–∞—Ç–æ–π –∫–∞—Ä—Ç–æ–π (–±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –¥–æ –æ—Ç–º–µ–Ω—ã
3. –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –ë–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–∏–ª—Å—è –Ω–∞ `loyalty_points_earned`
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î**: –ï—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è type="cancelled", status="completed", points=-X

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏

1. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤ (–±–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è)
2. –û–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π (–±–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è)
3. –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: 
   - –ë–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã (+pointsUsed)
   - –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Å–ø–∏—Å–∞–Ω—ã (-pointsEarned)
   - –ò—Ç–æ–≥–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: +pointsUsed - pointsEarned

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—Ç–º–µ–Ω–∞ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ (–Ω–∞–ª–∏—á–Ω—ã–µ)

1. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –æ–ø–ª–∞—Ç–æ–π –Ω–∞–ª–∏—á–Ω—ã–º–∏ (pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)
2. –ù–ï –æ–ø–ª–∞—á–∏–≤–∞—Ç—å
3. –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞: status="cancelled"

## –í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏—è `awardLoyaltyPoints` –∏ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å –±–∞–ª–ª–∞–º–∏, —Ç–∞–∫–∂–µ –ù–ï –¥–æ–ª–∂–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –æ–±–Ω–æ–≤–ª—è—Ç—å `loyalty_points` –≤ —Ç–∞–±–ª–∏—Ü–µ Users. –ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
- ‚úÖ `refundLoyaltyPoints` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚ö†Ô∏è `awardLoyaltyPoints` - —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚ö†Ô∏è `processPendingTransactionsForOrder` - —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–æ–≤
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `Loyalty_Points_Transactions` –≤ NocoDB
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª–µ `points` –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è



