# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Systemd Timer –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–∞–ª–ª–æ–≤ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

Systemd Timer –∑–∞–º–µ–Ω—è–µ—Ç Vercel Cron –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±–∞–ª–ª–æ–≤ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Systemd Timer:**
- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω –≤ Linux, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ journalctl
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ (Persistent=true)
- ‚úÖ –¢–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ (15:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å)
- ‚úÖ –õ–µ–≥–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ systemctl

## üéØ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

**–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ **15:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏** (12:00 UTC)

**–ß—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è:**
- –ó–∞–∫–∞–∑—ã —Å –æ–ø–ª–∞—Ç–æ–π –Ω–∞–ª–∏—á–Ω—ã–º–∏ (`payment_method === "cash"`)
- –° –¥–∞—Ç–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ = **—Å–µ–≥–æ–¥–Ω—è** (–Ω–µ –≤—á–µ—Ä–∞!)
- –°–æ —Å—Ç–∞—Ç—É—Å–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ = `pending`
- –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ = `earned`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –≤ —Å—Ç–∞—Ç—É—Å `completed`
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/ogfoody
git pull
```

### –®–∞–≥ 2: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏

```bash
sudo bash scripts/install-systemd-timer.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –°–∫–æ–ø–∏—Ä—É–µ—Ç systemd —Ñ–∞–π–ª—ã –≤ `/etc/systemd/system/`
- –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç systemd daemon
- –í–∫–ª—é—á–∏—Ç –∏ –∑–∞–ø—É—Å—Ç–∏—Ç timer

---

## üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ timer

```bash
systemctl status ogfoody-loyalty-points.timer
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞

```bash
systemctl list-timers ogfoody-loyalty-points.timer
```

### –õ–æ–≥–∏ service (–æ–±—Ä–∞–±–æ—Ç–∫–∏)

```bash
# –í—Å–µ –ª–æ–≥–∏
journalctl -u ogfoody-loyalty-points.service

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫
journalctl -u ogfoody-loyalty-points.service -n 100

# –í —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
journalctl -u ogfoody-loyalty-points.service -f

# –õ–æ–≥–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
journalctl -u ogfoody-loyalty-points.service --since today
```

### –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
systemctl start ogfoody-loyalty-points.service

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
journalctl -u ogfoody-loyalty-points.service -n 50
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ timer

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å timer (–Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
systemctl stop ogfoody-loyalty-points.timer

# –ó–∞–ø—É—Å—Ç–∏—Ç—å timer
systemctl start ogfoody-loyalty-points.timer

# –û—Ç–∫–ª—é—á–∏—Ç—å timer (–Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
systemctl disable ogfoody-loyalty-points.timer

# –í–∫–ª—é—á–∏—Ç—å timer (–±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
systemctl enable ogfoody-loyalty-points.timer

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å timer (–ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
systemctl daemon-reload
systemctl restart ogfoody-loyalty-points.timer
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—Å–∫–∞

**–í–ê–ñ–ù–û:** Systemd –∏—Å–ø–æ–ª—å–∑—É–µ—Ç UTC –≤—Ä–µ–º—è! –î–ª—è –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω—É–∂–Ω–æ –≤—ã—á–∏—Ç–∞—Ç—å 3 —á–∞—Å–∞.

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `/etc/systemd/system/ogfoody-loyalty-points.timer`:

```ini
[Timer]
# –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ 16:00 –ø–æ –ú–æ—Å–∫–≤–µ = 13:00 UTC
OnCalendar=*-*-* 13:00:00
```

–ó–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ:
```bash
systemctl daemon-reload
systemctl restart ogfoody-loyalty-points.timer
```

### –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π (UTC –≤—Ä–µ–º—è)

```ini
# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 15:00 –ø–æ –ú–æ—Å–∫–≤–µ = 12:00 UTC
OnCalendar=*-*-* 12:00:00

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 14:30 –ø–æ –ú–æ—Å–∫–≤–µ = 11:30 UTC
OnCalendar=*-*-* 11:30:00

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00 –∏ 18:00 –ø–æ –ú–æ—Å–∫–≤–µ = 07:00 –∏ 15:00 UTC
OnCalendar=*-*-* 07:00:00
OnCalendar=*-*-* 15:00:00

# –¢–æ–ª—å–∫–æ –≤ –±—É–¥–Ω–∏–µ –¥–Ω–∏ –≤ 15:00 –ø–æ –ú–æ—Å–∫–≤–µ = 12:00 UTC
OnCalendar=Mon..Fri 12:00:00
```

**–§–æ—Ä–º—É–ª–∞:** UTC –≤—Ä–µ–º—è = –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è - 3 —á–∞—Å–∞

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ timer –∞–∫—Ç–∏–≤–µ–Ω

```bash
systemctl is-active ogfoody-loyalty-points.timer
# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: active
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ timer –≤–∫–ª—é—á–µ–Ω

```bash
systemctl is-enabled ogfoody-loyalty-points.timer
# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: enabled
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏ —Å—Ä–∞–∑—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
systemctl start ogfoody-loyalty-points.service && \
journalctl -u ogfoody-loyalty-points.service -n 50 --no-pager
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API

```bash
curl -X GET http://localhost:3000/api/cron/process-pending-points \
  -H "Content-Type: application/json"
```

---

## üìù –§–∞–π–ª—ã

### Service —Ñ–∞–π–ª
`/etc/systemd/system/ogfoody-loyalty-points.service`

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ timer.

### Timer —Ñ–∞–π–ª
`/etc/systemd/system/ogfoody-loyalty-points.timer`

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞.

### –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ
- `systemd/ogfoody-loyalty-points.service`
- `systemd/ogfoody-loyalty-points.timer`
- `scripts/install-systemd-timer.sh`

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:** Timer –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 15:00 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (12:00 UTC) –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –±—ã–ª –≤—ã–∫–ª—é—á–µ–Ω, timer –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (–±–ª–∞–≥–æ–¥–∞—Ä—è `Persistent=true`).

2. **–¢–æ—á–Ω–æ—Å—Ç—å:** Timer –∏–º–µ–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å 1 –º–∏–Ω—É—Ç—É (`AccuracySec=1m`), –ø–æ—ç—Ç–æ–º—É –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –≤ 12:00:00-12:00:59 UTC (15:00:00-15:00:59 –ú–°–ö).

3. **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:** Systemd –∏—Å–ø–æ–ª—å–∑—É–µ—Ç UTC –≤—Ä–µ–º—è. –î–ª—è –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (UTC+3) –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ 12:00 UTC, —á—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 15:00 –ú–°–ö.

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –ª–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ systemd journal –∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ `journalctl`.

4. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** Service —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ `http://localhost:3000`.

5. **–¢–∞–π–º–∞—É—Ç:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–µ—Ç —Ç–∞–π–º–∞—É—Ç 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç). –ï—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –æ–Ω–∞ –±—É–¥–µ—Ç –ø—Ä–µ—Ä–≤–∞–Ω–∞.

---

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å Vercel Cron

–ï—Å–ª–∏ —Ä–∞–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è Vercel Cron (—á–µ—Ä–µ–∑ `vercel.json`):

1. –£–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ cron –≤ `vercel.json`:
```json
{
  "crons": []
}
```

2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ systemd timer (—Å–º. —Ä–∞–∑–¥–µ–ª "–£—Å—Ç–∞–Ω–æ–≤–∫–∞")

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ timer —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
systemctl status ogfoody-loyalty-points.timer
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `journalctl -u ogfoody-loyalty-points.service -n 100`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å timer: `systemctl status ogfoody-loyalty-points.timer`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API: `curl http://localhost:3000/api/cron/process-pending-points`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ: `pm2 status`

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-01-16
