# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ

**–î–∞—Ç–∞:** 2026-01-11  
**–§–∞–π–ª—ã:** `app/api/orders/[id]/route.ts`

---

## üêõ –ü–†–û–ë–õ–ï–ú–ê

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã —Å `cash` –Ω–∞ `card`, –∑–∞–∫–∞–∑ –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ.

### –°–∏–º–ø—Ç–æ–º—ã:

```javascript
// –õ–û–ì 1 (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞):
üìÖ –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ: [
  {
    "id": 520,
    "orderNumber": "ORD-20260111-PVW7TC",
    "startDate": "2026-01-12"  // ‚úÖ –î–∞—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è
  }
]

// –õ–û–ì 2 (–ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã):
üìÖ –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ: [
  {
    "id": 520,
    "orderNumber": "ORD-20260111-PVW7TC",
    "startDate": "2026-01-11T21:00:00.000Z"  // ‚ùå –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO timestamp!
  }
]
```

---

## üîç –ü–†–ò–ß–ò–ù–ê

NocoDB –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–µ `start_date` –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: `"2026-01-12"` (—Å—Ç—Ä–æ–∫–∞ YYYY-MM-DD)
- –ü–æ—Å–ª–µ partial update: `"2026-01-11T21:00:00.000Z"` (ISO timestamp)

–•–æ—Ç—è —Ñ—É–Ω–∫—Ü–∏—è `toDate()` –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ —É–º–µ–µ—Ç –ø–∞—Ä—Å–∏—Ç—å –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞, –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ:
1. –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –¥–∞—Ç—ã –ø–æ timestamp (setHours(0,0,0,0))
2. ISO timestamp `"2026-01-11T21:00:00.000Z"` –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ UTC –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `2026-01-12` –ø–æ –º–µ—Å—Ç–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ (MSK = UTC+3)
3. –ù–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–¥—ë—Ç —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –¥–Ω—ë–º –∏–∑-–∑–∞ timezone —Ä–∞–∑–Ω–∏—Ü—ã

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ `start_date` –≤ API –æ—Ç–≤–µ—Ç–µ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `app/api/orders/[id]/route.ts`:

#### 1. Full Order Update (—Å—Ç—Ä–æ–∫–∏ ~539-568)

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û 2026-01-11: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç start_date –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
const normalizeStartDate = (date: any): string => {
  if (!date) return ""
  if (typeof date === "string") {
    // –ï—Å–ª–∏ —ç—Ç–æ ISO timestamp, –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É
    if (date.includes("T")) {
      return date.split("T")[0]
    }
    // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    return date
  }
  // –ï—Å–ª–∏ —ç—Ç–æ Date –æ–±—ä–µ–∫—Ç
  if (date instanceof Date) {
    return date.toISOString().split("T")[0]
  }
  return String(date)
}

const mergedOrder = {
  ...updatedOrder,
  loyalty_points_used: order.loyaltyPointsUsed !== undefined 
    ? order.loyaltyPointsUsed 
    : updatedOrder.loyalty_points_used,
  loyalty_points_earned: loyaltyPointsEarned !== undefined
    ? loyaltyPointsEarned
    : updatedOrder.loyalty_points_earned,
  // ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º start_date –∫ —Ñ–æ—Ä–º–∞—Ç—É YYYY-MM-DD
  start_date: normalizeStartDate(updatedOrder.start_date || (updatedOrder as any)["Start Date"]),
}
```

#### 2. Partial Update (—Å—Ç—Ä–æ–∫–∏ ~972-1001)

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û 2026-01-11: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç start_date –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
const normalizeStartDate = (date: any): string => {
  if (!date) return ""
  if (typeof date === "string") {
    // –ï—Å–ª–∏ —ç—Ç–æ ISO timestamp, –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É
    if (date.includes("T")) {
      return date.split("T")[0]
    }
    // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    return date
  }
  // –ï—Å–ª–∏ —ç—Ç–æ Date –æ–±—ä–µ–∫—Ç
  if (date instanceof Date) {
    return date.toISOString().split("T")[0]
  }
  return String(date)
}

const mergedOrder = {
  ...fullOrder,
  ...(updateData.loyalty_points_used !== undefined && { 
    loyalty_points_used: updateData.loyalty_points_used 
  }),
  ...(updateData.loyalty_points_earned !== undefined && { 
    loyalty_points_earned: updateData.loyalty_points_earned 
  }),
  // ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º start_date –∫ —Ñ–æ—Ä–º–∞—Ç—É YYYY-MM-DD
  start_date: normalizeStartDate(fullOrder.start_date || (fullOrder as any)["Start Date"]),
}
```

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

–¢–µ–ø–µ—Ä—å API **–í–°–ï–ì–î–ê** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `start_date` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `YYYY-MM-DD`:

```javascript
{
  "order": {
    "start_date": "2026-01-12",  // ‚úÖ –í—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∞ YYYY-MM-DD
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  }
}
```

–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ –∑–∞–∫–∞–∑—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.

---

## üìã –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –º–µ—Ç–æ–¥–æ–º –æ–ø–ª–∞—Ç—ã `cash`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–∫–∞–∑ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
3. ‚úÖ `startDate` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ `YYYY-MM-DD`

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–º–µ–Ω–∞ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç—É
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å –º–µ—Ç–æ–¥–æ–º –æ–ø–ª–∞—Ç—ã `cash`
2. –ò–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã –Ω–∞ `card`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–∫–∞–∑ –≤—Å—ë –µ—â—ë –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
4. ‚úÖ `startDate` –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `YYYY-MM-DD`

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
1. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
2. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑ —Å –Ω–æ–≤—ã–º–∏ –±–ª—é–¥–∞–º–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–∫–∞–∑ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
4. ‚úÖ `startDate` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ `YYYY-MM-DD`

---

## üîÑ –°–í–Ø–ó–ê–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

- ‚úÖ `FIX_LOYALTY_POINTS_DEDUCTION_CASH_2026_01_11.md` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö
- ‚úÖ `FIX_DOUBLE_DEDUCTION_PROTECTION_2026_01_11.md` - –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
- ‚úÖ `FIX_LOYALTY_POINTS_USED_RESPONSE_2026_01_11.md` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `loyalty_points_used` –≤ –æ—Ç–≤–µ—Ç–µ
- ‚úÖ `FIX_DOUBLE_DEDUCTION_PARTIAL_UPDATE_2026_01_11.md` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è –≤ partial update

---

## ‚úÖ –°–¢–ê–¢–£–°

**–ò–°–ü–†–ê–í–õ–ï–ù–û** - –ó–∞–∫–∞–∑—ã —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–∏–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.


