# üêõ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

**–î–∞—Ç–∞:** 13.01.2026  
**–û—Ç—á–µ—Ç:** `2026-01-13T15-23-42-783Z_user-121_logs.txt`  
**User ID:** 121  
**Order ID:** 546

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –±–∞–≥–∞

–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–ª –±–∞–ª–ª—ã –¥–≤–∞–∂–¥—ã:
1. **–ü–µ—Ä–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
2. **–í—Ç–æ—Ä–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞ (–æ—à–∏–±–æ—á–Ω–æ)

### –ü—Ä–∏–º–µ—Ä –∏–∑ –±–∞–≥–∞:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **51 –±–∞–ª–ª** –¥–ª—è —Å–∫–∏–¥–∫–∏
- –î–æ–ª–∂–Ω–æ –±—ã–ª–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å—Å—è **95 –±–∞–ª–ª–æ–≤** –∑–∞ –∑–∞–∫–∞–∑ –Ω–∞ 3181‚ÇΩ
- **–û–∂–∏–¥–∞–ª–æ—Å—å:** –ï—Å–ª–∏ –±—ã–ª–æ 95 –±–∞–ª–ª–æ–≤ ‚Üí 95 - 51 + 95 = **139 –±–∞–ª–ª–æ–≤**
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–∏:** 95 - 51 - 51 + 95 = **88 –±–∞–ª–ª–æ–≤** ‚ùå
- –í –∏—Ç–æ–≥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç–µ—Ä—è–ª **51 –±–∞–ª–ª**

### –õ–æ–≥–∏ –∏–∑ –æ—Ç—á–µ—Ç–∞:
```
üí≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞: {
  currentBalance: 44,              // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è 51 –±–∞–ª–ª–∞
  earnedPoints: 95,                // –ù–∞—á–∏—Å–ª–µ–Ω–æ –∑–∞ –∑–∞–∫–∞–∑
  pointsUsed: 51,                  // ‚ùå –û–®–ò–ë–ö–ê: —Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ!
  newBalance: 88,                  // 44 + 95 - 51 = 88 (–Ω–µ–≤–µ—Ä–Ω–æ)
  calculation: '44 + 95 - 51 = 88'
}
```

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:**
```
newBalance: 139,  // 44 + 95 = 139 (—Å–ø–∏—Å–∞–Ω–∏–µ —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Ä–∞–Ω–µ–µ)
calculation: '44 + 95 - 0 = 139'
```

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –§–∞–π–ª: `app/api/orders/[id]/route.ts`

**–°—Ç—Ä–æ–∫–∞ 367** - –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞ (PATCH):

```typescript
// ‚ùå –ë–´–õ–û (–¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ):
await awardLoyaltyPoints(currentOrder.user_id, orderTotal, pointsUsed, loyaltyPointsEarned, Number(id))

// ‚úÖ –°–¢–ê–õ–û (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è):
await awardLoyaltyPoints(currentOrder.user_id, orderTotal, 0, loyaltyPointsEarned, Number(id))
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

1. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞** (`POST /api/orders`):
   - –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `deductLoyaltyPoints()` –µ—Å–ª–∏ `pointsUsed > 0`
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–∏–ø–∞ `"used"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
   - –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –Ω–∞ `pointsUsed`

2. **–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞** (`PATCH /api/orders/[id]`):
   - –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `awardLoyaltyPoints(userId, orderTotal, 0, pointsEarned, orderId)`
   - **–í–∞–∂–Ω–æ:** –ø–µ—Ä–µ–¥–∞–µ–º `pointsUsed = 0`, —Ç–∞–∫ –∫–∞–∫ —Å–ø–∏—Å–∞–Ω–∏–µ —É–∂–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ!
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–∏–ø–∞ `"earned"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
   - –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –Ω–∞ `pointsEarned`

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –±–∞–ª–ª—ã **—Ç–æ–ª—å–∫–æ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è** –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: `newBalance = currentBalance + earnedPoints`

---

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ó–∞–∫–∞–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–ª–ª–æ–≤
1. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 100 –±–∞–ª–ª–æ–≤
2. –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –Ω–∞ 2000‚ÇΩ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 50 –±–∞–ª–ª–æ–≤
3. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è: 100 - 50 = **50 –±–∞–ª–ª–æ–≤** ‚úÖ
4. –û–ø–ª–∞—á–∏–≤–∞–µ—Ç –∑–∞–∫–∞–∑
5. –ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è 60 –±–∞–ª–ª–æ–≤ (3% –æ—Ç 2000‚ÇΩ)
6. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: 50 + 60 = **110 –±–∞–ª–ª–æ–≤** ‚úÖ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–∞–∫–∞–∑ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
1. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 0 –±–∞–ª–ª–æ–≤
2. –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –Ω–∞ 3000‚ÇΩ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∞–ª–ª—ã
3. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è: **0 –±–∞–ª–ª–æ–≤** ‚úÖ
4. –û–ø–ª–∞—á–∏–≤–∞–µ—Ç –∑–∞–∫–∞–∑
5. –ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è 90 –±–∞–ª–ª–æ–≤ (3% –æ—Ç 3000‚Çø)
6. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: 0 + 90 = **90 –±–∞–ª–ª–æ–≤** ‚úÖ

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `app/api/orders/[id]/route.ts` - PATCH –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- `app/api/orders/route.ts` - POST –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
- `lib/nocodb.ts` - —Ñ—É–Ω–∫—Ü–∏–∏ `awardLoyaltyPoints`, `deductLoyaltyPoints`
- `DATA_ARCHITECTURE_RULES.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é –±–∞–ª–ª–æ–≤

---

## üöÄ –î–µ–ø–ª–æ–π

```bash
# –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
git add app/api/orders/[id]/route.ts FIX_DOUBLE_LOYALTY_DEDUCTION_2026_01_13.md BUG_FIXES_2026_01_13.md
git commit -m "fix: —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞ (bug #user-121)"

# –ü—É—à –Ω–∞ —Å–µ—Ä–≤–µ—Ä
git push origin main

# SSH –Ω–∞ production
ssh root@5.129.194.168

# –î–µ–ø–ª–æ–π
cd /var/www/ogfoody
git pull origin main
npm run build
pm2 restart ogfoody
pm2 logs ogfoody --lines 50
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–æ

