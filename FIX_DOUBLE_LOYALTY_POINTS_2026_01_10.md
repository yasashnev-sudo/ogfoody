# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏
**–î–∞—Ç–∞:** 10.01.2026 23:00  
**–ü—Ä–æ–±–ª–µ–º—ã:** –î–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏

---

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
1. –ì–æ—Å—Ç—å —Å–æ–∑–¥–∞–ª –∑–∞–∫–∞–∑ –Ω–∞ 2644‚ÇΩ
2. –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª—Å—è (userId=31)
3. –û–ø–ª–∞—Ç–∏–ª –Ω–∞–ª–∏—á–Ω—ã–º–∏
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 158 –±–∞–ª–ª–æ–≤ (–≤–º–µ—Å—Ç–æ 79)
5. –£–¥–∞–ª–∏–ª –∑–∞–∫–∞–∑
6. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** 79 –±–∞–ª–ª–æ–≤ (–≤–º–µ—Å—Ç–æ 0)

---

## üìä –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –î–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

**–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (POST /api/orders):**
```
üí≥ –û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞: –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ —Å—Ä–∞–∑—É
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è "earned" —Å–æ–∑–¥–∞–Ω–∞: +79 –±–∞–ª–ª–æ–≤
‚úÖ awardLoyaltyPoints –∑–∞–≤–µ—Ä—à–µ–Ω–æ: { actualBalance: 79 }
```

**–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ (PATCH /api/orders/392):**
```
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è "earned" —Å–æ–∑–¥–∞–Ω–∞: +79 –±–∞–ª–ª–æ–≤
‚úÖ awardLoyaltyPoints –∑–∞–≤–µ—Ä—à–µ–Ω–æ: { actualBalance: 158 }
payment_method: 'cash'
```

‚ùå **–ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª–∏–ª–∏—Å—å –î–í–ê–ñ–î–´:** 79 + 79 = 158

**–ü—Ä–∏—á–∏–Ω–∞:** 
- POST —Ä–µ—à–∏–ª, —á—Ç–æ —ç—Ç–æ "–æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞" (—Ö–æ—Ç—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å cash)
- PATCH –Ω–µ –ø—Ä–æ–≤–µ—Ä–∏–ª `loyalty_points_earned` –ø–µ—Ä–µ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

---

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏

**–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ (DELETE /api/orders/392):**
```
üí∞ –ó–∞–∫–∞–∑ 392 –±—ã–ª –û–ü–õ–ê–ß–ï–ù - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–ª–ª—ã { pointsEarned: 79 }
üí∞ calculateUserBalance(31): 79 –±–∞–ª–ª–æ–≤ (–∏–∑ 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
```

‚ùå **–í–µ—Ä–Ω—É–ª–æ—Å—å —Ç–æ–ª—å–∫–æ 79 –±–∞–ª–ª–æ–≤, –æ—Å—Ç–∞–ª–æ—Å—å 79** (–¥–æ–ª–∂–Ω–æ –±—ã–ª–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ 0)

**–ü—Ä–∏—á–∏–Ω–∞:**
- DELETE –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `loyalty_points_earned` –∏–∑ –∑–∞–∫–∞–∑–∞ (79)
- –ù–æ —Ä–µ–∞–ª—å–Ω–æ –±—ã–ª–æ –Ω–∞—á–∏—Å–ª–µ–Ω–æ 158 –±–∞–ª–ª–æ–≤ (2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
- –í—Ç–æ—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞

---

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –ë–∞–ª–ª—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —à–∞–ø–∫–µ

**–°–∏–º–ø—Ç–æ–º:** –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–ª—ã –ø–æ—è–≤–∏–ª–∏—Å—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ, –Ω–æ –Ω–µ –≤ —à–∞–ø–∫–µ

**–ü—Ä–∏—á–∏–Ω–∞:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `loyaltyPointsEarned > 0` –≤ –æ—Ç–≤–µ—Ç–µ API

---

### –ü—Ä–æ–±–ª–µ–º–∞ #4: paymentMethod –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏

**–°–∏–º–ø—Ç–æ–º:** POST –ø–æ–ª—É—á–∏–ª –∑–∞–∫–∞–∑ —Å `paymentMethod: undefined`, –Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–ª –∫–∞–∫ –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—É

**–ü—Ä–∏—á–∏–Ω–∞:** –í `handleAutoCheckout` –Ω–µ —É–¥–∞–ª—è–ª—Å—è `paymentMethod` –∏–∑ –≥–æ—Å—Ç–µ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. PATCH partial update - –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

**–§–∞–π–ª:** `app/api/orders/[id]/route.ts` (—Å—Ç—Ä–æ–∫–∏ 547-565)

```typescript
// ‚úÖ –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∏ –ª–∏ –±–∞–ª–ª—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
const existingPointsEarnedPartial = typeof currentOrder.loyalty_points_earned === 'number' 
  ? currentOrder.loyalty_points_earned 
  : parseInt(String(currentOrder.loyalty_points_earned)) || 0

console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ ${id}:`, {
  wasPaid,
  willBePaid,
  'currentOrder.user_id': currentOrder.user_id,
  'currentOrder.loyalty_points_earned': existingPointsEarnedPartial,
  pendingPointsEarned,
  condition: !wasPaid && willBePaid && currentOrder.user_id && pendingPointsEarned === 0 && existingPointsEarnedPartial === 0
})

if (existingPointsEarnedPartial > 0) {
  console.warn(`‚ö†Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ì–û –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø (partial update): –ë–∞–ª–ª—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ ${id}: ${existingPointsEarnedPartial}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ.`)
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ updateData
  updateData.loyalty_points_earned = existingPointsEarnedPartial
} else if (!wasPaid && willBePaid && currentOrder.user_id && pendingPointsEarned === 0) {
  // ... –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `loyalty_points_earned` –ü–ï–†–ï–î –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º
- –ï—Å–ª–∏ –±–∞–ª–ª—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

---

### 2. DELETE - –≤–æ–∑–≤—Ä–∞—Ç –í–°–ï–• –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤

**–§–∞–π–ª:** `app/api/orders/[id]/route.ts` (—Å—Ç—Ä–æ–∫–∏ 805-850)

```typescript
// –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –±—ã–ª –û–ü–õ–ê–ß–ï–ù - –±–∞–ª–ª—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö
if (wasPaid && (pointsEarned > 0 || pointsUsed > 0)) {
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–ª—É—á–∞–µ–º –í–°–ï completed —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞
  // –í–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è pointsEarned –∏–∑ –∑–∞–∫–∞–∑–∞, –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å—É–º–º—É –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  try {
    const allTransactions = await fetchPendingTransactionsByOrder(Number(id))
    
    let actualPointsEarned = 0
    let actualPointsUsed = 0
    
    for (const trans of allTransactions) {
      const transPoints = typeof trans.points === 'number' ? trans.points : parseInt(String(trans.points)) || 0
      if (trans.transaction_type === 'earned' && trans.transaction_status === 'completed') {
        actualPointsEarned += transPoints
      } else if (trans.transaction_type === 'used' && trans.transaction_status === 'completed') {
        actualPointsUsed += Math.abs(transPoints) // used –±–∞–ª–ª—ã –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ
      }
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–ª–∏ fallback –Ω–∞ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞
    const finalPointsEarned = actualPointsEarned > 0 ? actualPointsEarned : pointsEarned
    const finalPointsUsed = actualPointsUsed > 0 ? actualPointsUsed : pointsUsed
    
    console.log(`üí∞ –ó–∞–∫–∞–∑ ${id} –±—ã–ª –û–ü–õ–ê–ß–ï–ù - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–ª–ª—ã`, {
      pointsEarnedFromOrder: pointsEarned,
      pointsUsedFromOrder: pointsUsed,
      actualPointsEarnedFromTransactions: actualPointsEarned,
      actualPointsUsedFromTransactions: actualPointsUsed,
      finalPointsEarned,
      finalPointsUsed,
      orderTotal,
      userId: currentOrder.user_id,
    })
    
    await refundLoyaltyPoints(
      currentOrder.user_id,
      finalPointsEarned,
      finalPointsUsed,
      orderTotal,
      Number(id)
    )
    console.log(`‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${finalPointsEarned} –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∏ ${finalPointsUsed} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤`)
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –±–∞–ª–ª–æ–≤:`, error)
    // Fallback –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∑–∞–∫–∞–∑–∞
    await refundLoyaltyPoints(
      currentOrder.user_id,
      pointsEarned,
      pointsUsed,
      orderTotal,
      Number(id)
    )
    console.log(`‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ ${pointsEarned} –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∏ ${pointsUsed} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤ (fallback)`)
  }
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –í–°–ï earned —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é —Å—É–º–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤
- Fallback –Ω–∞ –ø–æ–ª–µ –∑–∞–∫–∞–∑–∞ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤

---

### 3. –£–¥–∞–ª–µ–Ω–∏–µ paymentMethod –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏

**–§–∞–π–ª:** `app/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 1868-1883)

```typescript
const updatedOrder: Order = {
  ...(lastOrder || pendingCheckout.order),
  deliveryFee,
  deliveryDistrict: district,
  deliveryAddress: `${userProfile.street}, ${userProfile.building}${userProfile.apartment ? ', –∫–≤. ' + userProfile.apartment : ''}`,
  subtotal: pendingCheckout.order.subtotal || pendingCheckout.total,
  total: (pendingCheckout.order.subtotal || pendingCheckout.total) + deliveryFee,
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–¥–∞–ª—è–µ–º paymentMethod –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
// –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç–µ –≤ PaymentModal
if (!updatedOrder.id) {
  delete updatedOrder.paymentMethod
  delete updatedOrder.paid
  delete updatedOrder.paidAt
  console.log("üîß –£–¥–∞–ª–µ–Ω—ã –ø–æ–ª—è –æ–ø–ª–∞—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ (–±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ)")
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- paymentMethod –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ POST
- POST –∏—Å–ø–æ–ª—å–∑—É–µ—Ç default "cash"
- –°–æ–∑–¥–∞–µ—Ç—Å—è pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—Ç—Å—è —á–µ—Ä–µ–∑ 24—á –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏

---

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –≤ UI —à–∞–ø–∫–∏

**–§–∞–π–ª:** `app/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 1557-1583)

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ API –í–°–ï–ì–î–ê –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
// –ù–µ –∑–∞–≤–∏—Å–∏–º –æ—Ç loyaltyPointsEarned - –±–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –∏–∑-–∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
try {
  const profileResponse = await fetch(`/api/orders?userId=${userProfile.id}`)
  const profileData = await profileResponse.json()
  
  if (profileData.userProfile) {
    console.log('üí∞ –û–±–Ω–æ–≤–ª–µ–Ω—ã –±–∞–ª–ª—ã –∏–∑ API –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:', {
      —Å—Ç–∞—Ä—ã–µ: userProfile.loyaltyPoints,
      –Ω–æ–≤—ã–µ: profileData.userProfile.loyaltyPoints,
      loyaltyPointsEarnedFromResponse: data.loyaltyPointsEarned
    })
    
    const updatedProfile = {
      ...userProfile,
      loyaltyPoints: profileData.userProfile.loyaltyPoints,
      totalSpent: profileData.userProfile.totalSpent,
    }
    setUserProfile(updatedProfile)
    
    if (user) {
      localStorage.setItem(`profile_${user}`, JSON.stringify(updatedProfile))
    }
  }
} catch (error) {
  console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error)
}
```

**–ë—ã–ª–æ:**
```typescript
if (data.loyaltyPointsEarned && data.loyaltyPointsEarned > 0) {
  // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
}
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –í–°–ï–ì–î–ê –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- –ë–∞–ª–ª—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —à–∞–ø–∫–µ —Å—Ä–∞–∑—É
- –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è `loyaltyPointsEarned` –≤ –æ—Ç–≤–µ—Ç–µ

---

## üîÑ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ì–æ—Å—Ç—å ‚Üí –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏

1. **–ì–æ—Å—Ç—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑** (localStorage)
2. **–ù–∞–∂–∏–º–∞–µ—Ç "–ó–∞–∫–∞–∑–∞—Ç—å"** ‚Üí AuthModal
3. **–ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è** ‚Üí userId=31
4. **–ó–∞–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å** ‚Üí ProfileModal
5. **–ê–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ** (`handleAutoCheckout`):
   - –£–¥–∞–ª—è—é—Ç—Å—è –ø–æ–ª—è `paymentMethod`, `paid`, `paidAt`
   - POST `/api/orders` —Å `userId=31`
   - `paymentMethod` = undefined ‚Üí default "cash"
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `finalTotal` = 2644‚ÇΩ
   - **–°–æ–∑–¥–∞–µ—Ç—Å—è pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:** +79 –±–∞–ª–ª–æ–≤
   - –ë–∞–ª–ª—ã –ù–ï –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É
6. **PaymentModal** ‚Üí "–û–ø–ª–∞—Ç–∏—Ç—å –Ω–∞–ª–∏—á–Ω—ã–º–∏"
7. **PATCH `/api/orders/392`:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `loyalty_points_earned` = 0
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `pendingPointsEarned` = 0
   - **–ù–ï –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã** (—É–∂–µ –µ—Å—Ç—å pending)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç `paid: true, payment_method: 'cash'`
8. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI:**
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ API
   - `loyaltyPoints` = 0 (pending –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã)
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —à–∞–ø–∫–µ: 0 –±–∞–ª–ª–æ–≤
9. **–ß–µ—Ä–µ–∑ 24—á –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏:**
   - Cron job –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pending
   - –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è: 0 + 79 = 79
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è: 79 –±–∞–ª–ª–æ–≤

---

### –°—Ü–µ–Ω–∞—Ä–∏–π: –£–¥–∞–ª–µ–Ω–∏–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞

1. **–ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω:** 79 –±–∞–ª–ª–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ (1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)
2. **DELETE `/api/orders/392`:**
   - –ü–æ–ª—É—á–∞–µ—Ç –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞
   - –ù–∞—Ö–æ–¥–∏—Ç: 1 earned —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞ +79 –±–∞–ª–ª–æ–≤
   - –í—ã–∑—ã–≤–∞–µ—Ç `refundLoyaltyPoints(userId, 79, 0, ...)`
   - –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é "cancelled": -79 –±–∞–ª–ª–æ–≤
   - –ë–∞–ª–∞–Ω—Å: 79 - 79 = 0
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI:**
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ API
   - `loyaltyPoints` = 0 (–ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è: 0 –±–∞–ª–ª–æ–≤ ‚úÖ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≥–æ—Å—Ç–µ–º —Å –æ–ø–ª–∞—Ç–æ–π –Ω–∞–ª–∏—á–Ω—ã–º–∏

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ POST:**
```
üîß –£–¥–∞–ª–µ–Ω—ã –ø–æ–ª—è –æ–ø–ª–∞—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: 2644‚ÇΩ + 0‚ÇΩ (–¥–æ—Å—Ç–∞–≤–∫–∞) = 2644‚ÇΩ
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:
  orderTotal: 2644
üí∞ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤: 79
üíµ –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏: —Å–æ–∑–¥–∞–Ω–∏–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
‚è≥ Pending: 79 –±–∞–ª–ª–æ–≤ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ PATCH:**
```
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ 392:
  currentOrder.loyalty_points_earned: 0
  condition: false (pending —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞)
‚ö†Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ì–û –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø: –ë–∞–ª–ª—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 0 –±–∞–ª–ª–æ–≤ (pending), —á–µ—Ä–µ–∑ 24—á ‚Üí 79 –±–∞–ª–ª–æ–≤

---

### –¢–µ—Å—Ç 2: –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –¥–≤–æ–π–Ω—ã–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º

**–î–∞–Ω–æ:** –ó–∞–∫–∞–∑ —Å 2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ earned (+79, +79)

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ DELETE:**
```
üí∞ –ó–∞–∫–∞–∑ 392 –±—ã–ª –û–ü–õ–ê–ß–ï–ù - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–ª–ª—ã
  pointsEarnedFromOrder: 79
  actualPointsEarnedFromTransactions: 158
  finalPointsEarned: 158
‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ 158 –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 158 - 158 = 0 –±–∞–ª–ª–æ–≤ ‚úÖ

---

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `app/api/orders/[id]/route.ts` (PATCH, DELETE)
- `app/page.tsx` (handleAutoCheckout, handlePaymentComplete)
- `lib/nocodb.ts` (refundLoyaltyPoints)

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ë–∞–ª–ª—ã –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ:** pending, –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 24—á
2. **–ë–∞–ª–ª—ã –∑–∞ –∫–∞—Ä—Ç—É/–°–ë–ü:** —Å—Ä–∞–∑—É –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
3. **DELETE:** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –í–°–ï earned —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞
4. **PATCH:** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `loyalty_points_earned` –ø–µ—Ä–µ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º
5. **UI:** –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –í–°–ï–ì–î–ê –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `loyaltyPointsEarned`

---

## üîß –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **10.01.2026 23:00:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤ PATCH
- **10.01.2026 23:15:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤ –≤ DELETE
- **10.01.2026 23:30:** –£–¥–∞–ª–µ–Ω paymentMethod –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
- **10.01.2026 23:45:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –≤ UI —à–∞–ø–∫–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é



