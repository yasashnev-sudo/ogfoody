name: Deploy to ogfoody.ru

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: üìä Check build output
        run: |
          echo "Build completed successfully"
          ls -la .next

      - name: üöÄ Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e
            
            echo "üîÑ Starting deployment to ogfoody.ru..."
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd ${{ secrets.SERVER_PATH || '/var/www/ogfoody' }}
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            echo "üíæ Creating backup..."
            timestamp=$(date +%Y%m%d_%H%M%S)
            mkdir -p ../backups
            tar -czf ../backups/ogfoody_backup_$timestamp.tar.gz --exclude=node_modules --exclude=.next . || true
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º .env —Ñ–∞–π–ª—ã
            cp .env.production .env.production.backup 2>/dev/null || true
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .env —Ñ–∞–π–ª—ã
            mv .env.production.backup .env.production 2>/dev/null || true
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ Installing dependencies..."
            npm ci --production=false
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "üèóÔ∏è Building project..."
            npm run build
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2
            echo "üîÑ Restarting application..."
            pm2 restart ogfoody || pm2 start ecosystem.config.js
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ Deployment completed!"
            pm2 status ogfoody
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
            echo "üßπ Cleaning old backups..."
            cd ../backups
            ls -t ogfoody_backup_*.tar.gz | tail -n +6 | xargs -r rm
            
            echo "üéâ ogfoody.ru successfully deployed!"

      - name: üß™ Health check
        run: |
          echo "Waiting 10 seconds for app to start..."
          sleep 10
          curl -f https://ogfoody.ru/api/health || curl -f http://ogfoody.ru || echo "Health check skipped"

      - name: üì¢ Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to ogfoody.ru successful!"
          else
            echo "‚ùå Deployment to ogfoody.ru failed!"
          fi

