# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã

### 1. ‚ùå –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ = 0
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞–≤–∞–ª `total: null` –∏ `subtotal: null`, –∑–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—è–ª—Å—è —Å –Ω—É–ª–µ–≤–æ–π —Å—É–º–º–æ–π.

**–õ–æ–≥–∏**:
```
orderTotal: null
subtotal: null
‚ö†Ô∏è –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ —Ä–∞–≤–Ω–∞ 0 –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è: 0. –ë–∞–ª–ª—ã –Ω–µ –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã.
```

**–†–µ—à–µ–Ω–∏–µ**: –¢–µ–ø–µ—Ä—å —Å—É–º–º–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–∑ –≤—Å–µ—Ö meals –∏ extras –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è.

### 2. ‚ùå meal_id —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º
**–ü—Ä–æ–±–ª–µ–º–∞**: ID –±–ª—é–¥ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º `"1308_dinner"` –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞ `1308`, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫—É –ë–î:
```
Invalid value '1308_dinner' for type 'bigint'
```

**–†–µ—à–µ–Ω–∏–µ**: –¢–µ–ø–µ—Ä—å –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è —á–∏—Å–ª–æ–≤–∞—è —á–∞—Å—Ç—å –∏–∑ ID –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î.

### 3. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞**: –í `.idx/dev.nix` –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `NOCODB_TABLE_LOYALTY_POINTS_TRANSACTIONS`.

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º `mn244txmccpwmhx`.

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞ (`app/api/orders/route.ts`)
```typescript
// –î–æ–±–∞–≤–ª–µ–Ω –ø–æ–¥—Å—á–µ—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
let calculatedTotal = 0

// –ö–∞–∂–¥—ã–π meal —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
const mealCost = await saveMeal(...)
calculatedTotal += mealCost

// –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ—Ö meals –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑
await updateOrder(nocoOrder.Id, {
  subtotal: calculatedTotal,
  total: calculatedTotal,
})
```

### 2. –û—á–∏—Å—Ç–∫–∞ meal_id –æ—Ç —Å—É—Ñ—Ñ–∏–∫—Å–∞
```typescript
// –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ meal_id
const cleanMealId = typeof meal.id === 'string' 
  ? parseInt(meal.id.split('_')[0]) 
  : meal.id
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π —Å—É–º–º—ã –¥–ª—è –±–∞–ª–ª–æ–≤
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é —Å—É–º–º—É –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–π –∫–ª–∏–µ–Ω—Ç–æ–º
const orderTotal = calculatedTotal

if (orderTotal > 0) {
  actualPointsEarned = calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)
  await awardLoyaltyPoints(userId, orderTotal, pointsUsed, actualPointsEarned, nocoOrder.Id)
}
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.idx/dev.nix`)
```nix
NOCODB_TABLE_LOYALTY_POINTS_TRANSACTIONS = "mn244txmccpwmhx";
```

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
npm run dev
```

### 2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑
- –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å
- –í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑
- –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:
  ```
  üí∞ Calculated order total: 3552
  ‚úÖ Updated order 40 with total: 3552
  üí∞ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤: 106
  ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ 106 –±–∞–ª–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 5 –∑–∞ –∑–∞–∫–∞–∑ 40
  ```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
- –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –±–∞–ª–ª—ã

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
```
http://localhost:3001/debug/loyalty?userId=5&checkTransactions=true
```

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –õ–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:
```
üí∞ Calculated order total: 3552
‚úÖ Updated order 40 with total: 3552
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤:
  hasUserId: true
  userId: 5
  calculatedTotal: 3552
  orderTotal: 3552
üìä –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤:
  orderTotal: 3552
  pointsUsed: 0
  currentTotalSpent: 0
  loyaltyLevel: 'bronze'
üí∞ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤: 106
‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ 106 –±–∞–ª–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 5 –∑–∞ –∑–∞–∫–∞–∑ 40
üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ
```

### –û—Ç–≤–µ—Ç API:
```json
{
  "success": true,
  "orderId": 40,
  "orderNumber": "ORD-20260107-ABC123",
  "loyaltyPointsEarned": 106,
  "orderTotal": 3552,
  "loyaltyPointsDiagnostics": {
    "userId": 5,
    "pointsAwarded": 106,
    "pointsAwardedReason": "–ë–∞–ª–ª—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω—ã",
    "orderTotal": 3552,
    "pointsUsed": 0,
    "hasUser": true
  }
}
```

## –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤

```
amountForPoints = orderTotal - pointsUsed
cashbackPercent = 
  - 7% –µ—Å–ª–∏ totalSpent >= 50000 (Gold)
  - 5% –µ—Å–ª–∏ totalSpent >= 20000 (Silver)  
  - 3% –µ—Å–ª–∏ totalSpent < 20000 (Bronze)
earnedPoints = floor(amountForPoints * cashbackPercent / 100)
```

–ü—Ä–∏–º–µ—Ä: –∑–∞–∫–∞–∑ –Ω–∞ 3552 —Ä—É–±, —É—Ä–æ–≤–µ–Ω—å Bronze (3%):
- `floor(3552 * 0.03) = floor(106.56) = 106 –±–∞–ª–ª–æ–≤`




