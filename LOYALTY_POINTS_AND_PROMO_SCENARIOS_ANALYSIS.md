# üîç –ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¶–ï–ù–ê–†–ò–ï–í: –ë–ê–õ–õ–´ –õ–û–Ø–õ–¨–ù–û–°–¢–ò –ò –ü–†–û–ú–û–ö–û–î–´

> ‚≠ê **–≠–¢–ê–õ–û–ù–ù–´–ô –î–û–ö–£–ú–ï–ù–¢**  
> –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–ª–∞–º–∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏.

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-15  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–≠–¢–ê–õ–û–ù** ‚Äî –ó–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ  
**–í–µ—Ä—Å–∏—è:** 1.0

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–°—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ (earned)](#1-—Å—Ü–µ–Ω–∞—Ä–∏–∏-–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è-–±–∞–ª–ª–æ–≤-earned)
2. [–°—Ü–µ–Ω–∞—Ä–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ (used)](#2-—Å—Ü–µ–Ω–∞—Ä–∏–∏-—Å–ø–∏—Å–∞–Ω–∏—è-–±–∞–ª–ª–æ–≤-used)
3. [–†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏](#3-—Ä–∞–±–æ—Ç–∞-—Å-–ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏-–≤-–∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π-—á–∞—Å—Ç–∏)
4. [–†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞](#4-—Ä–∞–±–æ—Ç–∞-—Å-–ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏-–≤-–ø–∞–Ω–µ–ª–∏-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
5. [–ü—Ä–æ–±–ª–µ–º—ã –∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è](#5-–ø—Ä–æ–±–ª–µ–º—ã-–∏-–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è)

---

## 1. –°–¶–ï–ù–ê–†–ò–ò –ù–ê–ö–û–ü–õ–ï–ù–ò–Ø –ë–ê–õ–õ–û–í (EARNED)

### 1.1. –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

**–§—É–Ω–∫—Ü–∏—è:** `calculateEarnedPoints(orderTotal, pointsUsed, totalSpent)`

**–§–∞–π–ª:** `lib/nocodb.ts` (—Å—Ç—Ä–æ–∫–∏ 945-979)

**–§–æ—Ä–º—É–ª–∞:**
```typescript
earnedPoints = Math.floor(orderTotal * (cashbackPercent / 100))
```

**–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**
- ‚úÖ –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ **–ü–û–õ–ù–£–Æ** —Å—É–º–º—É –∑–∞–∫–∞–∑–∞: `orderTotal = subtotal + delivery_fee - promo_discount`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã (`pointsUsed`) **–ù–ï –≤–ª–∏—è—é—Ç** –Ω–∞ —Ä–∞—Å—á–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ—Ü–µ–Ω—Ç –∫—ç—à–±—ç–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `total_spent`:
  - Bronze: 3% (total_spent < 20,000 —Ä—É–±.)
  - Silver: 5% (20,000 ‚â§ total_spent < 50,000 —Ä—É–±.)
  - Gold: 7% (total_spent ‚â• 50,000 —Ä—É–±.)

**–ò—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –±–∞–ª–∞–Ω—Å–∞:**
- –ë–∞–ª–∞–Ω—Å **–í–°–ï–ì–î–ê** —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Å—É–º–º—ã –≤—Å–µ—Ö `completed` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –§—É–Ω–∫—Ü–∏—è: `calculateUserBalance(userId, noCache)`
- `Users.Loyalty Points` –ù–ï —è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã - –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è

---

### 1.2. –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (POST)

**–ú–µ—Å—Ç–æ:** `POST /api/orders` (—Å—Ç—Ä–æ–∫–∏ 615-707)

**–£—Å–ª–æ–≤–∏—è:**
- `paymentMethod === 'card' || paymentMethod === 'sbp'`
- `orderTotal > 0`
- `userId` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ë–∞–ª–ª—ã –µ—â–µ –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã (`loyalty_points_earned === 0`)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±–∞–ª–ª—ã: `calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)`
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `awardLoyaltyPoints(userId, orderTotal, 0, actualPointsEarned, orderId)`
3. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
   - `transaction_type: "earned"`
   - `transaction_status: "completed"`
   - `points: earnedPoints`
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å: `newBalance = currentBalance + earnedPoints - pointsUsed`
5. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `total_spent`: `newTotalSpent = currentTotalSpent + orderTotal - pointsUsed`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–∞–ª–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã **—Å—Ä–∞–∑—É**
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI —á–µ—Ä–µ–∑ `userProfile` –≤ –æ—Ç–≤–µ—Ç–µ
- ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–∫–∞–∑–µ

**–ö–æ–¥:**
```typescript
// app/api/orders/route.ts:681-707
if (order.paymentMethod === 'card' || order.paymentMethod === 'sbp') {
  await awardLoyaltyPoints(userId, orderTotalNum, 0, actualPointsEarned, nocoOrder.Id)
}
```

---

### 1.3. –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç–µ (PATCH full order)

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 330-380)

**–£—Å–ª–æ–≤–∏—è:**
- `!wasPaid && willBePaid` (–ø–µ—Ä–≤–∞—è –æ–ø–ª–∞—Ç–∞)
- `orderTotal > 0`
- `paymentMethod === 'card' || paymentMethod === 'sbp'`
- –ë–∞–ª–ª—ã –µ—â–µ –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã (`loyalty_points_earned === 0`)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ –±–∞–ª–ª—ã –Ω–µ –±—ã–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã —Ä–∞–Ω–µ–µ
2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±–∞–ª–ª—ã: `calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)`
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `awardLoyaltyPoints(userId, orderTotal, 0, loyaltyPointsEarned, orderId)`
4. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"earned"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
5. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –∏ `total_spent`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–∞–ª–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

**–ö–æ–¥:**
```typescript
// app/api/orders/[id]/route.ts:330-380
if (!wasPaid && willBePaid && orderTotal > 0) {
  const existingPointsEarned = currentOrder.loyalty_points_earned || 0
  if (existingPointsEarned === 0) {
    loyaltyPointsEarned = calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)
    await awardLoyaltyPoints(currentOrder.user_id, orderTotal, 0, loyaltyPointsEarned, Number(id))
  }
}
```

---

### 1.4. –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç–µ (PATCH partial)

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 1080-1245)

**–£—Å–ª–æ–≤–∏—è:**
- `!wasPaid && willBePaid` (–ø–µ—Ä–≤–∞—è –æ–ø–ª–∞—Ç–∞)
- `orderTotal > 0`
- `paymentMethod === 'card' || paymentMethod === 'sbp'`
- –ë–∞–ª–ª—ã –µ—â–µ –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã (`existingPointsEarnedPartial === 0`)
- –ù–µ—Ç pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (`pendingPointsEarned === 0`)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `orderTotal` —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ (–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±–∞–ª–ª—ã: `calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)`
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `awardLoyaltyPoints(userId, orderTotal, 0, loyaltyPointsEarned, orderId)`
4. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"earned"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
5. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `loyalty_points_earned` –≤ `updateData`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–∞–ª–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

**–ö–æ–¥:**
```typescript
// app/api/orders/[id]/route.ts:1080-1245
if (!wasPaid && willBePaid && currentOrder.user_id && pendingPointsEarned === 0 && existingPointsEarnedPartial === 0) {
  const loyaltyPointsEarned = calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)
  await awardLoyaltyPoints(currentOrder.user_id, orderTotal, 0, loyaltyPointsEarned, Number(id))
  updateData.loyalty_points_earned = loyaltyPointsEarned
}
```

---

### 1.5. –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ - Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (POST)

**–ú–µ—Å—Ç–æ:** `POST /api/orders` (—Å—Ç—Ä–æ–∫–∏ 707-724)

**–£—Å–ª–æ–≤–∏—è:**
- `paymentMethod === 'cash'`
- `orderTotal > 0`
- `userId` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±–∞–ª–ª—ã: `calculateEarnedPoints(orderTotal, pointsUsed, currentTotalSpent)`
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `createPendingLoyaltyPoints(userId, orderTotal, 0, actualPointsEarned, orderId)`
3. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
   - `transaction_type: "earned"`
   - `transaction_status: "pending"`
   - `points: earnedPoints`
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `total_spent` —Å—Ä–∞–∑—É: `newTotalSpent = currentTotalSpent + orderTotal - pointsUsed`
5. –ë–∞–ª–∞–Ω—Å **–ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** (pending)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚è≥ –ë–∞–ª–ª—ã **–ù–ï –¥–æ—Å—Ç—É–ø–Ω—ã** —Å—Ä–∞–∑—É
- ‚è≥ –ù–∞—á–∏—Å–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **24 —á–∞—Å–∞** –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ —á–µ—Ä–µ–∑ cron job
- ‚úÖ `total_spent` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É

**–ö–æ–¥:**
```typescript
// app/api/orders/route.ts:707-724
if (order.paymentMethod === 'cash') {
  await createPendingLoyaltyPoints(userId, orderTotalNum, 0, actualPointsEarned, nocoOrder.Id)
}
```

---

### 1.6. –°—Ü–µ–Ω–∞—Ä–∏–π 5: –û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ - Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (PATCH)

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (–ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏)

**–£—Å–ª–æ–≤–∏—è:**
- `!wasPaid && willBePaid` (–ø–µ—Ä–≤–∞—è –æ–ø–ª–∞—Ç–∞)
- `paymentMethod === 'cash'`
- –ë–∞–ª–ª—ã –µ—â–µ –Ω–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã

**–ü—Ä–æ—Ü–µ—Å—Å:**
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏—é 1.5, –Ω–æ —á–µ—Ä–µ–∑ PATCH

---

### 1.7. –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (Cron Job)

**–ú–µ—Å—Ç–æ:** `GET /api/cron/process-pending-points` (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å)

**–£—Å–ª–æ–≤–∏—è –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:**
- `transaction_status === 'pending'`
- `transaction_type === 'earned'`
- –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (`start_date`) ‚â§ –≤—á–µ—Ä–∞—à–Ω—è—è –¥–∞—Ç–∞ (24+ —á–∞—Å–∞ –Ω–∞–∑–∞–¥)
- `payment_method === 'cash'`
- `order_status !== 'cancelled'`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ù–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
2. –î–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —É—Å–ª–æ–≤–∏—è
3. –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
   - –ù–∞—á–∏—Å–ª—è—é—Ç—Å—è –±–∞–ª–ª—ã: `newLoyaltyPoints = currentLoyaltyPoints + points`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: `transaction_status = 'completed'`, `processed_at = now`
4. –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–µ cash:
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è: `transaction_status = 'cancelled'`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–∞–ª–ª—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑)

**–ö–æ–¥:**
```typescript
// app/api/cron/process-pending-points/route.ts:14-232
// –ü–æ–ª–Ω—ã–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```

---

### 1.8. –°—Ü–µ–Ω–∞—Ä–∏–π 7: –°–º–µ–Ω–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã —Å –Ω–∞–ª–∏—á–Ω—ã—Ö –Ω–∞ –æ–Ω–ª–∞–π–Ω

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 432-506)

**–£—Å–ª–æ–≤–∏—è:**
- `oldPaymentMethod === 'cash'`
- `newPaymentMethod === 'card' || newPaymentMethod === 'sbp'`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞: `processPendingTransactionsForOrder(orderId, userId)`
2. –ï—Å–ª–∏ –µ—Å—Ç—å pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   - –û–Ω–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
   - –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `"completed"`
3. –ï—Å–ª–∏ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ –±—ã–ª–æ:
   - –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `awardLoyaltyPoints()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Pending –±–∞–ª–ª—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞ –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—É

**–ö–æ–¥:**
```typescript
// app/api/orders/[id]/route.ts:432-506
if (isPaymentMethodChangedFromCash) {
  pendingPointsEarned = await processPendingTransactionsForOrder(Number(id), currentOrder.user_id)
  if (pendingPointsEarned > 0) {
    loyaltyPointsEarned = pendingPointsEarned
  } else {
    // –ù–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã –∫–∞–∫ –ø—Ä–∏ –æ–±—ã—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ –æ–Ω–ª–∞–π–Ω
    await awardLoyaltyPoints(...)
  }
}
```

---

### 1.9. –°—Ü–µ–Ω–∞—Ä–∏–π 8: –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω (undefined)

**–ú–µ—Å—Ç–æ:** `POST /api/orders` (—Å—Ç—Ä–æ–∫–∏ 677-680)

**–£—Å–ª–æ–≤–∏—è:**
- `paymentMethod === undefined`
- `orderTotal > 0`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ë–∞–ª–ª—ã **–Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
2. `actualPointsEarned = 0` (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è)
3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è **–Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è**
4. `loyalty_points_earned` **–Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è** –≤ –ë–î

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- üîÑ –ë–∞–ª–ª—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç–µ (PATCH)
- üîÑ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ `PaymentModal`

**–ö–æ–¥:**
```typescript
// app/api/orders/route.ts:677-680
if (!order.paymentMethod) {
  actualPointsEarned = 0 // –°–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î
}
```

---

## 2. –°–¶–ï–ù–ê–†–ò–ò –°–ü–ò–°–ê–ù–ò–Ø –ë–ê–õ–õ–û–í (USED)

### 2.1. –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ —Å–ø–∏—Å–∞–Ω–∏—è

**–í–∞–∂–Ω–æ:**
- –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
- –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **—Å—Ä–∞–∑—É**, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ pending
- –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"used"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å: `newBalance = currentBalance - pointsUsed`
- –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `total_spent`: `newTotalSpent = currentTotalSpent + orderTotal - pointsUsed`

**–§–æ—Ä–º—É–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è total_spent:**
```typescript
newTotalSpent = currentTotalSpent + orderTotal - pointsUsed
```
–ì–¥–µ:
- `orderTotal = subtotal + delivery_fee - promo_discount` (–ø–æ–ª–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞)
- `pointsUsed` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤

---

### 2.2. –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (POST)

**–ú–µ—Å—Ç–æ:** `POST /api/orders` (—Å—Ç—Ä–æ–∫–∏ 615-639)

**–£—Å–ª–æ–≤–∏—è:**
- `pointsUsed > 0`
- `userId` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ—è–≤–Ω–æ)
2. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:
   - `transaction_type: "used"`
   - `transaction_status: "completed"`
   - `points: -pointsUsed` (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
3. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å: `newBalance = currentBalance - pointsUsed`
4. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `total_spent`: `newTotalSpent = currentTotalSpent + orderTotal - pointsUsed`

**–í–∞–∂–Ω–æ:**
- ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **—Å—Ä–∞–∑—É**, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ pending

**–ö–æ–¥:**
```typescript
// app/api/orders/route.ts:615-639
if (pointsUsed > 0) {
  await createLoyaltyPointsTransaction({
    user_id: userId,
    order_id: nocoOrder.Id,
    transaction_type: "used",
    transaction_status: "completed",
    points: -pointsUsed,
    description: `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${pointsUsed} –±–∞–ª–ª–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞`,
  })
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ awardLoyaltyPoints –∏–ª–∏ createPendingLoyaltyPoints
}
```

---

### 2.3. –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (PATCH partial)

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 797-883)

**–£—Å–ª–æ–≤–∏—è:**
- `body.loyaltyPointsUsed > 0`
- `existingPointsUsed === 0` (–±–∞–ª–ª—ã –µ—â–µ –Ω–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã)
- `currentBalance >= body.loyaltyPointsUsed` (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω:
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"used"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å: `newBalance = currentBalance - body.loyaltyPointsUsed`
3. –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω:
   - –û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (–Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞)
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

**–ó–∞—â–∏—Ç–∞:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –±–∞–ª–ª–æ–≤ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è (`existingPointsUsed === 0`)

**–ö–æ–¥:**
```typescript
// app/api/orders/[id]/route.ts:797-883
if (currentOrder.user_id && body.loyaltyPointsUsed && body.loyaltyPointsUsed > 0) {
  const existingPointsUsed = currentOrder.loyalty_points_used || 0
  if (existingPointsUsed === 0 && body.loyaltyPointsUsed > 0) {
    if (currentBalance >= body.loyaltyPointsUsed) {
      await createLoyaltyPointsTransaction({
        transaction_type: "used",
        transaction_status: "completed",
        points: -body.loyaltyPointsUsed,
      })
      await updateUser(currentOrder.user_id, {
        loyalty_points: newBalance,
      })
    }
  }
}
```

---

### 2.4. –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (PATCH full order)

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 188-279)

**–£—Å–ª–æ–≤–∏—è:**
- `order.loyaltyPointsUsed > 0`
- `existingPointsUsed === 0` (–±–∞–ª–ª—ã –µ—â–µ –Ω–µ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã)

**–ü—Ä–æ—Ü–µ—Å—Å:**
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏—é 2.3, –Ω–æ –¥–ª—è full order update

---

### 2.5. –°—Ü–µ–Ω–∞—Ä–∏–π 4: –í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞ (PATCH)

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 885-916)

**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è (`order_status === 'cancelled'`)
- `pointsEarned > 0` –∏–ª–∏ `pointsUsed > 0`
- –ó–∞–∫–∞–∑ **–Ω–µ –±—ã–ª –æ–ø–ª–∞—á–µ–Ω** (`!wasPaid`)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞—é—Ç—Å—è –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞
2. –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:
   - `actualPointsEarned` ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö `"earned"` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
   - `actualPointsUsed` ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö `"used"` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `refundLoyaltyPoints(userId, finalPointsEarned, finalPointsUsed, orderTotal, orderId)`
4. –°–æ–∑–¥–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   - `transaction_type: "refunded"` (–≤–æ–∑–≤—Ä–∞—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤)
     - `points: +pointsUsed` (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
   - `transaction_type: "cancelled"` (—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤)
     - `points: -pointsEarned` (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
5. –û–±–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`

**–í–∞–∂–Ω–æ:**
- ‚úÖ –ü—Ä–∏ PATCH –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ **–Ω–µ –±—ã–ª –æ–ø–ª–∞—á–µ–Ω**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∞ –Ω–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞

**–ö–æ–¥:**
```typescript
// app/api/orders/[id]/route.ts:885-916
if (!wasCancelled && willBeCancelled && currentOrder.user_id) {
  if (!wasPaid && (pointsEarned > 0 || pointsUsed > 0)) {
    await refundLoyaltyPoints(
      currentOrder.user_id,
      pointsEarned,
      pointsUsed,
      orderTotal,
      Number(id)
    )
  }
}
```

---

### 2.6. –°—Ü–µ–Ω–∞—Ä–∏–π 5: –í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (DELETE)

**–ú–µ—Å—Ç–æ:** `DELETE /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 1500-1600)

**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–∫–∞–∑ —É–¥–∞–ª—è–µ—Ç—Å—è
- `pointsEarned > 0` –∏–ª–∏ `pointsUsed > 0`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞—é—Ç—Å—è **–í–°–ï** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞: `fetchPendingTransactionsByOrder(orderId)`
2. –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `refundLoyaltyPoints(userId, finalPointsEarned, finalPointsUsed, orderTotal, orderId)`
4. –°–æ–∑–¥–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `"refunded"` –∏ `"cancelled"`

**–í–∞–∂–Ω–æ:**
- ‚úÖ –ü—Ä–∏ DELETE –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –±–∞–ª–ª—ã **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∞ –Ω–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞

---

### 2.7. –°—Ü–µ–Ω–∞—Ä–∏–π 6: –û—Ç–º–µ–Ω–∞ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞

**–ú–µ—Å—Ç–æ:** `PATCH /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 148-160) –∏ `DELETE /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 1595-1616)

**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è (`order_status === 'cancelled'`)
- –ó–∞–∫–∞–∑ **–Ω–µ –±—ã–ª –æ–ø–ª–∞—á–µ–Ω** (`!wasPaid`)
- –ï—Å—Ç—å pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞—é—Ç—Å—è pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: `fetchPendingTransactionsByOrder(orderId)`
2. –î–ª—è –∫–∞–∂–¥–æ–π pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å: `transaction_status = 'cancelled'`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è, –±–∞–ª–ª—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è

**–í–∞–∂–Ω–æ:**
- ‚ö†Ô∏è `total_spent` **–ù–ï –û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø** –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ `total_spent` —É–∂–µ –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (–≤ `createPendingLoyaltyPoints`)
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –Ω—É–∂–Ω–æ **–û–¢–ö–ê–¢–ò–¢–¨** –∏–∑–º–µ–Ω–µ–Ω–∏–µ `total_spent`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ùå `total_spent` **–ù–ï –û–¢–ö–ê–¢–´–í–ê–ï–¢–°–Ø** –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
- ‚ùå –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é –º–µ–∂–¥—É `total_spent` –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏

---

### 2.8. –°—Ü–µ–Ω–∞—Ä–∏–π 7: –í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ (DELETE)

**–ú–µ—Å—Ç–æ:** `DELETE /api/orders/[id]` (—Å—Ç—Ä–æ–∫–∏ 1541-1594)

**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–∫–∞–∑ —É–¥–∞–ª—è–µ—Ç—Å—è
- –ó–∞–∫–∞–∑ **–±—ã–ª –æ–ø–ª–∞—á–µ–Ω** (`wasPaid === true`)
- `pointsEarned > 0` –∏–ª–∏ `pointsUsed > 0`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—É—á–∞—é—Ç—Å—è **–í–°–ï** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞: `fetchPendingTransactionsByOrder(orderId)`
2. –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
   - `actualPointsEarned` ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö `"earned"` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
   - `actualPointsUsed` ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö `"used"` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `refundLoyaltyPoints(userId, finalPointsEarned, finalPointsUsed, orderTotal, orderId)`
4. –°–æ–∑–¥–∞—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `"refunded"` –∏ `"cancelled"`

**–í–∞–∂–Ω–æ:**
- ‚úÖ –ü—Ä–∏ DELETE –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –±–∞–ª–ª—ã **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∞ –Ω–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞
- ‚ö†Ô∏è `total_spent` **–ù–ï –û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø** –≤ `refundLoyaltyPoints` ‚Äî —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
- ‚ùå `total_spent` **–ù–ï –û–¢–ö–ê–¢–´–í–ê–ï–¢–°–Ø** –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –±–∞–ª–ª–æ–≤
- ‚ùå –§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å: `newTotalSpent = currentTotalSpent - orderTotal + pointsUsed`
- ‚ùå –ù–æ –≤ `refundLoyaltyPoints` `total_spent` **–ù–ï –û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø**

---

## 3. –†–ê–ë–û–¢–ê –° –ü–†–û–ú–û–ö–û–î–ê–ú–ò –í –ö–õ–ò–ï–ù–¢–°–ö–û–ô –ß–ê–°–¢–ò

### 3.1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ OrderModal

**–ú–µ—Å—Ç–æ:** `components/order-modal.tsx` (—Å—Ç—Ä–æ–∫–∏ 739-871)

**–§—É–Ω–∫—Ü–∏—è:** `handleApplyPromo()`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `fetchPromoCode(code)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏–∑ –ë–î
3. –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏:
   - ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–µ–Ω
   - ‚úÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è (`valid_from`) ‚Äî –ø—Ä–æ–º–æ–∫–æ–¥ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è?
   - ‚úÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è (`valid_until`) ‚Äî –ø—Ä–æ–º–æ–∫–æ–¥ –∏—Å—Ç–µ–∫?
   - ‚úÖ –õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (`usage_limit`) ‚Äî –ø—Ä–æ–º–æ–∫–æ–¥ –∏—Å—á–µ—Ä–ø–∞–Ω?
   - ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ (`min_order_amount`) ‚Äî –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞?
4. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å–∫–∏–¥–∫–∞:
   - –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è: `calculatedDiscount = Math.floor(totalBeforeDiscount * (discountValue / 100))`
   - –° –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–æ–π: `calculatedDiscount = Math.min(calculatedDiscount, maxDiscount)`
   - –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è: `calculatedDiscount = Math.min(discountValue, totalBeforeDiscount)`
5. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `appliedPromo` –≤ state

**–í–∞–∂–Ω–æ:**
- ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ `totalBeforeDiscount` (—Å—É–º–º–∞ –ë–ï–ó —É—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤)
- ‚úÖ –°–∫–∏–¥–∫–∞ –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã: `finalTotal = totalBeforeDiscount - pointsDiscount - promoDiscount`

**–ö–æ–¥:**
```typescript
// components/order-modal.tsx:739-871
const handleApplyPromo = async () => {
  const promo = await fetchPromoCode(code)
  // –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏...
  // –†–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏...
  setAppliedPromo({ code: promoCode, discount: calculatedDiscount })
}
```

---

### 3.2. –ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

**–ú–µ—Å—Ç–æ:** `components/order-modal.tsx` (—Å—Ç—Ä–æ–∫–∏ 422-434, 472-484, 502-517)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `onRequestAuth` –ø—Ä–æ–º–æ–∫–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –æ–±—ä–µ–∫—Ç–µ `order`:
   ```typescript
   promoCode: appliedPromo?.code,
   promoDiscount: appliedPromo?.discount,
   ```

2. –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `onSave` –ø—Ä–æ–º–æ–∫–æ–¥ —Ç–∞–∫–∂–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è:
   ```typescript
   promoCode: appliedPromo?.code,
   promoDiscount: appliedPromo?.discount,
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∑–∞–∫–∞–∑–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ `handleAutoCheckout` –∏–ª–∏ `handleSaveOrder`

---

### 3.3. –ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

**–ú–µ—Å—Ç–æ:** `app/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 1994-2007)

**–§—É–Ω–∫—Ü–∏—è:** `handlePaymentComplete()`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ PATCH –∑–∞–ø—Ä–æ—Å–µ:
   ```typescript
   promoCode: order.promoCode,
   promoDiscount: order.promoDiscount,
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞

---

### 3.4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ OrderModal

**–ú–µ—Å—Ç–æ:** `components/order-modal.tsx` (—Å—Ç—Ä–æ–∫–∏ 1094-1104)

**–£—Å–ª–æ–≤–∏—è:**
- `existingOrder.promoCode` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- `existingOrder.promoDiscount > 0`

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ"
- –§–æ—Ä–º–∞—Ç: `–ü—Ä–æ–º–æ–∫–æ–¥ {code}: -{discount} ‚ÇΩ`

---

### 3.5. –†–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º

**–ú–µ—Å—Ç–æ:** `components/order-modal.tsx` (—Å—Ç—Ä–æ–∫–∏ 368-405)

**–§–æ—Ä–º—É–ª–∞:**
```typescript
const totalBeforeDiscount = calculateTotal() // –°—É–º–º–∞ –≤—Å–µ—Ö –±–ª—é–¥ –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π
const finalTotal = Math.max(0, totalBeforeDiscount - pointsDiscount - (appliedPromo?.discount || 0))
```

**–í–∞–∂–Ω–æ:**
- ‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Å—É–º–º–µ **–ë–ï–ó** —É—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤
- ‚úÖ –°–∫–∏–¥–∫–∞ –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã

---

### 3.6. ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–§—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:** `incrementPromoCodeUsage(id: number)` –≤ `lib/nocodb.ts:2444-2453`

**–ì–¥–µ –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è:**
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ (POST)
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ (PATCH)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚ùå –§—É–Ω–∫—Ü–∏—è `incrementPromoCodeUsage` **–ù–ò–ì–î–ï –ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø**
- ‚ùå –°—á–µ—Ç—á–∏–∫ `times_used` **–ù–ï –ò–ù–ö–†–ï–ú–ï–ù–¢–ò–†–£–ï–¢–°–Ø** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚ö†Ô∏è –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (`FIX_PROMO_CODES_AND_HOME_ERROR_2026_01_15.md:159`) —É–∫–∞–∑–∞–Ω–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤, –Ω–æ —ç—Ç–æ **–ù–ï –°–î–ï–õ–ê–ù–û**

**–ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
1. `app/api/orders/route.ts` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
2. `app/api/orders/[id]/route.ts` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º

---

### 3.7. ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ (usage_type)

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–¢–∏–ø—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
- `unlimited` ‚Äî –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- `once_per_user` ‚Äî –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `once_total` ‚Äî –≤—Å–µ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑ (–¥–ª—è –≤—Å–µ—Ö)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ `usage_type` **–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê** –≤ `handleApplyPromo`
- ‚ùå –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–±—â–∏–π –ª–∏–º–∏—Ç (`usage_limit`), –Ω–æ –Ω–µ —Ç–∏–ø –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚ö†Ô∏è –ü–æ–ª–µ `usage_type` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏, –Ω–æ **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏

**–ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- `components/order-modal.tsx` ‚Äî –≤ —Ñ—É–Ω–∫—Ü–∏—é `handleApplyPromo()`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è `once_per_user`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –¥–ª—è `once_total`

---

## 4. –†–ê–ë–û–¢–ê –° –ü–†–û–ú–û–ö–û–î–ê–ú–ò –í –ü–ê–ù–ï–õ–ò –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê

### 4.1. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

**–ú–µ—Å—Ç–æ:** `app/admin/promo/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 61-71)

**–§—É–Ω–∫—Ü–∏—è:** `loadPromoCodes()`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã —á–µ—Ä–µ–∑ `/api/db/Promo_Codes/records?limit=1000&sort=-Id`
2. –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

---

### 4.2. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–ú–µ—Å—Ç–æ:** `app/admin/promo/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 121-173)

**–§—É–Ω–∫—Ü–∏—è:** `handleSubmit()`

**–ü–æ–ª—è:**
- `code` ‚Äî –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `discount_type` ‚Äî —Ç–∏–ø —Å–∫–∏–¥–∫–∏: "percentage" | "fixed"
- `discount_value` ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
- `usage_type` ‚Äî —Ç–∏–ø –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: "unlimited" | "once_per_user" | "once_total"
- `valid_from` ‚Äî –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `valid_until` ‚Äî –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `active` ‚Äî –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥
- `comment` ‚Äî –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç `promoData`
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/db/Promo_Codes/records`
3. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

---

### 4.3. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–ú–µ—Å—Ç–æ:** `app/admin/promo/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 175-188)

**–§—É–Ω–∫—Ü–∏—è:** `handleEdit()`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞
2. –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è PATCH –∑–∞–ø—Ä–æ—Å

---

### 4.4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–ú–µ—Å—Ç–æ:** `app/admin/promo/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 190-215)

**–§—É–Ω–∫—Ü–∏—è:** `handleToggleActive()`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è PATCH –∑–∞–ø—Ä–æ—Å —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–ª—è `active`
2. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

---

### 4.5. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

**–ú–µ—Å—Ç–æ:** `app/admin/promo/page.tsx` (—Å—Ç—Ä–æ–∫–∏ 73-119)

**–§—É–Ω–∫—Ü–∏—è:** `filterPromoCodes()`

**–§–∏–ª—å—Ç—Ä—ã:**
- –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É
- –ü–æ —Å—Ç–∞—Ç—É—Å—É: "all" | "active" | "inactive" | "deactivated"

**–õ–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:**
- "active" ‚Äî `active === true` –ò –¥–∞—Ç—ã –≤–∞–ª–∏–¥–Ω—ã
- "inactive" ‚Äî –¥–∞—Ç—ã –Ω–µ –≤–∞–ª–∏–¥–Ω—ã (–µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è –∏–ª–∏ –∏—Å—Ç–µ–∫)
- "deactivated" ‚Äî `active === false`

---

### 4.6. ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π min_order_amount –∏ max_discount –≤ —Ñ–æ—Ä–º–µ

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–ß–ê–°–¢–ò–ß–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ –ü–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Å—Ö–µ–º–µ –ë–î (`app/api/db/setup-tables/route.ts:160-161`)
- ‚úÖ –ü–æ–ª—è **–ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø** –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏ (`components/order-modal.tsx:813, 827`)
- ‚ùå –ü–æ–ª—è **–ù–ï –û–¢–û–ë–†–ê–ñ–ê–Æ–¢–°–Ø** –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- ‚ùå –ü–æ–ª—è **–ù–ï –ú–û–ì–£–¢ –ë–´–¢–¨ –£–°–¢–ê–ù–û–í–õ–ï–ù–´** —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

**–ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- `app/admin/promo/page.tsx` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Ñ–æ—Ä–º—É (—Å—Ç—Ä–æ–∫–∏ 440-552)

**–¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- `min_order_amount` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ `handleApplyPromo()` (—Å—Ç—Ä–æ–∫–∞ 813-822)
- `max_discount` ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å–∫–∏–¥–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 827, 836-838)

---

## 5. –ü–†–û–ë–õ–ï–ú–´ –ò –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø

### 5.1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 1: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –§—É–Ω–∫—Ü–∏—è `incrementPromoCodeUsage()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ **–ù–ò–ì–î–ï –ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø**
- –°—á–µ—Ç—á–∏–∫ `times_used` **–ù–ï –û–ë–ù–û–í–õ–Ø–ï–¢–°–Ø** –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞

**–ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
1. `app/api/orders/route.ts` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
2. `app/api/orders/[id]/route.ts` ‚Äî –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ —Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–º

**–ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:**
```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞
if (order.promoCode) {
  const promo = await fetchPromoCode(order.promoCode)
  if (promo) {
    await incrementPromoCodeUsage(promo.Id)
  }
}
```

---

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ–ª–µ `usage_type` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `usage_type` **–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê** –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ `once_per_user` –∏–ª–∏ `once_total` –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ

**–ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- `components/order-modal.tsx` ‚Äî –≤ —Ñ—É–Ω–∫—Ü–∏—é `handleApplyPromo()`

**–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```typescript
if (promo.usage_type === 'once_per_user') {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userOrders = await fetchOrders(userId)
  const hasUsedPromo = userOrders.some(o => o.promoCode === code)
  if (hasUsedPromo) {
    // –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  }
}

if (promo.usage_type === 'once_total') {
  const timesUsed = promo.times_used || 0
  if (timesUsed >= 1) {
    // –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
  }
}
```

---

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π min_order_amount –∏ max_discount –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Å—Ö–µ–º–µ –ë–î
- –ü–æ–ª—è **–ù–ï –û–¢–û–ë–†–ê–ñ–ê–Æ–¢–°–Ø** –≤ —Ñ–æ—Ä–º–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä **–ù–ï –ú–û–ñ–ï–¢** —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–∏–¥–∫—É

**–ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- `app/admin/promo/page.tsx` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Ñ–æ—Ä–º—É

---

### 5.2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å total_spent

#### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ 4: total_spent –ù–ï –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ `total_spent` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è: `newTotalSpent = currentTotalSpent + orderTotal - pointsUsed`
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞ `total_spent` **–ù–ï –û–¢–ö–ê–¢–´–í–ê–ï–¢–°–Ø**
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é –º–µ–∂–¥—É `total_spent` –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ –±–∞–ª–ª–∞–º–∏

**–ì–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- `refundLoyaltyPoints()` ‚Äî **–ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç** `total_spent`
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ `total_spent` –æ—Å—Ç–∞–µ—Ç—Å—è —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º

**–§–æ—Ä–º—É–ª–∞ –¥–ª—è –æ—Ç–∫–∞—Ç–∞:**
```typescript
newTotalSpent = currentTotalSpent - orderTotal + pointsUsed
```

**–ì–¥–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- `lib/nocodb.ts` ‚Äî –≤ —Ñ—É–Ω–∫—Ü–∏—é `refundLoyaltyPoints()`

---

### 5.3. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 5: –†–∞—Å—á–µ—Ç orderTotal –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –í –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ—Å—á–µ—Ç `orderTotal` –¥–ª—è —É—á–µ—Ç–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
- –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö

**–ú–µ—Å—Ç–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞:**
1. `app/api/orders/route.ts:594-605` ‚Äî –ø–µ—Ä–µ—Å—á–µ—Ç –≤ POST
2. `app/api/orders/[id]/route.ts:1134-1164` ‚Äî –ø–µ—Ä–µ—Å—á–µ—Ç –≤ PATCH partial
3. `app/api/orders/[id]/route.ts:460-471` ‚Äî –ø–µ—Ä–µ—Å—á–µ—Ç –≤ PATCH full

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç `orderTotal` –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É: `orderTotal = subtotal + delivery_fee - promo_discount`

---

#### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 6: –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ï—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ `existingPointsEarned > 0` –ø–µ—Ä–µ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º
- –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –≤ race conditions

**–¢–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `loyalty_points_earned` –≤ –∑–∞–∫–∞–∑–µ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `(order_id, transaction_type, transaction_status)`

---

## 6. –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ö–ê–ñ–î–û–ì–û –°–¶–ï–ù–ê–†–ò–Ø

### 6.1. –°—Ü–µ–Ω–∞—Ä–∏–π: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–æ–π –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–º

**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –±–ª—é–¥–∞ –≤ `OrderModal`
2. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ ‚Üí `handleApplyPromo()` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ ‚Üí —Ä–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏
3. –ù–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" ‚Üí `handlePayAndOrder()` ‚Üí `onRequestAuth(order, total)`
4. `handleAutoCheckout()` ‚Üí —Ä–∞—Å—á–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ POST
5. POST `/api/orders`:
   - –†–∞—Å—á–µ—Ç `calculatedTotal` (—Å—É–º–º–∞ –±–ª—é–¥)
   - –†–∞—Å—á–µ—Ç `deliveryFee`
   - –†–∞—Å—á–µ—Ç `finalTotal = calculatedTotal + deliveryFee - promoDiscount`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ –∑–∞–∫–∞–∑: `promo_code`, `promo_discount`
   - **–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã): —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `"used"`
   - **–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤**: `awardLoyaltyPoints()` ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `"earned"`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `total_spent` –∏ `loyalty_points`
6. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è `PaymentModal`
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
8. PATCH `/api/orders/[id]`:
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
   - –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå `incrementPromoCodeUsage()` **–ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø** –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ `usage_type` **–ù–ï –í–´–ü–û–õ–ù–Ø–ï–¢–°–Ø** –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞

---

### 6.2. –°—Ü–µ–Ω–∞—Ä–∏–π: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –Ω–∞–ª–∏—á–Ω—ã–º–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–º

**–®–∞–≥–∏:**
1-4. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏—é 6.1
5. POST `/api/orders`:
   - –†–∞—Å—á–µ—Ç `finalTotal = calculatedTotal + deliveryFee - promoDiscount`
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –≤ –∑–∞–∫–∞–∑
   - **–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã): —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ `"used"`
   - **–°–æ–∑–¥–∞–Ω–∏–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: `createPendingLoyaltyPoints()` ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"earned"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"pending"`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `total_spent` —Å—Ä–∞–∑—É
   - –ë–∞–ª–∞–Ω—Å **–ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è** (pending)
6. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è `PaymentModal`
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–ù–∞–ª–∏—á–Ω—ã–µ" –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–∫–∞–∑
8. PATCH `/api/orders/[id]`:
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã –Ω–∞ "cash"
   - –ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
9. –ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏:
   - Cron job –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
   - –ù–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã: `newLoyaltyPoints = currentLoyaltyPoints + points`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: `transaction_status = 'completed'`

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå `incrementPromoCodeUsage()` **–ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø** –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
- ‚ùå `incrementPromoCodeUsage()` **–ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø** –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–ª–∏—á–Ω—ã–º–∏

---

### 6.3. –°—Ü–µ–Ω–∞—Ä–∏–π: –°–º–µ–Ω–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã —Å –Ω–∞–ª–∏—á–Ω—ã—Ö –Ω–∞ –æ–Ω–ª–∞–π–Ω

**–®–∞–≥–∏:**
1. –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —Å `paymentMethod = 'cash'`
2. –°–æ–∑–¥–∞–Ω–∞ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–∞ "card" –∏–ª–∏ "sbp"
4. PATCH `/api/orders/[id]`:
   - –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è —Å–º–µ–Ω–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã: `isPaymentMethodChangedFromCash = true`
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `processPendingTransactionsForOrder()`:
     - –ù–∞—Ö–æ–¥–∏—Ç pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞
     - –ù–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
     - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ `"completed"`
   - –ï—Å–ª–∏ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ –±—ã–ª–æ:
     - –ù–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã —á–µ—Ä–µ–∑ `awardLoyaltyPoints()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Pending –±–∞–ª–ª—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Å—Ä–∞–∑—É

---

### 6.4. –°—Ü–µ–Ω–∞—Ä–∏–π: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

**–®–∞–≥–∏:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `PaymentModal`
2. –í–∫–ª—é—á–∞–µ—Ç "–°–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã"
3. –í—ã–±–∏—Ä–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ (–º–∞–∫—Å–∏–º—É–º 50% –æ—Ç —Å—É–º–º—ã)
4. –ù–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å"
5. `handlePaymentComplete()` ‚Üí PATCH `/api/orders/[id]`:
   - –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è `loyaltyPointsUsed`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è: `existingPointsUsed === 0`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å: `currentBalance >= loyaltyPointsUsed`
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"used"` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å: `newBalance = currentBalance - loyaltyPointsUsed`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `total_spent`: `newTotalSpent = currentTotalSpent + orderTotal - loyaltyPointsUsed`

**–í–∞–∂–Ω–æ:**
- ‚úÖ –ë–∞–ª–ª—ã —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è **–î–û** –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –±–∞–ª–ª–æ–≤
- ‚úÖ –ü—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `orderTotal` (–ø–æ–ª–Ω–∞—è —Å—É–º–º–∞), –∞ –Ω–µ `orderTotal - pointsUsed`

---

### 6.5. –°—Ü–µ–Ω–∞—Ä–∏–π: –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º –±–∞–ª–ª–æ–≤

**–®–∞–≥–∏:**
1. –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è (—á–µ—Ä–µ–∑ PATCH –∏–ª–∏ DELETE)
2. –ü–æ–ª—É—á–∞—é—Ç—Å—è **–í–°–ï** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞: `fetchPendingTransactionsByOrder(orderId)`
3. –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:
   - `actualPointsEarned` ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö `"earned"` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
   - `actualPointsUsed` ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö `"used"` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"completed"`
4. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `refundLoyaltyPoints(userId, finalPointsEarned, finalPointsUsed, orderTotal, orderId)`:
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"refunded"`: `points: +pointsUsed` (–≤–æ–∑–≤—Ä–∞—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö)
   - –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `"cancelled"`: `points: -pointsEarned` (—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö)
5. –ë–∞–ª–∞–Ω—Å –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º `fetchUserById()`

**–í–∞–∂–Ω–æ:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∞ –Ω–µ –ø–æ–ª—è –∑–∞–∫–∞–∑–∞
- ‚úÖ –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## 7. –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 7.1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞**
   - –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `incrementPromoCodeUsage()` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞
   - –ú–µ—Å—Ç–∞: `app/api/orders/route.ts` –∏ `app/api/orders/[id]/route.ts`
   - **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞**
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `usage_type` –≤ `handleApplyPromo()`
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è `once_per_user`
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –¥–ª—è `once_total`
   - **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

3. **–ü–æ–ª—è min_order_amount –∏ max_discount –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏**
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
   - **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

4. **–û—Ç–∫–∞—Ç total_spent –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞**
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `total_spent` –≤ `refundLoyaltyPoints()`
   - –§–æ—Ä–º—É–ª–∞: `newTotalSpent = currentTotalSpent - orderTotal + pointsUsed`
   - **–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û

### 7.2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ orderTotal**
   - –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ `orderTotal` —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–∑–¥–µ: `orderTotal = subtotal + delivery_fee - promo_discount`

2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–ª–∞–º–∏ –∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–∞—Å—á–µ—Ç—ã

---

## 8. –ò–°–¢–û–†–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô

### 2026-01-15
- ‚úÖ –°–æ–∑–¥–∞–Ω —ç—Ç–∞–ª–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø–æ–ª–Ω—ã–º —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏–∑ `DATA_ARCHITECTURE_RULES.md`
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —ç—Ç–∞–ª–æ–Ω–Ω—ã–π

---

## 9. –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã** –¥–ª—è:
- –í—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ (earned)
- –í—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤ (used)
- –†–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏
- –†–∞–±–æ—Ç—ã —Å –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –í—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

**–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–ª–ª–∞–º–∏ –∏–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏:**
1. –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —ç—Ç–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –∫–∞–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
3. –û–±–Ω–æ–≤–ª—è–π—Ç–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–ª–∞–º–∏/–ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–≠–¢–ê–õ–û–ù** ‚Äî –ó–∞–≤–µ—Ä—à–µ–Ω–æ
