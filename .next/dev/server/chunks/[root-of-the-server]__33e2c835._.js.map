{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/sergejasasnev/Downloads/my-project%20%281%29/app/api/db/export-data/route.ts"],"sourcesContent":["// API route для выгрузки всех данных из таблиц NocoDB\n// Помогает проверить, что реально сохранено в базе\n\nimport { NextResponse } from \"next/server\"\n\nfunction getTableId(tableName: string): string {\n  const tableIds: Record<string, string | undefined> = {\n    Meals: process.env.NOCODB_TABLE_MEALS,\n    Extras: process.env.NOCODB_TABLE_EXTRAS,\n    Delivery_Zones: process.env.NOCODB_TABLE_DELIVERY_ZONES,\n    Users: process.env.NOCODB_TABLE_USERS,\n    Orders: process.env.NOCODB_TABLE_ORDERS,\n    Order_Persons: process.env.NOCODB_TABLE_ORDER_PERSONS,\n    Order_Meals: process.env.NOCODB_TABLE_ORDER_MEALS,\n    Order_Extras: process.env.NOCODB_TABLE_ORDER_EXTRAS,\n    Promo_Codes: process.env.NOCODB_TABLE_PROMO_CODES,\n    Reviews: process.env.NOCODB_TABLE_REVIEWS,\n  }\n  return tableIds[tableName] || \"\"\n}\n\nexport async function GET() {\n  const NOCODB_URL = process.env.NOCODB_URL\n  const NOCODB_TOKEN = process.env.NOCODB_TOKEN\n\n  if (!NOCODB_URL || !NOCODB_TOKEN) {\n    return NextResponse.json(\n      {\n        error: \"NocoDB not configured\",\n        message: \"NOCODB_URL и NOCODB_TOKEN должны быть установлены\",\n      },\n      { status: 500 },\n    )\n  }\n\n  const baseUrl = NOCODB_URL.replace(/\\/api\\/v2\\/?$/, \"\")\n  const apiUrl = baseUrl.endsWith(\"/api/v2\") ? baseUrl : `${baseUrl}/api/v2`\n  \n  const tableNames = [\n    \"Meals\",\n    \"Extras\",\n    \"Delivery_Zones\",\n    \"Users\",\n    \"Orders\",\n    \"Order_Persons\",\n    \"Order_Meals\",\n    \"Order_Extras\",\n    \"Promo_Codes\",\n    \"Reviews\",\n  ]\n\n  const results: Record<string, any> = {}\n\n  for (const tableName of tableNames) {\n    const tableId = getTableId(tableName)\n    \n    if (!tableId) {\n      results[tableName] = {\n        status: \"not_configured\",\n        error: `NOCODB_TABLE_${tableName.toUpperCase()} не установлен`,\n        count: 0,\n        data: [],\n      }\n      continue\n    }\n\n    try {\n      const recordsUrl = `${apiUrl}/tables/${tableId}/records?limit=1000`\n      const response = await fetch(recordsUrl, {\n        headers: {\n          \"xc-token\": NOCODB_TOKEN,\n          \"Content-Type\": \"application/json\",\n        },\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text()\n        results[tableName] = {\n          status: \"error\",\n          error: `HTTP ${response.status}: ${errorText}`,\n          count: 0,\n          data: [],\n        }\n        continue\n      }\n\n      const data = await response.json()\n      const records = data?.list || []\n      \n      results[tableName] = {\n        status: \"ok\",\n        tableId,\n        count: records.length,\n        data: records,\n        sample: records.length > 0 ? records[0] : null,\n      }\n    } catch (error) {\n      results[tableName] = {\n        status: \"error\",\n        error: error instanceof Error ? error.message : String(error),\n        count: 0,\n        data: [],\n      }\n    }\n  }\n\n  // Подсчитываем общую статистику\n  const stats = {\n    totalTables: tableNames.length,\n    configuredTables: Object.values(results).filter((r) => r.status !== \"not_configured\").length,\n    accessibleTables: Object.values(results).filter((r) => r.status === \"ok\").length,\n    totalRecords: Object.values(results).reduce((sum, r) => sum + (r.count || 0), 0),\n    tablesWithData: Object.values(results).filter((r) => r.status === \"ok\" && r.count > 0).length,\n  }\n\n  return NextResponse.json({\n    success: true,\n    timestamp: new Date().toISOString(),\n    stats,\n    tables: results,\n    summary: {\n      message: `Найдено ${stats.totalRecords} записей в ${stats.tablesWithData} таблицах`,\n      emptyTables: tableNames.filter((name) => results[name]?.status === \"ok\" && results[name]?.count === 0),\n      tablesWithData: tableNames.filter((name) => results[name]?.status === \"ok\" && results[name]?.count > 0),\n    },\n  })\n}\n\n"],"names":[],"mappings":"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"}}]
}