{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/sergejasasnev/Downloads/my-project%20%281%29/lib/nocodb.ts"],"sourcesContent":["// NocoDB API client - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API proxy\n// –¢–æ–∫–µ–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL –¥–ª—è API proxy\n// –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π URL, –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π\nconst getApiBaseUrl = () => {\n  if (typeof window !== \"undefined\") {\n    return \"/api/db\"\n  }\n  return null\n}\n\nfunction getNocoDBUrl(): string {\n  return process.env.NOCODB_URL || \"\"\n}\n\nfunction getNocoDBToken(): string {\n  return process.env.NOCODB_TOKEN || \"\"\n}\n\nfunction getTableId(tableName: string): string {\n  const tableIds: Record<string, string | undefined> = {\n    Meals: process.env.NOCODB_TABLE_MEALS,\n    Extras: process.env.NOCODB_TABLE_EXTRAS,\n    Delivery_Zones: process.env.NOCODB_TABLE_DELIVERY_ZONES,\n    Users: process.env.NOCODB_TABLE_USERS,\n    Orders: process.env.NOCODB_TABLE_ORDERS,\n    Order_Persons: process.env.NOCODB_TABLE_ORDER_PERSONS,\n    Order_Meals: process.env.NOCODB_TABLE_ORDER_MEALS,\n    Order_Extras: process.env.NOCODB_TABLE_ORDER_EXTRAS,\n    Promo_Codes: process.env.NOCODB_TABLE_PROMO_CODES,\n    Reviews: process.env.NOCODB_TABLE_REVIEWS,\n  }\n\n  return tableIds[tableName] || \"\"\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏\nfunction validateNocoDBConfig(): { isValid: boolean; error?: string } {\n  const url = getNocoDBUrl()\n  const token = getNocoDBToken()\n  const mealsTable = process.env.NOCODB_TABLE_MEALS\n\n  if (!url || !token) {\n    return { isValid: false, error: \"NOCODB_URL or NOCODB_TOKEN not set\" }\n  }\n  if (!mealsTable) {\n    return { isValid: false, error: \"NOCODB_TABLE_MEALS not set\" }\n  }\n  return { isValid: true }\n}\n\nexport function isNocoDBConfigured(): boolean {\n  return validateNocoDBConfig().isValid\n}\n\n// –¢–∏–ø—ã –¥–ª—è NocoDB –æ—Ç–≤–µ—Ç–æ–≤\ninterface NocoDBResponse<T> {\n  list: T[]\n  pageInfo?: {\n    totalRows: number\n    page: number\n    pageSize: number\n    isFirstPage: boolean\n    isLastPage: boolean\n  }\n}\n\nfunction buildNocoDBUrl(tableName: string, params: Record<string, string> = {}): string {\n  const queryString = new URLSearchParams(params).toString()\n  let baseUrl = getNocoDBUrl().replace(/\\/$/, \"\")\n\n  if (!baseUrl.endsWith(\"/api/v2\")) {\n    baseUrl = `${baseUrl}/api/v2`\n  }\n\n  const tableId = getTableId(tableName)\n\n  if (!tableId) {\n    throw new Error(`TABLE_NOT_CONFIGURED:${tableName}`)\n  }\n\n  return `${baseUrl}/tables/${tableId}/records${queryString ? `?${queryString}` : \"\"}`\n}\n\n// –°–µ—Ä–≤–µ—Ä–Ω—ã–π fetch –Ω–∞–ø—Ä—è–º—É—é –∫ NocoDB (–¥–ª—è ISR)\nasync function serverFetch<T>(tableName: string, params: Record<string, string> = {}): Promise<T> {\n  const config = validateNocoDBConfig()\n  if (!config.isValid) {\n    throw new Error(`NocoDB is not configured: ${config.error}`)\n  }\n\n  const url = buildNocoDBUrl(tableName, params)\n  const token = getNocoDBToken()\n\n  const response = await fetch(url, {\n    headers: {\n      \"xc-token\": token,\n      \"Content-Type\": \"application/json\",\n    },\n    next: { revalidate: 3600 },\n  })\n\n  const text = await response.text()\n\n  if (!response.ok) {\n    if (text.includes(\"TABLE_NOT_FOUND\") || response.status === 404) {\n      throw new Error(`TABLE_NOT_FOUND:${tableName}`)\n    }\n    throw new Error(`NocoDB API error: ${response.status} - ${text}`)\n  }\n\n  try {\n    return JSON.parse(text)\n  } catch {\n    throw new Error(`NocoDB returned invalid JSON: ${text.substring(0, 100)}...`)\n  }\n}\n\n// –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –Ω–∞–ø—Ä—è–º—É—é –∫ NocoDB\nasync function serverCreateRecord<T>(\n  tableName: string,\n  data: any,\n  method: \"POST\" | \"PATCH\" = \"POST\",\n  recordId?: number,\n): Promise<T> {\n  const config = validateNocoDBConfig()\n  if (!config.isValid) {\n    throw new Error(`NocoDB is not configured: ${config.error}`)\n  }\n\n  let baseUrl = getNocoDBUrl().replace(/\\/$/, \"\")\n  if (!baseUrl.endsWith(\"/api/v2\")) {\n    baseUrl = `${baseUrl}/api/v2`\n  }\n\n  const tableId = getTableId(tableName)\n  if (!tableId) {\n    throw new Error(`TABLE_NOT_CONFIGURED:${tableName}`)\n  }\n\n  const url = method === \"PATCH\" && recordId\n    ? `${baseUrl}/tables/${tableId}/records/${recordId}`\n    : `${baseUrl}/tables/${tableId}/records`\n\n  const token = getNocoDBToken()\n\n  const response = await fetch(url, {\n    method,\n    headers: {\n      \"xc-token\": token,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify(data),\n  })\n\n  const text = await response.text()\n\n  if (!response.ok) {\n    if (text.includes(\"TABLE_NOT_FOUND\") || response.status === 404) {\n      throw new Error(`TABLE_NOT_FOUND:${tableName}`)\n    }\n    throw new Error(`NocoDB API error: ${response.status} - ${text}`)\n  }\n\n  try {\n    const result = JSON.parse(text)\n    // NocoDB –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö\n    if (Array.isArray(result)) {\n      return result[0] as T\n    }\n    if (result && typeof result === 'object' && 'Id' in result) {\n      return result as T\n    }\n    if (result && typeof result === 'object' && 'record' in result) {\n      return result.record as T\n    }\n    return result as T\n  } catch {\n    throw new Error(`NocoDB returned invalid JSON: ${text.substring(0, 100)}...`)\n  }\n}\n\n// –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π fetch —á–µ—Ä–µ–∑ API proxy\nasync function clientFetch<T>(\n  tableName: string,\n  params: Record<string, string> = {},\n  options: RequestInit = {},\n): Promise<T> {\n  const queryString = new URLSearchParams(params).toString()\n  const url = `/api/db/${tableName}/records${queryString ? `?${queryString}` : \"\"}`\n\n  const response = await fetch(url, {\n    ...options,\n    headers: {\n      \"Content-Type\": \"application/json\",\n      ...options.headers,\n    },\n  })\n\n  const text = await response.text()\n\n  if (!response.ok) {\n    if (text.includes(\"TABLE_NOT_FOUND\") || response.status === 404) {\n      throw new Error(`TABLE_NOT_FOUND:${tableName}`)\n    }\n    throw new Error(`API error: ${response.status} - ${text}`)\n  }\n\n  try {\n    return JSON.parse(text)\n  } catch {\n    throw new Error(`API returned invalid JSON: ${text.substring(0, 100)}...`)\n  }\n}\n\n// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fetch\nasync function nocoFetch<T>(\n  tableName: string,\n  params: Record<string, string> = {},\n  options: RequestInit = {},\n): Promise<T> {\n  const apiBaseUrl = getApiBaseUrl()\n\n  if (apiBaseUrl === null) {\n    return serverFetch<T>(tableName, params)\n  } else {\n    return clientFetch<T>(tableName, params, options)\n  }\n}\n\n// === MEALS ===\n\nexport interface NocoDBMeal {\n  Id: number\n  name: string\n  category: string\n  ingredients: string\n  description?: string\n  price: number | string\n  price_single?: number | string\n  price_medium?: number | string\n  price_large?: number | string\n  weight?: number | string\n  weight_single?: number | string\n  weight_medium?: number | string\n  weight_large?: number | string\n  image?: string\n  available?: boolean | string\n  needs_garnish?: boolean | string\n  calories?: number | string\n  protein?: number | string\n  fats?: number | string\n  carbs?: number | string\n  is_current_week?: boolean | string\n  is_next_week?: boolean | string\n}\n\nexport async function fetchMeals(weekFilter?: \"current\" | \"next\"): Promise<NocoDBMeal[]> {\n  try {\n    const params: Record<string, string> = {\n      limit: \"1000\",\n    }\n\n    const response = await nocoFetch<NocoDBResponse<NocoDBMeal>>(\"Meals\", params)\n    console.log(\n      `[v0] fetchMeals: got ${response.list?.length || 0} meals, first item:`,\n      JSON.stringify(response.list?.[0] || {}).substring(0, 200),\n    )\n    return response.list || []\n  } catch (error) {\n    if (error instanceof Error && error.message.startsWith(\"TABLE_NOT_FOUND\")) {\n      console.warn(\"Table Meals not found in NocoDB, returning empty array\")\n      return []\n    }\n    throw error\n  }\n}\n\n// === EXTRAS ===\n\nexport interface NocoDBExtra {\n  Id: number\n  name: string\n  category: string\n  ingredients?: string\n  description?: string\n  price: number | string\n  image?: string\n  available?: boolean | string\n  calories?: number | string\n  protein?: number | string\n  fats?: number | string\n  carbs?: number | string\n  weight?: number | string\n}\n\nexport async function fetchExtras(): Promise<NocoDBExtra[]> {\n  try {\n    const response = await nocoFetch<NocoDBResponse<NocoDBExtra>>(\"Extras\", {\n      limit: \"1000\",\n    })\n    console.log(\n      `[v0] fetchExtras: got ${response.list?.length || 0} extras, first item:`,\n      JSON.stringify(response.list?.[0] || {}).substring(0, 200),\n    )\n    return response.list || []\n  } catch (error) {\n    if (error instanceof Error && error.message.startsWith(\"TABLE_NOT_FOUND\")) {\n      console.warn(\"Table Extras not found in NocoDB, returning empty array\")\n      return []\n    }\n    throw error\n  }\n}\n\n// === DELIVERY ZONES ===\n\nexport interface NocoDBDeliveryZone {\n  Id: number\n  city: string\n  district?: string\n  delivery_fee: number | string\n  min_order_amount: number | string\n  is_available?: boolean | string\n  available_intervals?: string\n}\n\nexport async function fetchDeliveryZones(): Promise<NocoDBDeliveryZone[]> {\n  try {\n    const response = await nocoFetch<NocoDBResponse<NocoDBDeliveryZone>>(\"Delivery_Zones\", {\n      // where: \"(is_available,eq,true)\",\n    })\n    console.log(`[v0] fetchDeliveryZones: got ${response.list?.length || 0} zones, first item:`, response.list?.[0])\n    return response.list || []\n  } catch (error) {\n    if (error instanceof Error && error.message.startsWith(\"TABLE_NOT_FOUND\")) {\n      console.warn(\"Table Delivery_Zones not found in NocoDB, returning empty array\")\n      return []\n    }\n    throw error\n  }\n}\n\n// === USERS ===\n\nexport interface NocoDBUser {\n  Id: number\n  phone: string\n  password_hash?: string\n  name: string\n  additional_phone?: string\n  street?: string\n  building?: string\n  building_section?: string\n  apartment?: string\n  entrance?: string\n  floor?: string\n  intercom?: string\n  district?: string\n  delivery_comment?: string\n  loyalty_points: number | string\n  total_spent: number | string\n  created_at: string\n  updated_at: string\n}\n\nexport async function fetchUserByPhone(phone: string): Promise<NocoDBUser | null> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBUser>>(\"Users\", {\n    where: `(phone,eq,${phone})`,\n  })\n  return response.list?.[0] || null\n}\n\nexport async function fetchUserById(id: number): Promise<NocoDBUser | null> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBUser>>(\"Users\", {\n    where: `(Id,eq,${id})`,\n  })\n  return response.list?.[0] || null\n}\n\nexport async function createUser(user: Omit<NocoDBUser, \"Id\" | \"created_at\" | \"updated_at\">): Promise<NocoDBUser> {\n  const apiBaseUrl = getApiBaseUrl()\n  \n  if (apiBaseUrl === null) {\n    return serverCreateRecord<NocoDBUser>(\"Users\", user, \"POST\")\n  } else {\n    const response = await clientFetch<any>(\n      \"Users\",\n      {},\n      {\n        method: \"POST\",\n        body: JSON.stringify(user),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      return response[0] as NocoDBUser\n    }\n    \n    if (response && typeof response === 'object' && 'Id' in response) {\n      return response as NocoDBUser\n    }\n    \n    if (response && typeof response === 'object' && 'record' in response) {\n      return response.record as NocoDBUser\n    }\n    \n    return response as NocoDBUser\n  }\n}\n\nexport async function updateUser(id: number, data: Partial<NocoDBUser>): Promise<NocoDBUser> {\n  const apiBaseUrl = getApiBaseUrl()\n  \n  if (apiBaseUrl === null) {\n    return serverCreateRecord<NocoDBUser>(\"Users\", data, \"PATCH\", id)\n  } else {\n    const response = await clientFetch<any>(\n      `Users/${id}`,\n      {},\n      {\n        method: \"PATCH\",\n        body: JSON.stringify(data),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      return response[0] as NocoDBUser\n    }\n    \n    if (response && typeof response === 'object' && 'Id' in response) {\n      return response as NocoDBUser\n    }\n    \n    if (response && typeof response === 'object' && 'record' in response) {\n      return response.record as NocoDBUser\n    }\n    \n    return response as NocoDBUser\n  }\n}\n\n// === ORDERS ===\n\nexport interface NocoDBOrder {\n  Id: number\n  user_id?: number\n  order_number: string\n  start_date: string\n  delivery_time: string\n  status: \"pending\" | \"paid\" | \"delivered\" | \"cancelled\"\n  payment_method: \"card\" | \"sbp\" | \"cash\"\n  paid?: boolean | string\n  paid_at?: string\n  delivered?: boolean | string\n  cancelled?: boolean | string\n  promo_code?: string\n  promo_discount?: number | string\n  loyalty_points_used: number | string\n  loyalty_points_earned: number | string\n  subtotal: number | string\n  total: number | string\n  guest_phone?: string\n  guest_address?: string\n  created_at: string\n  updated_at: string\n}\n\nexport async function fetchOrders(userId?: number): Promise<NocoDBOrder[]> {\n  const params: Record<string, string> = {\n    limit: \"1000\",\n    sort: \"-start_date\",\n  }\n\n  if (userId) {\n    params.where = `(user_id,eq,${userId})`\n  }\n\n  const response = await nocoFetch<NocoDBResponse<NocoDBOrder>>(\"Orders\", params)\n  return response.list || []\n}\n\nexport async function fetchOrdersByUser(userId: number): Promise<NocoDBOrder[]> {\n  return fetchOrders(userId)\n}\n\nexport function generateOrderNumber(): string {\n  const now = new Date()\n  const date = now.toISOString().slice(0, 10).replace(/-/g, \"\")\n  const random = Math.random().toString(36).substring(2, 8).toUpperCase()\n  return `ORD-${date}-${random}`\n}\n\nexport async function fetchOrderById(id: number): Promise<NocoDBOrder | null> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBOrder>>(\"Orders\", {\n    where: `(Id,eq,${id})`,\n  })\n  return response.list?.[0] || null\n}\n\nexport async function createOrder(order: Omit<NocoDBOrder, \"Id\" | \"created_at\" | \"updated_at\">): Promise<NocoDBOrder> {\n  // –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ NocoDB, –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ - —á–µ—Ä–µ–∑ proxy\n  const apiBaseUrl = getApiBaseUrl()\n  \n  let createdOrder: NocoDBOrder\n  \n  if (apiBaseUrl === null) {\n    // –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Å—Ä–µ–¥–∞ - –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ NocoDB\n    createdOrder = await serverCreateRecord<NocoDBOrder>(\"Orders\", order, \"POST\")\n  } else {\n    // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ä–µ–¥–∞ - —á–µ—Ä–µ–∑ API proxy\n    const response = await clientFetch<any>(\n      \"Orders\",\n      {},\n      {\n        method: \"POST\",\n        body: JSON.stringify(order),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      createdOrder = response[0] as NocoDBOrder\n    } else if (response && typeof response === 'object' && 'Id' in response) {\n      createdOrder = response as NocoDBOrder\n    } else if (response && typeof response === 'object' && 'record' in response) {\n      createdOrder = response.record as NocoDBOrder\n    } else {\n      createdOrder = response as NocoDBOrder\n    }\n  }\n  \n  // NocoDB —á–∞—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ Id –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –ø–æ—ç—Ç–æ–º—É –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç\n  if (createdOrder?.Id) {\n    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤—Å–µ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è\n    if (!createdOrder.order_number || Object.keys(createdOrder).length < 5) {\n      console.log(`‚ö†Ô∏è Order created but incomplete response, fetching full order ${createdOrder.Id}...`)\n      try {\n        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å—å —Ç–æ—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å\n        await new Promise(resolve => setTimeout(resolve, 300))\n        const fullOrder = await fetchOrderById(createdOrder.Id)\n        if (fullOrder && fullOrder.order_number) {\n          console.log(`‚úÖ Fetched full order with order_number: ${fullOrder.order_number}`)\n          return fullOrder\n        } else {\n          console.warn(`‚ö†Ô∏è Fetched order also incomplete, but using it anyway`)\n          if (fullOrder) return fullOrder\n        }\n      } catch (error) {\n        console.warn(`‚ö†Ô∏è Failed to fetch full order:`, error)\n        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å, –Ω–æ –µ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ\n        if ('order_number' in order) {\n          return { ...createdOrder, order_number: order.order_number } as NocoDBOrder\n        }\n      }\n    } else {\n      console.log(`‚úÖ Order created with complete data, order_number: ${createdOrder.order_number}`)\n    }\n  }\n  \n  return createdOrder\n}\n\nexport async function updateOrder(id: number, data: Partial<NocoDBOrder>): Promise<NocoDBOrder> {\n  const apiBaseUrl = getApiBaseUrl()\n  \n  if (apiBaseUrl === null) {\n    // –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Å—Ä–µ–¥–∞ - –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ NocoDB\n    return serverCreateRecord<NocoDBOrder>(\"Orders\", data, \"PATCH\", id)\n  } else {\n    // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ä–µ–¥–∞ - —á–µ—Ä–µ–∑ API proxy\n    const response = await clientFetch<any>(\n      `Orders/${id}`,\n      {},\n      {\n        method: \"PATCH\",\n        body: JSON.stringify(data),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      return response[0] as NocoDBOrder\n    }\n    \n    if (response && typeof response === 'object' && 'Id' in response) {\n      return response as NocoDBOrder\n    }\n    \n    if (response && typeof response === 'object' && 'record' in response) {\n      return response.record as NocoDBOrder\n    }\n    \n    return response as NocoDBOrder\n  }\n}\n\n// === ORDER PERSONS ===\n\nexport interface NocoDBOrderPerson {\n  Id: number\n  order_id: number\n  person_number: number\n}\n\nexport async function createOrderPerson(orderPerson: Omit<NocoDBOrderPerson, \"Id\">): Promise<NocoDBOrderPerson> {\n  const apiBaseUrl = getApiBaseUrl()\n  \n  if (apiBaseUrl === null) {\n    return serverCreateRecord<NocoDBOrderPerson>(\"Order_Persons\", orderPerson, \"POST\")\n  } else {\n    const response = await clientFetch<any>(\n      \"Order_Persons\",\n      {},\n      {\n        method: \"POST\",\n        body: JSON.stringify(orderPerson),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      return response[0] as NocoDBOrderPerson\n    }\n    \n    if (response && typeof response === 'object' && 'Id' in response) {\n      return response as NocoDBOrderPerson\n    }\n    \n    if (response && typeof response === 'object' && 'record' in response) {\n      return response.record as NocoDBOrderPerson\n    }\n    \n    return response as NocoDBOrderPerson\n  }\n}\n\n// === ORDER MEALS ===\n\nexport interface NocoDBOrderMeal {\n  Id: number\n  order_person_id: number\n  day: \"day1\" | \"day2\"\n  meal_time: \"breakfast\" | \"lunch\" | \"dinner\"\n  meal_type: \"dish\" | \"salad\" | \"soup\" | \"main\"\n  meal_id: number\n  portion_size: \"single\" | \"medium\" | \"large\"\n  price: number | string\n  garnish_id?: number\n  garnish_portion_size?: \"single\" | \"medium\" | \"large\"\n  garnish_price?: number | string\n}\n\nexport async function createOrderMeal(orderMeal: Omit<NocoDBOrderMeal, \"Id\">): Promise<NocoDBOrderMeal> {\n  const apiBaseUrl = getApiBaseUrl()\n  \n  if (apiBaseUrl === null) {\n    return serverCreateRecord<NocoDBOrderMeal>(\"Order_Meals\", orderMeal, \"POST\")\n  } else {\n    const response = await clientFetch<any>(\n      \"Order_Meals\",\n      {},\n      {\n        method: \"POST\",\n        body: JSON.stringify(orderMeal),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      return response[0] as NocoDBOrderMeal\n    }\n    \n    if (response && typeof response === 'object' && 'Id' in response) {\n      return response as NocoDBOrderMeal\n    }\n    \n    if (response && typeof response === 'object' && 'record' in response) {\n      return response.record as NocoDBOrderMeal\n    }\n    \n    return response as NocoDBOrderMeal\n  }\n}\n\n// === ORDER EXTRAS ===\n\nexport interface NocoDBOrderExtra {\n  Id: number\n  order_id: number\n  extra_id: number\n  quantity: number | string\n  price: number | string\n}\n\nexport async function createOrderExtra(orderExtra: Omit<NocoDBOrderExtra, \"Id\">): Promise<NocoDBOrderExtra> {\n  const apiBaseUrl = getApiBaseUrl()\n  \n  if (apiBaseUrl === null) {\n    return serverCreateRecord<NocoDBOrderExtra>(\"Order_Extras\", orderExtra, \"POST\")\n  } else {\n    const response = await clientFetch<any>(\n      \"Order_Extras\",\n      {},\n      {\n        method: \"POST\",\n        body: JSON.stringify(orderExtra),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      return response[0] as NocoDBOrderExtra\n    }\n    \n    if (response && typeof response === 'object' && 'Id' in response) {\n      return response as NocoDBOrderExtra\n    }\n    \n    if (response && typeof response === 'object' && 'record' in response) {\n      return response.record as NocoDBOrderExtra\n    }\n    \n    return response as NocoDBOrderExtra\n  }\n}\n\n// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞\nexport async function fetchOrderPersons(orderId: number): Promise<NocoDBOrderPerson[]> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBOrderPerson>>(\"Order_Persons\", {\n    where: `(order_id,eq,${orderId})`,\n  })\n  return response.list || []\n}\n\nexport async function fetchOrderMeals(orderPersonId: number): Promise<NocoDBOrderMeal[]> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBOrderMeal>>(\"Order_Meals\", {\n    where: `(order_person_id,eq,${orderPersonId})`,\n  })\n  return response.list || []\n}\n\nexport async function fetchOrderExtras(orderId: number): Promise<NocoDBOrderExtra[]> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBOrderExtra>>(\"Order_Extras\", {\n    where: `(order_id,eq,${orderId})`,\n  })\n  return response.list || []\n}\n\n// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞\nexport async function deleteOrderPerson(id: number): Promise<void> {\n  const apiBaseUrl = getApiBaseUrl()\n  if (apiBaseUrl === null) {\n    // –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ NocoDB\n    const tableId = getTableId(\"Order_Persons\")\n    const nocodbUrl = getNocoDBUrl()\n    const token = getNocoDBToken()\n    const url = `${nocodbUrl}/api/v2/tables/${tableId}/records/${id}`\n    \n    const response = await fetch(url, {\n      method: \"DELETE\",\n      headers: {\n        \"xc-token\": token,\n        \"Content-Type\": \"application/json\",\n      },\n    })\n    \n    if (!response.ok) {\n      throw new Error(`Failed to delete order person: ${response.status}`)\n    }\n  } else {\n    // –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º API proxy\n    const response = await fetch(`/api/db/Order_Persons/records/${id}`, {\n      method: \"DELETE\",\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n    \n    if (!response.ok) {\n      throw new Error(`Failed to delete order person: ${response.status}`)\n    }\n  }\n}\n\nexport async function deleteOrderMeal(id: number): Promise<void> {\n  const apiBaseUrl = getApiBaseUrl()\n  if (apiBaseUrl === null) {\n    const tableId = getTableId(\"Order_Meals\")\n    const nocodbUrl = getNocoDBUrl()\n    const token = getNocoDBToken()\n    const url = `${nocodbUrl}/api/v2/tables/${tableId}/records/${id}`\n    \n    const response = await fetch(url, {\n      method: \"DELETE\",\n      headers: {\n        \"xc-token\": token,\n        \"Content-Type\": \"application/json\",\n      },\n    })\n    \n    if (!response.ok) {\n      throw new Error(`Failed to delete order meal: ${response.status}`)\n    }\n  } else {\n    const response = await fetch(`/api/db/Order_Meals/records/${id}`, {\n      method: \"DELETE\",\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n    \n    if (!response.ok) {\n      throw new Error(`Failed to delete order meal: ${response.status}`)\n    }\n  }\n}\n\nexport async function deleteOrderExtra(id: number): Promise<void> {\n  const apiBaseUrl = getApiBaseUrl()\n  if (apiBaseUrl === null) {\n    const tableId = getTableId(\"Order_Extras\")\n    const nocodbUrl = getNocoDBUrl()\n    const token = getNocoDBToken()\n    const url = `${nocodbUrl}/api/v2/tables/${tableId}/records/${id}`\n    \n    const response = await fetch(url, {\n      method: \"DELETE\",\n      headers: {\n        \"xc-token\": token,\n        \"Content-Type\": \"application/json\",\n      },\n    })\n    \n    if (!response.ok) {\n      throw new Error(`Failed to delete order extra: ${response.status}`)\n    }\n  } else {\n    const response = await fetch(`/api/db/Order_Extras/records/${id}`, {\n      method: \"DELETE\",\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n    \n    if (!response.ok) {\n      throw new Error(`Failed to delete order extra: ${response.status}`)\n    }\n  }\n}\n\n// === PROMO CODES ===\n\nexport interface NocoDBPromoCode {\n  Id: number\n  code: string\n  discount_type: \"percentage\" | \"fixed\"\n  discount_value: number | string\n  min_order_amount?: number | string\n  max_discount?: number | string\n  valid_from?: string\n  valid_until?: string\n  usage_limit?: number | string\n  times_used: number | string\n  active?: boolean | string\n}\n\nexport async function fetchPromoCode(code: string): Promise<NocoDBPromoCode | null> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBPromoCode>>(\"Promo_Codes\", {\n    where: `(code,eq,${code})~and(active,eq,true)`,\n  })\n  return response.list?.[0] || null\n}\n\nexport async function incrementPromoCodeUsage(id: number): Promise<void> {\n  await clientFetch(\n    \"Promo_Codes\",\n    {},\n    {\n      method: \"PATCH\",\n      body: JSON.stringify({ Id: id, times_used: { increment: 1 } }),\n    },\n  )\n}\n\n// === REVIEWS ===\n\nexport interface NocoDBReview {\n  Id: number\n  order_id: number\n  user_id: number\n  rating: number | string\n  text?: string\n  created_at: string\n  updated_at: string\n}\n\nexport async function fetchReviewsForUser(userId: number): Promise<NocoDBReview[]> {\n  const response = await nocoFetch<NocoDBResponse<NocoDBReview>>(\"Reviews\", {\n    where: `(user_id,eq,${userId})`,\n  })\n  return response.list || []\n}\n\nexport async function createReview(\n  review: Omit<NocoDBReview, \"Id\" | \"created_at\" | \"updated_at\">,\n): Promise<NocoDBReview> {\n  const apiBaseUrl = getApiBaseUrl()\n  \n  if (apiBaseUrl === null) {\n    return serverCreateRecord<NocoDBReview>(\"Reviews\", review, \"POST\")\n  } else {\n    const response = await clientFetch<any>(\n      \"Reviews\",\n      {},\n      {\n        method: \"POST\",\n        body: JSON.stringify(review),\n      },\n    )\n    \n    if (Array.isArray(response)) {\n      return response[0] as NocoDBReview\n    }\n    \n    if (response && typeof response === 'object' && 'Id' in response) {\n      return response as NocoDBReview\n    }\n    \n    if (response && typeof response === 'object' && 'record' in response) {\n      return response.record as NocoDBReview\n    }\n    \n    return response as NocoDBReview\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,kEAAkE;AAClE,sCAAsC;AAEtC,uCAAuC;AACvC,mEAAmE;AACnE,MAAM,gBAAgB;IACpB;;IAGA,OAAO;AACT;AAEA,SAAS;IACP,OAAO,QAAQ,GAAG,CAAC,UAAU,IAAI;AACnC;AAEA,SAAS;IACP,OAAO,QAAQ,GAAG,CAAC,YAAY,IAAI;AACrC;AAEA,SAAS,WAAW,SAAiB;IACnC,MAAM,WAA+C;QACnD,OAAO,QAAQ,GAAG,CAAC,kBAAkB;QACrC,QAAQ,QAAQ,GAAG,CAAC,mBAAmB;QACvC,gBAAgB,QAAQ,GAAG,CAAC,2BAA2B;QACvD,OAAO,QAAQ,GAAG,CAAC,kBAAkB;QACrC,QAAQ,QAAQ,GAAG,CAAC,mBAAmB;QACvC,eAAe,QAAQ,GAAG,CAAC,0BAA0B;QACrD,aAAa,QAAQ,GAAG,CAAC,wBAAwB;QACjD,cAAc,QAAQ,GAAG,CAAC,yBAAyB;QACnD,aAAa,QAAQ,GAAG,CAAC,wBAAwB;QACjD,SAAS,QAAQ,GAAG,CAAC,oBAAoB;IAC3C;IAEA,OAAO,QAAQ,CAAC,UAAU,IAAI;AAChC;AAEA,qCAAqC;AACrC,SAAS;IACP,MAAM,MAAM;IACZ,MAAM,QAAQ;IACd,MAAM,aAAa,QAAQ,GAAG,CAAC,kBAAkB;IAEjD,IAAI,CAAC,OAAO,CAAC,OAAO;QAClB,OAAO;YAAE,SAAS;YAAO,OAAO;QAAqC;IACvE;IACA,IAAI,CAAC,YAAY;QACf,OAAO;YAAE,SAAS;YAAO,OAAO;QAA6B;IAC/D;IACA,OAAO;QAAE,SAAS;IAAK;AACzB;AAEO,SAAS;IACd,OAAO,uBAAuB,OAAO;AACvC;AAcA,SAAS,eAAe,SAAiB,EAAE,SAAiC,CAAC,CAAC;IAC5E,MAAM,cAAc,IAAI,gBAAgB,QAAQ,QAAQ;IACxD,IAAI,UAAU,eAAe,OAAO,CAAC,OAAO;IAE5C,IAAI,CAAC,QAAQ,QAAQ,CAAC,YAAY;QAChC,UAAU,GAAG,QAAQ,OAAO,CAAC;IAC/B;IAEA,MAAM,UAAU,WAAW;IAE3B,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM,CAAC,qBAAqB,EAAE,WAAW;IACrD;IAEA,OAAO,GAAG,QAAQ,QAAQ,EAAE,QAAQ,QAAQ,EAAE,cAAc,CAAC,CAAC,EAAE,aAAa,GAAG,IAAI;AACtF;AAEA,8CAA8C;AAC9C,eAAe,YAAe,SAAiB,EAAE,SAAiC,CAAC,CAAC;IAClF,MAAM,SAAS;IACf,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,OAAO,KAAK,EAAE;IAC7D;IAEA,MAAM,MAAM,eAAe,WAAW;IACtC,MAAM,QAAQ;IAEd,MAAM,WAAW,MAAM,MAAM,KAAK;QAChC,SAAS;YACP,YAAY;YACZ,gBAAgB;QAClB;QACA,MAAM;YAAE,YAAY;QAAK;IAC3B;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,IAAI,KAAK,QAAQ,CAAC,sBAAsB,SAAS,MAAM,KAAK,KAAK;YAC/D,MAAM,IAAI,MAAM,CAAC,gBAAgB,EAAE,WAAW;QAChD;QACA,MAAM,IAAI,MAAM,CAAC,kBAAkB,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,MAAM;IAClE;IAEA,IAAI;QACF,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,KAAK,SAAS,CAAC,GAAG,KAAK,GAAG,CAAC;IAC9E;AACF;AAEA,sEAAsE;AACtE,eAAe,mBACb,SAAiB,EACjB,IAAS,EACT,SAA2B,MAAM,EACjC,QAAiB;IAEjB,MAAM,SAAS;IACf,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,OAAO,KAAK,EAAE;IAC7D;IAEA,IAAI,UAAU,eAAe,OAAO,CAAC,OAAO;IAC5C,IAAI,CAAC,QAAQ,QAAQ,CAAC,YAAY;QAChC,UAAU,GAAG,QAAQ,OAAO,CAAC;IAC/B;IAEA,MAAM,UAAU,WAAW;IAC3B,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM,CAAC,qBAAqB,EAAE,WAAW;IACrD;IAEA,MAAM,MAAM,WAAW,WAAW,WAC9B,GAAG,QAAQ,QAAQ,EAAE,QAAQ,SAAS,EAAE,UAAU,GAClD,GAAG,QAAQ,QAAQ,EAAE,QAAQ,QAAQ,CAAC;IAE1C,MAAM,QAAQ;IAEd,MAAM,WAAW,MAAM,MAAM,KAAK;QAChC;QACA,SAAS;YACP,YAAY;YACZ,gBAAgB;QAClB;QACA,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,IAAI,KAAK,QAAQ,CAAC,sBAAsB,SAAS,MAAM,KAAK,KAAK;YAC/D,MAAM,IAAI,MAAM,CAAC,gBAAgB,EAAE,WAAW;QAChD;QACA,MAAM,IAAI,MAAM,CAAC,kBAAkB,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,MAAM;IAClE;IAEA,IAAI;QACF,MAAM,SAAS,KAAK,KAAK,CAAC;QAC1B,gDAAgD;QAChD,IAAI,MAAM,OAAO,CAAC,SAAS;YACzB,OAAO,MAAM,CAAC,EAAE;QAClB;QACA,IAAI,UAAU,OAAO,WAAW,YAAY,QAAQ,QAAQ;YAC1D,OAAO;QACT;QACA,IAAI,UAAU,OAAO,WAAW,YAAY,YAAY,QAAQ;YAC9D,OAAO,OAAO,MAAM;QACtB;QACA,OAAO;IACT,EAAE,OAAM;QACN,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,KAAK,SAAS,CAAC,GAAG,KAAK,GAAG,CAAC;IAC9E;AACF;AAEA,mCAAmC;AACnC,eAAe,YACb,SAAiB,EACjB,SAAiC,CAAC,CAAC,EACnC,UAAuB,CAAC,CAAC;IAEzB,MAAM,cAAc,IAAI,gBAAgB,QAAQ,QAAQ;IACxD,MAAM,MAAM,CAAC,QAAQ,EAAE,UAAU,QAAQ,EAAE,cAAc,CAAC,CAAC,EAAE,aAAa,GAAG,IAAI;IAEjF,MAAM,WAAW,MAAM,MAAM,KAAK;QAChC,GAAG,OAAO;QACV,SAAS;YACP,gBAAgB;YAChB,GAAG,QAAQ,OAAO;QACpB;IACF;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,IAAI,KAAK,QAAQ,CAAC,sBAAsB,SAAS,MAAM,KAAK,KAAK;YAC/D,MAAM,IAAI,MAAM,CAAC,gBAAgB,EAAE,WAAW;QAChD;QACA,MAAM,IAAI,MAAM,CAAC,WAAW,EAAE,SAAS,MAAM,CAAC,GAAG,EAAE,MAAM;IAC3D;IAEA,IAAI;QACF,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,MAAM,IAAI,MAAM,CAAC,2BAA2B,EAAE,KAAK,SAAS,CAAC,GAAG,KAAK,GAAG,CAAC;IAC3E;AACF;AAEA,sBAAsB;AACtB,eAAe,UACb,SAAiB,EACjB,SAAiC,CAAC,CAAC,EACnC,UAAuB,CAAC,CAAC;IAEzB,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,OAAO,YAAe,WAAW;IACnC,OAAO;QACL,OAAO,YAAe,WAAW,QAAQ;IAC3C;AACF;AA6BO,eAAe,WAAW,UAA+B;IAC9D,IAAI;QACF,MAAM,SAAiC;YACrC,OAAO;QACT;QAEA,MAAM,WAAW,MAAM,UAAsC,SAAS;QACtE,QAAQ,GAAG,CACT,CAAC,qBAAqB,EAAE,SAAS,IAAI,EAAE,UAAU,EAAE,mBAAmB,CAAC,EACvE,KAAK,SAAS,CAAC,SAAS,IAAI,EAAE,CAAC,EAAE,IAAI,CAAC,GAAG,SAAS,CAAC,GAAG;QAExD,OAAO,SAAS,IAAI,IAAI,EAAE;IAC5B,EAAE,OAAO,OAAO;QACd,IAAI,iBAAiB,SAAS,MAAM,OAAO,CAAC,UAAU,CAAC,oBAAoB;YACzE,QAAQ,IAAI,CAAC;YACb,OAAO,EAAE;QACX;QACA,MAAM;IACR;AACF;AAoBO,eAAe;IACpB,IAAI;QACF,MAAM,WAAW,MAAM,UAAuC,UAAU;YACtE,OAAO;QACT;QACA,QAAQ,GAAG,CACT,CAAC,sBAAsB,EAAE,SAAS,IAAI,EAAE,UAAU,EAAE,oBAAoB,CAAC,EACzE,KAAK,SAAS,CAAC,SAAS,IAAI,EAAE,CAAC,EAAE,IAAI,CAAC,GAAG,SAAS,CAAC,GAAG;QAExD,OAAO,SAAS,IAAI,IAAI,EAAE;IAC5B,EAAE,OAAO,OAAO;QACd,IAAI,iBAAiB,SAAS,MAAM,OAAO,CAAC,UAAU,CAAC,oBAAoB;YACzE,QAAQ,IAAI,CAAC;YACb,OAAO,EAAE;QACX;QACA,MAAM;IACR;AACF;AAcO,eAAe;IACpB,IAAI;QACF,MAAM,WAAW,MAAM,UAA8C,kBAAkB;QAEvF;QACA,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,SAAS,IAAI,EAAE,UAAU,EAAE,mBAAmB,CAAC,EAAE,SAAS,IAAI,EAAE,CAAC,EAAE;QAC/G,OAAO,SAAS,IAAI,IAAI,EAAE;IAC5B,EAAE,OAAO,OAAO;QACd,IAAI,iBAAiB,SAAS,MAAM,OAAO,CAAC,UAAU,CAAC,oBAAoB;YACzE,QAAQ,IAAI,CAAC;YACb,OAAO,EAAE;QACX;QACA,MAAM;IACR;AACF;AAyBO,eAAe,iBAAiB,KAAa;IAClD,MAAM,WAAW,MAAM,UAAsC,SAAS;QACpE,OAAO,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC;IAC9B;IACA,OAAO,SAAS,IAAI,EAAE,CAAC,EAAE,IAAI;AAC/B;AAEO,eAAe,cAAc,EAAU;IAC5C,MAAM,WAAW,MAAM,UAAsC,SAAS;QACpE,OAAO,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;IACxB;IACA,OAAO,SAAS,IAAI,EAAE,CAAC,EAAE,IAAI;AAC/B;AAEO,eAAe,WAAW,IAA0D;IACzF,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,OAAO,mBAA+B,SAAS,MAAM;IACvD,OAAO;QACL,MAAM,WAAW,MAAM,YACrB,SACA,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,OAAO,QAAQ,CAAC,EAAE;QACpB;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YAChE,OAAO;QACT;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YACpE,OAAO,SAAS,MAAM;QACxB;QAEA,OAAO;IACT;AACF;AAEO,eAAe,WAAW,EAAU,EAAE,IAAyB;IACpE,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,OAAO,mBAA+B,SAAS,MAAM,SAAS;IAChE,OAAO;QACL,MAAM,WAAW,MAAM,YACrB,CAAC,MAAM,EAAE,IAAI,EACb,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,OAAO,QAAQ,CAAC,EAAE;QACpB;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YAChE,OAAO;QACT;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YACpE,OAAO,SAAS,MAAM;QACxB;QAEA,OAAO;IACT;AACF;AA4BO,eAAe,YAAY,MAAe;IAC/C,MAAM,SAAiC;QACrC,OAAO;QACP,MAAM;IACR;IAEA,IAAI,QAAQ;QACV,OAAO,KAAK,GAAG,CAAC,YAAY,EAAE,OAAO,CAAC,CAAC;IACzC;IAEA,MAAM,WAAW,MAAM,UAAuC,UAAU;IACxE,OAAO,SAAS,IAAI,IAAI,EAAE;AAC5B;AAEO,eAAe,kBAAkB,MAAc;IACpD,OAAO,YAAY;AACrB;AAEO,SAAS;IACd,MAAM,MAAM,IAAI;IAChB,MAAM,OAAO,IAAI,WAAW,GAAG,KAAK,CAAC,GAAG,IAAI,OAAO,CAAC,MAAM;IAC1D,MAAM,SAAS,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,GAAG,GAAG,WAAW;IACrE,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE,QAAQ;AAChC;AAEO,eAAe,eAAe,EAAU;IAC7C,MAAM,WAAW,MAAM,UAAuC,UAAU;QACtE,OAAO,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;IACxB;IACA,OAAO,SAAS,IAAI,EAAE,CAAC,EAAE,IAAI;AAC/B;AAEO,eAAe,YAAY,KAA4D;IAC5F,yEAAyE;IACzE,MAAM,aAAa;IAEnB,IAAI;IAEJ,IAAI,eAAe,MAAM;QACvB,2CAA2C;QAC3C,eAAe,MAAM,mBAAgC,UAAU,OAAO;IACxE,OAAO;QACL,qCAAqC;QACrC,MAAM,WAAW,MAAM,YACrB,UACA,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,eAAe,QAAQ,CAAC,EAAE;QAC5B,OAAO,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YACvE,eAAe;QACjB,OAAO,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YAC3E,eAAe,SAAS,MAAM;QAChC,OAAO;YACL,eAAe;QACjB;IACF;IAEA,wFAAwF;IACxF,IAAI,cAAc,IAAI;QACpB,yCAAyC;QACzC,IAAI,CAAC,aAAa,YAAY,IAAI,OAAO,IAAI,CAAC,cAAc,MAAM,GAAG,GAAG;YACtE,QAAQ,GAAG,CAAC,CAAC,8DAA8D,EAAE,aAAa,EAAE,CAAC,GAAG,CAAC;YACjG,IAAI;gBACF,qDAAqD;gBACrD,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;gBACjD,MAAM,YAAY,MAAM,eAAe,aAAa,EAAE;gBACtD,IAAI,aAAa,UAAU,YAAY,EAAE;oBACvC,QAAQ,GAAG,CAAC,CAAC,wCAAwC,EAAE,UAAU,YAAY,EAAE;oBAC/E,OAAO;gBACT,OAAO;oBACL,QAAQ,IAAI,CAAC,CAAC,qDAAqD,CAAC;oBACpE,IAAI,WAAW,OAAO;gBACxB;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,IAAI,CAAC,CAAC,8BAA8B,CAAC,EAAE;gBAC/C,yEAAyE;gBACzE,IAAI,kBAAkB,OAAO;oBAC3B,OAAO;wBAAE,GAAG,YAAY;wBAAE,cAAc,MAAM,YAAY;oBAAC;gBAC7D;YACF;QACF,OAAO;YACL,QAAQ,GAAG,CAAC,CAAC,kDAAkD,EAAE,aAAa,YAAY,EAAE;QAC9F;IACF;IAEA,OAAO;AACT;AAEO,eAAe,YAAY,EAAU,EAAE,IAA0B;IACtE,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,2CAA2C;QAC3C,OAAO,mBAAgC,UAAU,MAAM,SAAS;IAClE,OAAO;QACL,qCAAqC;QACrC,MAAM,WAAW,MAAM,YACrB,CAAC,OAAO,EAAE,IAAI,EACd,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,OAAO,QAAQ,CAAC,EAAE;QACpB;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YAChE,OAAO;QACT;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YACpE,OAAO,SAAS,MAAM;QACxB;QAEA,OAAO;IACT;AACF;AAUO,eAAe,kBAAkB,WAA0C;IAChF,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,OAAO,mBAAsC,iBAAiB,aAAa;IAC7E,OAAO;QACL,MAAM,WAAW,MAAM,YACrB,iBACA,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,OAAO,QAAQ,CAAC,EAAE;QACpB;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YAChE,OAAO;QACT;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YACpE,OAAO,SAAS,MAAM;QACxB;QAEA,OAAO;IACT;AACF;AAkBO,eAAe,gBAAgB,SAAsC;IAC1E,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,OAAO,mBAAoC,eAAe,WAAW;IACvE,OAAO;QACL,MAAM,WAAW,MAAM,YACrB,eACA,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,OAAO,QAAQ,CAAC,EAAE;QACpB;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YAChE,OAAO;QACT;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YACpE,OAAO,SAAS,MAAM;QACxB;QAEA,OAAO;IACT;AACF;AAYO,eAAe,iBAAiB,UAAwC;IAC7E,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,OAAO,mBAAqC,gBAAgB,YAAY;IAC1E,OAAO;QACL,MAAM,WAAW,MAAM,YACrB,gBACA,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,OAAO,QAAQ,CAAC,EAAE;QACpB;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YAChE,OAAO;QACT;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YACpE,OAAO,SAAS,MAAM;QACxB;QAEA,OAAO;IACT;AACF;AAGO,eAAe,kBAAkB,OAAe;IACrD,MAAM,WAAW,MAAM,UAA6C,iBAAiB;QACnF,OAAO,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAC;IACnC;IACA,OAAO,SAAS,IAAI,IAAI,EAAE;AAC5B;AAEO,eAAe,gBAAgB,aAAqB;IACzD,MAAM,WAAW,MAAM,UAA2C,eAAe;QAC/E,OAAO,CAAC,oBAAoB,EAAE,cAAc,CAAC,CAAC;IAChD;IACA,OAAO,SAAS,IAAI,IAAI,EAAE;AAC5B;AAEO,eAAe,iBAAiB,OAAe;IACpD,MAAM,WAAW,MAAM,UAA4C,gBAAgB;QACjF,OAAO,CAAC,aAAa,EAAE,QAAQ,CAAC,CAAC;IACnC;IACA,OAAO,SAAS,IAAI,IAAI,EAAE;AAC5B;AAGO,eAAe,kBAAkB,EAAU;IAChD,MAAM,aAAa;IACnB,IAAI,eAAe,MAAM;QACvB,+CAA+C;QAC/C,MAAM,UAAU,WAAW;QAC3B,MAAM,YAAY;QAClB,MAAM,QAAQ;QACd,MAAM,MAAM,GAAG,UAAU,eAAe,EAAE,QAAQ,SAAS,EAAE,IAAI;QAEjE,MAAM,WAAW,MAAM,MAAM,KAAK;YAChC,QAAQ;YACR,SAAS;gBACP,YAAY;gBACZ,gBAAgB;YAClB;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;QACrE;IACF,OAAO;QACL,kCAAkC;QAClC,MAAM,WAAW,MAAM,MAAM,CAAC,8BAA8B,EAAE,IAAI,EAAE;YAClE,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,SAAS,MAAM,EAAE;QACrE;IACF;AACF;AAEO,eAAe,gBAAgB,EAAU;IAC9C,MAAM,aAAa;IACnB,IAAI,eAAe,MAAM;QACvB,MAAM,UAAU,WAAW;QAC3B,MAAM,YAAY;QAClB,MAAM,QAAQ;QACd,MAAM,MAAM,GAAG,UAAU,eAAe,EAAE,QAAQ,SAAS,EAAE,IAAI;QAEjE,MAAM,WAAW,MAAM,MAAM,KAAK;YAChC,QAAQ;YACR,SAAS;gBACP,YAAY;gBACZ,gBAAgB;YAClB;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,6BAA6B,EAAE,SAAS,MAAM,EAAE;QACnE;IACF,OAAO;QACL,MAAM,WAAW,MAAM,MAAM,CAAC,4BAA4B,EAAE,IAAI,EAAE;YAChE,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,6BAA6B,EAAE,SAAS,MAAM,EAAE;QACnE;IACF;AACF;AAEO,eAAe,iBAAiB,EAAU;IAC/C,MAAM,aAAa;IACnB,IAAI,eAAe,MAAM;QACvB,MAAM,UAAU,WAAW;QAC3B,MAAM,YAAY;QAClB,MAAM,QAAQ;QACd,MAAM,MAAM,GAAG,UAAU,eAAe,EAAE,QAAQ,SAAS,EAAE,IAAI;QAEjE,MAAM,WAAW,MAAM,MAAM,KAAK;YAChC,QAAQ;YACR,SAAS;gBACP,YAAY;gBACZ,gBAAgB;YAClB;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,SAAS,MAAM,EAAE;QACpE;IACF,OAAO;QACL,MAAM,WAAW,MAAM,MAAM,CAAC,6BAA6B,EAAE,IAAI,EAAE;YACjE,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;QAChD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,SAAS,MAAM,EAAE;QACpE;IACF;AACF;AAkBO,eAAe,eAAe,IAAY;IAC/C,MAAM,WAAW,MAAM,UAA2C,eAAe;QAC/E,OAAO,CAAC,SAAS,EAAE,KAAK,qBAAqB,CAAC;IAChD;IACA,OAAO,SAAS,IAAI,EAAE,CAAC,EAAE,IAAI;AAC/B;AAEO,eAAe,wBAAwB,EAAU;IACtD,MAAM,YACJ,eACA,CAAC,GACD;QACE,QAAQ;QACR,MAAM,KAAK,SAAS,CAAC;YAAE,IAAI;YAAI,YAAY;gBAAE,WAAW;YAAE;QAAE;IAC9D;AAEJ;AAcO,eAAe,oBAAoB,MAAc;IACtD,MAAM,WAAW,MAAM,UAAwC,WAAW;QACxE,OAAO,CAAC,YAAY,EAAE,OAAO,CAAC,CAAC;IACjC;IACA,OAAO,SAAS,IAAI,IAAI,EAAE;AAC5B;AAEO,eAAe,aACpB,MAA8D;IAE9D,MAAM,aAAa;IAEnB,IAAI,eAAe,MAAM;QACvB,OAAO,mBAAiC,WAAW,QAAQ;IAC7D,OAAO;QACL,MAAM,WAAW,MAAM,YACrB,WACA,CAAC,GACD;YACE,QAAQ;YACR,MAAM,KAAK,SAAS,CAAC;QACvB;QAGF,IAAI,MAAM,OAAO,CAAC,WAAW;YAC3B,OAAO,QAAQ,CAAC,EAAE;QACpB;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,QAAQ,UAAU;YAChE,OAAO;QACT;QAEA,IAAI,YAAY,OAAO,aAAa,YAAY,YAAY,UAAU;YACpE,OAAO,SAAS,MAAM;QACxB;QAEA,OAAO;IACT;AACF"}},
    {"offset": {"line": 700, "column": 0}, "map": {"version":3,"sources":["file:///Users/sergejasasnev/Downloads/my-project%20%281%29/app/api/orders/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport {\n  fetchOrdersByUser,\n  createOrder,\n  createOrderPerson,\n  createOrderMeal,\n  createOrderExtra,\n  generateOrderNumber,\n} from \"@/lib/nocodb\"\nimport type { Order, Meal, PortionSize } from \"@/lib/types\"\n\n// GET /api/orders?userId=123\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url)\n  const userId = searchParams.get(\"userId\")\n\n  if (!userId) {\n    return NextResponse.json({ error: \"userId is required\" }, { status: 400 })\n  }\n\n  try {\n    const orders = await fetchOrdersByUser(Number(userId))\n    return NextResponse.json({ orders })\n  } catch (error) {\n    console.error(\"Failed to fetch orders:\", error)\n    return NextResponse.json({ error: \"Failed to fetch orders\" }, { status: 500 })\n  }\n}\n\n// POST /api/orders - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞\nexport async function POST(request: Request) {\n  const { logRequest, logResponse } = await import(\"@/lib/request-logger\")\n  \n  console.log(\"üì• POST /api/orders - –ø–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞\")\n  logRequest(\"POST\", \"/api/orders\")\n  \n  try {\n    const body = await request.json()\n    console.log(\"üì¶ –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:\", JSON.stringify(body, null, 2))\n    logRequest(\"POST\", \"/api/orders\", { hasOrder: !!body.order, userId: body.userId })\n    const { order, userId } = body as { order: Order; userId?: number }\n    \n    if (!order) {\n      console.error(\"‚ùå –ó–∞–∫–∞–∑ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ –∑–∞–ø—Ä–æ—Å–µ\")\n      return NextResponse.json({ error: \"Order is required\" }, { status: 400 })\n    }\n    \n    console.log(\"‚úÖ –ó–∞–∫–∞–∑ –ø–æ–ª—É—á–µ–Ω:\", {\n      hasPersons: !!order.persons?.length,\n      personsCount: order.persons?.length || 0,\n      hasExtras: !!order.extras?.length,\n      extrasCount: order.extras?.length || 0,\n      startDate: order.startDate,\n      deliveryTime: order.deliveryTime,\n      userId,\n    })\n\n    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞\n    const orderNumber = generateOrderNumber()\n    console.log(\"Generated order number:\", orderNumber)\n\n    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ NocoDB\n    // –ï—Å–ª–∏ userId –ø–µ—Ä–µ–¥–∞–Ω, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –±–∞–∑–µ, —Å–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –±–µ–∑ user_id\n    const orderData = {\n      user_id: userId || null, // –†–∞–∑—Ä–µ—à–∞–µ–º null –¥–ª—è user_id\n      order_number: orderNumber,\n      start_date: typeof order.startDate === \"string\" ? order.startDate : order.startDate.toISOString().split(\"T\")[0],\n      delivery_time: order.deliveryTime,\n      status: order.paid ? \"paid\" : \"pending\",\n      payment_method: order.paymentMethod || \"cash\",\n      paid: order.paid,\n      paid_at: order.paidAt,\n      delivered: order.delivered,\n      cancelled: order.cancelled || false,\n      promo_code: order.promoCode,\n      promo_discount: order.promoDiscount,\n      loyalty_points_used: order.loyaltyPointsUsed || 0,\n      loyalty_points_earned: order.loyaltyPointsEarned || 0,\n      subtotal: order.subtotal || 0,\n      total: order.total || 0,\n    }\n    console.log(\"Creating order with data:\", orderData)\n    \n    let nocoOrder\n    try {\n      nocoOrder = await createOrder(orderData)\n      console.log(\"‚úÖ Created NocoDB order - full response:\", JSON.stringify(nocoOrder, null, 2))\n    } catch (error) {\n      console.error(\"‚ùå Failed to create order in NocoDB:\", error)\n      throw error\n    }\n    \n    // createOrder —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å order_number\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–º–µ—Ä –∏–∑ –æ—Ç–≤–µ—Ç–∞ NocoDB, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π\n    let finalOrderNumber = nocoOrder?.order_number || orderNumber\n    \n    if (!nocoOrder?.order_number) {\n      console.warn(`‚ö†Ô∏è Order number missing in response, using generated: ${orderNumber}`)\n      console.log(\"Order response keys:\", nocoOrder ? Object.keys(nocoOrder) : [])\n      console.log(\"Full order response:\", JSON.stringify(nocoOrder, null, 2))\n    } else {\n      console.log(`‚úÖ Order created successfully with order_number: ${nocoOrder.order_number}`)\n    }\n\n    // –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω –∏ –±–ª—é–¥\n    if (!order.persons || order.persons.length === 0) {\n      console.warn(\"‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è\")\n    } else {\n      console.log(`üìù Creating ${order.persons.length} persons for order ${nocoOrder.Id}`)\n    }\n    \n    for (const person of order.persons || []) {\n      console.log(`  Creating person ${person.id} for order ${nocoOrder.Id}`)\n      let nocoOrderPerson\n      try {\n        nocoOrderPerson = await createOrderPerson({\n          order_id: nocoOrder.Id,\n          person_number: person.id,\n        })\n        console.log(`  ‚úÖ Created OrderPerson:`, JSON.stringify(nocoOrderPerson, null, 2))\n      } catch (error) {\n        console.error(`  ‚ùå Failed to create OrderPerson:`, error)\n        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å - –∑–∞–∫–∞–∑ —É–∂–µ —Å–æ–∑–¥–∞–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –¥—Ä—É–≥–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–º–∏\n        console.warn(`  ‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä—Å–æ–Ω—É ${person.id} –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...`)\n        continue\n      }\n\n      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–ª—é–¥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è\n      for (const day of [\"day1\", \"day2\"] as const) {\n        const dayMeals = person[day]\n        if (!dayMeals) continue\n\n        // –ó–∞–≤—Ç—Ä–∞–∫\n        if (dayMeals.breakfast?.dish) {\n          try {\n            await saveMeal(nocoOrderPerson.Id, day, \"breakfast\", \"dish\", dayMeals.breakfast.dish)\n          } catch (error) {\n            console.error(`  ‚ùå Failed to save breakfast meal:`, error)\n            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å\n          }\n        }\n\n        // –û–±–µ–¥\n        if (dayMeals.lunch) {\n          if (dayMeals.lunch.salad) {\n            try {\n              await saveMeal(nocoOrderPerson.Id, day, \"lunch\", \"salad\", dayMeals.lunch.salad)\n            } catch (error) {\n              console.error(`  ‚ùå Failed to save lunch salad:`, error)\n            }\n          }\n          if (dayMeals.lunch.soup) {\n            try {\n              await saveMeal(nocoOrderPerson.Id, day, \"lunch\", \"soup\", dayMeals.lunch.soup)\n            } catch (error) {\n              console.error(`  ‚ùå Failed to save lunch soup:`, error)\n            }\n          }\n          if (dayMeals.lunch.main) {\n            try {\n              await saveMeal(nocoOrderPerson.Id, day, \"lunch\", \"main\", dayMeals.lunch.main)\n            } catch (error) {\n              console.error(`  ‚ùå Failed to save lunch main:`, error)\n            }\n          }\n        }\n\n        // –£–∂–∏–Ω\n        if (dayMeals.dinner) {\n          if (dayMeals.dinner.salad) {\n            try {\n              await saveMeal(nocoOrderPerson.Id, day, \"dinner\", \"salad\", dayMeals.dinner.salad)\n            } catch (error) {\n              console.error(`  ‚ùå Failed to save dinner salad:`, error)\n            }\n          }\n          if (dayMeals.dinner.soup) {\n            try {\n              await saveMeal(nocoOrderPerson.Id, day, \"dinner\", \"soup\", dayMeals.dinner.soup)\n            } catch (error) {\n              console.error(`  ‚ùå Failed to save dinner soup:`, error)\n            }\n          }\n          if (dayMeals.dinner.main) {\n            try {\n              await saveMeal(nocoOrderPerson.Id, day, \"dinner\", \"main\", dayMeals.dinner.main)\n            } catch (error) {\n              console.error(`  ‚ùå Failed to save dinner main:`, error)\n            }\n          }\n        }\n      }\n    }\n\n    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π\n    if (order.extras && order.extras.length > 0) {\n      console.log(`üì¶ Creating ${order.extras.length} extras for order ${nocoOrder.Id}`)\n      for (const extra of order.extras) {\n        console.log(`  Creating extra ${extra.id} (qty: ${extra.quantity}, price: ${extra.price})`)\n        try {\n          const result = await createOrderExtra({\n            order_id: nocoOrder.Id,\n            extra_id: extra.id,\n            quantity: extra.quantity,\n            price: extra.price,\n          })\n          console.log(`  ‚úÖ Created OrderExtra:`, JSON.stringify(result, null, 2))\n        } catch (error) {\n          console.error(`  ‚ùå Failed to create OrderExtra:`, error)\n          // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å\n          console.warn(`  ‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ${extra.id} –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...`)\n        }\n      }\n    }\n\n    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –µ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ!\n    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä, –µ—Å–ª–∏ finalOrderNumber –ø—É—Å—Ç–æ–π\n    const orderNumberToReturn = finalOrderNumber || orderNumber\n    \n    if (!finalOrderNumber) {\n      console.error(\"‚ùå CRITICAL ERROR: No order number available! Using generated:\", orderNumber)\n    }\n    \n    const responseData = {\n      success: true,\n      orderId: nocoOrder.Id,\n      orderNumber: orderNumberToReturn, // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞\n    }\n    \n    console.log(\"üì¶ Created order response:\", { \n      id: nocoOrder.Id, \n      orderNumber: responseData.orderNumber,\n      orderNumberLength: responseData.orderNumber?.length,\n      orderNumberType: typeof responseData.orderNumber\n    })\n    \n    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π\n    if (!responseData.orderNumber) {\n      console.error(\"‚ùå FATAL: Order number is still missing in response!\")\n      throw new Error(\"Failed to generate order number\")\n    }\n    \n    console.log(\"‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É\")\n    logResponse(\"POST\", \"/api/orders\", 200)\n    return NextResponse.json(responseData)\n  } catch (error) {\n    console.error(\"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:\", error)\n    console.error(\"Stack trace:\", error instanceof Error ? error.stack : \"No stack\")\n    const errorMessage = error instanceof Error ? error.message : String(error)\n    logResponse(\"POST\", \"/api/orders\", 500, errorMessage)\n    return NextResponse.json(\n      { \n        error: \"Failed to create order\",\n        message: error instanceof Error ? error.message : String(error),\n        details: process.env.NODE_ENV === \"development\" ? (error instanceof Error ? error.stack : undefined) : undefined,\n      }, \n      { status: 500 }\n    )\n  }\n}\n\nasync function saveMeal(\n  orderPersonId: number,\n  day: \"day1\" | \"day2\",\n  mealTime: \"breakfast\" | \"lunch\" | \"dinner\",\n  mealType: \"dish\" | \"salad\" | \"soup\" | \"main\",\n  meal: Meal,\n) {\n  const price = getMealPriceForPortion(meal)\n  const mealData = {\n    order_person_id: orderPersonId,\n    day,\n    meal_time: mealTime,\n    meal_type: mealType,\n    meal_id: meal.id,\n    portion_size: meal.portion || \"single\",\n    price,\n    garnish_id: meal.garnish?.id,\n    garnish_portion_size: meal.garnish?.portion,\n    garnish_price: meal.garnish ? getMealPriceForPortion(meal.garnish) : undefined,\n  }\n  \n  console.log(`  üçΩÔ∏è  Creating OrderMeal:`, JSON.stringify(mealData, null, 2))\n  \n  try {\n    const result = await createOrderMeal(mealData)\n    console.log(`  ‚úÖ Created OrderMeal:`, JSON.stringify(result, null, 2))\n  } catch (error) {\n    console.error(`  ‚ùå Failed to create OrderMeal:`, error)\n    throw error\n  }\n}\n\nfunction getMealPriceForPortion(meal: {\n  prices: { single: number; medium?: number; large?: number }\n  portion?: PortionSize\n}): number {\n  const portion = meal.portion || \"single\"\n  if (portion === \"medium\" && meal.prices.medium) return meal.prices.medium\n  if (portion === \"large\" && meal.prices.large) return meal.prices.large\n  return meal.prices.single\n}\n"],"names":[],"mappings":"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"}}]
}