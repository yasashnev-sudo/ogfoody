# Диагностика начисления баллов лояльности

## Проблема
Баллы не начисляются при создании заказа.

## Инструменты для диагностики

### 1. Веб-интерфейс для диагностики
Откройте в браузере: `/debug/loyalty`

Этот интерфейс позволяет:
- Проверить данные пользователя
- Рассчитать баллы для тестового заказа
- Проверить транзакции пользователя
- Протестировать создание транзакции

### 2. API endpoint для диагностики
`GET /api/debug/loyalty-points`

Параметры:
- `userId` (обязательно) - ID пользователя
- `orderTotal` (опционально) - сумма заказа для расчета баллов
- `pointsUsed` (опционально) - использованные баллы (по умолчанию 0)
- `checkTransactions=true` - проверить транзакции пользователя
- `testAward=true` - создать тестовую транзакцию

Примеры:
```
# Проверить пользователя и его транзакции
GET /api/debug/loyalty-points?userId=123&checkTransactions=true

# Рассчитать баллы для заказа
GET /api/debug/loyalty-points?userId=123&orderTotal=1000&pointsUsed=0

# Протестировать начисление (создаст реальную транзакцию)
GET /api/debug/loyalty-points?userId=123&orderTotal=1000&pointsUsed=0&testAward=true
```

## Условия начисления баллов

Баллы начисляются при создании заказа, если выполняются ВСЕ условия:

1. ✅ **Передан userId** - пользователь должен быть авторизован
2. ✅ **Пользователь найден в базе** - userId должен существовать в таблице Users
3. ✅ **Сумма заказа > 0** - orderTotal должен быть больше нуля
4. ✅ **Рассчитано баллов > 0** - после расчета должно получиться больше 0 баллов
5. ✅ **Баллы еще не начислены** - для заказа еще не были начислены баллы
6. ✅ **Таблица транзакций настроена** - переменная окружения `NOCODB_TABLE_LOYALTY_POINTS_TRANSACTIONS` установлена

## Формула расчета баллов

```
amountForPoints = max(0, orderTotal - pointsUsed)
cashbackPercent = 
  - 7% если totalSpent >= 50000 (Gold)
  - 5% если totalSpent >= 20000 (Silver)  
  - 3% если totalSpent < 20000 (Bronze)
earnedPoints = floor(amountForPoints * cashbackPercent / 100)
```

## Что проверить при проблемах

### 1. Проверка конфигурации
```bash
# Проверить переменные окружения
curl http://localhost:3000/api/debug/loyalty-points?userId=1
```

В ответе проверьте секцию `environment`:
- ✅ `NOCODB_URL` - должен быть установлен
- ✅ `NOCODB_TOKEN` - должен быть установлен
- ✅ `NOCODB_TABLE_LOYALTY_POINTS_TRANSACTIONS` - должен быть установлен (значение: `mn244txmccpwmhx`)
- ✅ `NOCODB_TABLE_USERS` - должен быть установлен

### 2. Проверка пользователя
```bash
curl "http://localhost:3000/api/debug/loyalty-points?userId=ВАШ_USER_ID&checkTransactions=true"
```

Проверьте:
- Пользователь найден
- У пользователя есть `loyalty_points` и `total_spent`
- Есть ли транзакции в истории

### 3. Проверка расчета баллов
```bash
curl "http://localhost:3000/api/debug/loyalty-points?userId=ВАШ_USER_ID&orderTotal=1000&pointsUsed=0"
```

Проверьте:
- `calculatedPoints` - должно быть больше 0 для заказа на 1000 руб
- `cashbackPercent` - правильный процент для уровня пользователя
- `amountForPoints` - сумма для расчета (заказ минус использованные баллы)

### 4. Проверка создания транзакции
```bash
curl "http://localhost:3000/api/debug/loyalty-points?userId=ВАШ_USER_ID&orderTotal=1000&pointsUsed=0&testAward=true"
```

Проверьте:
- Транзакция создана успешно (`testAward.success === true`)
- В ответе есть `transaction` с полями `Id`, `user_id`, `points`, etc.

### 5. Проверка при создании реального заказа

После создания заказа проверьте ответ API:
```json
{
  "success": true,
  "orderId": 123,
  "orderNumber": "ORD-...",
  "loyaltyPointsEarned": 30,
  "loyaltyPointsDiagnostics": {
    "userId": 1,
    "pointsAwarded": 30,
    "pointsAwardedReason": "Баллы успешно начислены",
    "orderTotal": 1000,
    "pointsUsed": 0,
    "hasUser": true
  }
}
```

Если `pointsAwardedReason` не "Баллы успешно начислены", проверьте причину.

## Частые проблемы

### Проблема: `pointsAwardedReason: "userId не передан"`
**Решение**: Убедитесь, что пользователь авторизован и `userId` передается в запросе создания заказа.

### Проблема: `pointsAwardedReason: "Рассчитано 0 баллов"`
**Причины**:
- Сумма заказа слишком мала
- Использованы все баллы (orderTotal - pointsUsed <= 0)
- Ошибка в расчете

**Решение**: Проверьте расчет через диагностический endpoint.

### Проблема: Транзакция не создается
**Проверьте**:
1. Переменная окружения `NOCODB_TABLE_LOYALTY_POINTS_TRANSACTIONS` установлена
2. Таблица существует в NocoDB
3. Нет ошибок в логах сервера

### Проблема: Баллы не обновляются у пользователя
**Проверьте**:
1. Функция `updateUser` работает корректно
2. Нет ошибок при обновлении пользователя
3. Проверьте логи сервера на наличие ошибок

## Исправления, которые были сделаны

1. ✅ Добавлена таблица `Loyalty_Points_Transactions` в API proxy (`app/api/db/[...path]/route.ts`)
2. ✅ Добавлена таблица в список разрешенных таблиц
3. ✅ Добавлена таблица в функции `getTableId()` во всех необходимых файлах
4. ✅ Добавлена диагностическая информация в ответ API при создании заказа
5. ✅ Создан диагностический endpoint `/api/debug/loyalty-points`
6. ✅ Создан веб-интерфейс для диагностики `/debug/loyalty`

## Следующие шаги

1. Откройте `/debug/loyalty` в браузере
2. Введите ID пользователя, который создавал заказ
3. Проверьте данные пользователя и транзакции
4. Попробуйте рассчитать баллы для тестового заказа
5. Если расчет работает, но баллы не начисляются при реальном заказе, проверьте логи сервера





