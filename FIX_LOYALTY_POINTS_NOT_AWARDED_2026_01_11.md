# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ

**–î–∞—Ç–∞:** 2026-01-11  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–ª–ª—ã –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞–∫–∞–∑–∞

## –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 1. –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ (403 Forbidden)

**–°–∏–º–ø—Ç–æ–º:**
```
[PATCH /api/orders/485] Order is locked: –ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω
Failed to load resource: the server responded with a status of 403 (Forbidden)
```

**–ü—Ä–∏—á–∏–Ω–∞:**  
–í `handleAutoCheckout` (app/page.tsx) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è **–ø–æ—Å–ª–µ–¥–Ω–∏–π** –∑–∞–∫–∞–∑ –∏–∑ `orders` array –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

```typescript
const lastOrder = orders.length > 0 ? orders[orders.length - 1] : null
const updatedOrder: Order = {
  ...(lastOrder || pendingCheckout.order),  // ‚ùå –ö–æ–ø–∏—Ä–æ–≤–∞–ª –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ —Å id: 485
  // ...
}
```

–ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –±—ã–ª **–æ–ø–ª–∞—á–µ–Ω**, —Å–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–ª–∞—Å—å –µ–≥–æ –æ–±–Ω–æ–≤–∏—Ç—å, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ 403.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å `paid` –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–∫–∞–∑–∞. –ï—Å–ª–∏ –æ–Ω –æ–ø–ª–∞—á–µ–Ω, —Å–æ–∑–¥–∞–µ–º **–Ω–æ–≤—ã–π** –∑–∞–∫–∞–∑:

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û 2026-01-11: –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ù–û–í–´–ô –∑–∞–∫–∞–∑
const shouldCreateNewOrder = !lastOrder || lastOrder.paid

const updatedOrder: Order = {
  ...(shouldCreateNewOrder ? pendingCheckout.order : lastOrder),
  // ...
}

if (shouldCreateNewOrder) {
  delete updatedOrder.id
  delete updatedOrder.paymentMethod
  delete updatedOrder.paid
  delete updatedOrder.paidAt
  console.log("üîß –°–æ–∑–¥–∞–µ–º –ù–û–í–´–ô –∑–∞–∫–∞–∑ (–ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–ø–ª–∞—á–µ–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)")
}
```

### 2. –ë–∞–ª–ª—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∏—Å—å, –Ω–æ –Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

**–°–∏–º–ø—Ç–æ–º:**
```
üí∞ –†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –±–∞–ª–ª–æ–≤: 92
```
–ù–æ –≤ –ª–æ–≥–∞—Ö –ù–ï–¢:
- `‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–æ 92 –±–∞–ª–ª–æ–≤` (–¥–ª—è –æ–Ω–ª–∞–π–Ω)
- `‚è≥ Pending: 92 –±–∞–ª–ª–æ–≤` (–¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö)

**–ü—Ä–∏—á–∏–Ω–∞:**  
–í POST `/api/orders` –±–∞–ª–ª—ã **—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–ª–∏—Å—å** (`actualPointsEarned = 92`), –Ω–æ **–Ω–µ –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å**, –ø–æ—Ç–æ–º—É —á—Ç–æ `paymentMethod` –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:

```typescript
// ‚ùå –°–¢–ê–†–´–ô –ö–û–î
if (actualPointsEarned > 0) {
  if (order.paymentMethod === 'card' || order.paymentMethod === 'sbp') {
    await awardLoyaltyPoints(...)  // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å
  } else if (order.paymentMethod === 'cash') {
    await createPendingLoyaltyPoints(...)  // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å
  }
  
  // ‚ö†Ô∏è –ù–û –í–°–ï –†–ê–í–ù–û –∑–∞–ø–∏—Å—ã–≤–∞–ª–æ—Å—å loyalty_points_earned: 92 –≤ –ë–î!
  await updateOrder(nocoOrder.Id, {
    loyalty_points_earned: actualPointsEarned,
  })
}
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- `loyalty_points_earned: 92` **–∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è –≤ –ë–î**
- –ë–∞–ª–ª—ã **–ù–ï –Ω–∞—á–∏—Å–ª—è–ª–∏—Å—å** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
1. –ï—Å–ª–∏ `paymentMethod` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, **–ù–ï –Ω–∞—á–∏—Å–ª—è–µ–º** –±–∞–ª–ª—ã –∏ **–ù–ï –∑–∞–ø–∏—Å—ã–≤–∞–µ–º** `loyalty_points_earned`:

```typescript
// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û 2026-01-11
if (actualPointsEarned > 0) {
  if (!order.paymentMethod) {
    console.log(`‚ÑπÔ∏è –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω - –±–∞–ª–ª—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ`)
    actualPointsEarned = 0 // –°–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î
  } else if (order.paymentMethod === 'card' || order.paymentMethod === 'sbp') {
    await awardLoyaltyPoints(...)
  } else if (order.paymentMethod === 'cash') {
    await createPendingLoyaltyPoints(...)
  }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –±–∞–ª–ª—ã –±—ã–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã
if (actualPointsEarned > 0) {
  await updateOrder(nocoOrder.Id, {
    loyalty_points_earned: actualPointsEarned,
  })
}
```

2. –ë–∞–ª–ª—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –≤ PATCH –ø—Ä–∏ **–ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç–µ**

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

**–°–∏–º–ø—Ç–æ–º:**
```
‚ö†Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –î–í–û–ô–ù–û–ì–û –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø (partial update): 
   –ë–∞–ª–ª—ã —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ 485: 92. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ.
```

**–ü—Ä–∏—á–∏–Ω–∞:**  
–ò–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã #2, –≤ –ë–î —É–∂–µ –±—ã–ª–æ `loyalty_points_earned: 92`, —Ö–æ—Ç—è –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ù–ï –±—ã–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑, PATCH –≤–∏–¥–µ–ª, —á—Ç–æ –±–∞–ª–ª—ã "—É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω—ã" (–≤ –ø–æ–ª–µ –∑–∞–∫–∞–∑–∞), –∏ –ø—Ä–æ–ø—É—Å–∫–∞–ª –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**  
–° –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã #2, `loyalty_points_earned` —Ç–µ–ø–µ—Ä—å **–ù–ï** –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ë–î –¥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤. PATCH –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—á–∏—Å–ª–∏—Ç –±–∞–ª–ª—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç–µ.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. `app/page.tsx`
- –°—Ç—Ä–æ–∫–∏ ~2345-2370: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `shouldCreateNewOrder = !lastOrder || lastOrder.paid`
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `shouldCreateNewOrder` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–∏ `lastOrder` –∏–ª–∏ `pendingCheckout.order`

### 2. `app/api/orders/route.ts`
- –°—Ç—Ä–æ–∫–∏ ~540-575: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `if (!order.paymentMethod)` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ –±–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
- –°—Ç—Ä–æ–∫–∏ ~576-595: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `loyalty_points_earned` –≤ –ë–î –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –±–∞–ª–ª—ã –±—ã–ª–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã (`actualPointsEarned > 0`)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ –±–µ–∑ paymentMethod
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
1. POST —Å–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ —Å `loyalty_points_earned: null` –∏–ª–∏ `0`
2. PATCH (–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ) –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `loyalty_points_earned`

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
1. –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç, —á—Ç–æ `lastOrder.paid = true`
2. –°–æ–∑–¥–∞–µ—Ç—Å—è **–Ω–æ–≤—ã–π** –∑–∞–∫–∞–∑ (–±–µ–∑ –ø–æ–ø—ã—Ç–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π)
3. –ù–æ–≤–æ–º—É –∑–∞–∫–∞–∑—É –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π ID

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ –∫–∞—Ä—Ç–æ–π/–°–ë–ü
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
1. PATCH –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–ª—ã **—Å—Ä–∞–∑—É** —á–µ—Ä–µ–∑ `awardLoyaltyPoints`
2. –°–æ–∑–¥–∞–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–∏–ø–∞ "earned" —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "completed"
3. `userProfile.loyaltyPoints` –∏ `userProfile.totalSpent` –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
1. PATCH —Å–æ–∑–¥–∞–µ—Ç **pending** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ `createPendingLoyaltyPoints`
2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Ç–∏–ø–∞ "earned" —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "pending"
3. –ë–∞–ª–ª—ã –±—É–¥—É—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã –∫—Ä–æ–Ω-–¥–∂–æ–±–æ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `app/page.tsx` - –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
- `app/api/orders/route.ts` - POST: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
- `app/api/orders/[id]/route.ts` - PATCH: –æ–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞
- `lib/nocodb.ts` - `awardLoyaltyPoints`, `createPendingLoyaltyPoints`

## –ò—Å—Ç–æ—Ä–∏—è
- 2026-01-11: –í—ã—è–≤–ª–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã #1, #2, #3
- –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: `FIX_TOTALSPENT_CASH_FINAL_2026_01_11.md`


